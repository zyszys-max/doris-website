"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([[654220],{15680:(e,t,n)=>{n.d(t,{xA:()=>c,yg:()=>y});var r=n(296540);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=r.createContext({}),u=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},c=function(e){var t=u(e.components);return r.createElement(l.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},g=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=u(n),g=i,y=p["".concat(l,".").concat(g)]||p[g]||d[g]||o;return n?r.createElement(y,a(a({ref:t},c),{},{components:n})):r.createElement(y,a({ref:t},c))}));function y(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,a=new Array(o);a[0]=g;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[p]="string"==typeof e?e:i,a[1]=s;for(var u=2;u<o;u++)a[u]=n[u];return r.createElement.apply(null,a)}return r.createElement.apply(null,n)}g.displayName="MDXCreateElement"},709912:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>u});var r=n(58168),i=(n(296540),n(15680));const o={title:"Solving Unevenly Data Distribution",language:"en"},a=void 0,s={unversionedId:"query-acceleration/tuning/tuning-plan/solving-unevenly-data-distribution",id:"version-3.0/query-acceleration/tuning/tuning-plan/solving-unevenly-data-distribution",title:"Solving Unevenly Data Distribution",description:"\x3c!--",source:"@site/versioned_docs/version-3.0/query-acceleration/tuning/tuning-plan/solving-unevenly-data-distribution.md",sourceDirName:"query-acceleration/tuning/tuning-plan",slug:"/query-acceleration/tuning/tuning-plan/solving-unevenly-data-distribution",permalink:"/docs/3.0/query-acceleration/tuning/tuning-plan/solving-unevenly-data-distribution",draft:!1,tags:[],version:"3.0",frontMatter:{title:"Solving Unevenly Data Distribution",language:"en"},sidebar:"docs",previous:{title:"Accelerating Query with Runtime Filter Tuning",permalink:"/docs/3.0/query-acceleration/tuning/tuning-plan/accelerating-queries-with-runtime-filter"},next:{title:"DML Tuning Plan",permalink:"/docs/3.0/query-acceleration/tuning/tuning-plan/dml-tuning-plan"}},l={},u=[{value:"Tuning Case 1: Bucket Issue",id:"tuning-case-1-bucket-issue",level:2},{value:"Tuning Case 2: Row Estimation Issue",id:"tuning-case-2-row-estimation-issue",level:2}],c={toc:u},p="wrapper";function d(e){let{components:t,...n}=e;return(0,i.yg)(p,(0,r.A)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,i.yg)("p",null,"In the section on using column statistics to optimize plans, we introduced the uniformity assumption employed by the optimizer. However, in real-world scenarios, data often does not satisfy this uniformity assumption. When the optimizer generates an unsatisfactory execution plan due to significant estimation errors, we can manually adjust and optimize the execution plan using hints."),(0,i.yg)("h2",{id:"tuning-case-1-bucket-issue"},"Tuning Case 1: Bucket Issue"),(0,i.yg)("p",null,"When data skew occurs on the bucket key of a table, the workload will be unevenly distributed across different BE instances, thereby prolonging the overall query execution time."),(0,i.yg)("p",null,"Taking the TPC-H schema as an example: Suppose the ",(0,i.yg)("inlineCode",{parentName:"p"},"orders")," table uses ",(0,i.yg)("inlineCode",{parentName:"p"},"o_orderkey")," as the bucket key and has two tablets. For certain reasons, one tablet contains 100 million rows of data, while the other tablet contains only 100 rows."),(0,i.yg)("p",null,"When executing the following query:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-sql"},"SELECT COUNT(*) FROM orders JOIN customer ON o_custkey = c_custkey;\n")),(0,i.yg)("p",null,"The optimizer generates a Broadcast Join, with the ",(0,i.yg)("inlineCode",{parentName:"p"},"orders")," table as the left table and the ",(0,i.yg)("inlineCode",{parentName:"p"},"customer")," table as the right table."),(0,i.yg)("p",null,"The execution engine then launches a thread for each tablet of the ",(0,i.yg)("inlineCode",{parentName:"p"},"orders")," table to perform the join. However, due to uneven data distribution, one thread processes 100 million rows of data, while the other thread processes only 100 rows."),(0,i.yg)("p",null,"Ideally, both threads should each process 50% of the data to double the query efficiency. To address this issue, we can specify the use of a Shuffle Join to redistribute the data from the ",(0,i.yg)("inlineCode",{parentName:"p"},"orders")," table based on ",(0,i.yg)("inlineCode",{parentName:"p"},"o_custkey")," before joining it with the ",(0,i.yg)("inlineCode",{parentName:"p"},"customer")," table."),(0,i.yg)("h2",{id:"tuning-case-2-row-estimation-issue"},"Tuning Case 2: Row Estimation Issue"),(0,i.yg)("p",null,"The optimizer estimates the filter rate based on the uniformity assumption. Significant errors in the estimated number of filtered rows can impact the selection of subsequent SQL operators."),(0,i.yg)("p",null,"When estimating the filter rate, the optimizer typically relies on the assumption of uniform distribution. However, when the error in the estimated number of filtered rows is significant, it can affect the selection of subsequent SQL operators."),(0,i.yg)("p",null,"Considering the following SQL query:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-sql"},"select count() \nfrom orders, customer \nwhere o_custkey = c_custkey and o_orderdate < '1920-01-02'\n")),(0,i.yg)("p",null,"Under the assumption of uniform distribution, the optimizer may assume that the number of rows output after filtering with ",(0,i.yg)("inlineCode",{parentName:"p"},"o_orderdate < '1920-01-02'")," will be less than the number of rows in the ",(0,i.yg)("inlineCode",{parentName:"p"},"customer")," table, and therefore choose to build a hash table based on the ",(0,i.yg)("inlineCode",{parentName:"p"},"orders")," table."),(0,i.yg)("p",null,"However, if the actual data is skewed, resulting in more ",(0,i.yg)("inlineCode",{parentName:"p"},"orders")," satisfying the condition than the number of entries in the ",(0,i.yg)("inlineCode",{parentName:"p"},"customer")," table, a more reasonable choice would be to build the hash table based on the ",(0,i.yg)("inlineCode",{parentName:"p"},"customer")," table."),(0,i.yg)("p",null,"To optimize the query, we need to adjust the SQL statement based on the actual situation or prompt the optimizer to use a more suitable execution plan."),(0,i.yg)("p",null,"Revising the SQL as follows:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-sql"},"select /* leading(orders customer) */ count() \nfrom orders, customer \nwhere o_custkey = c_custkey and o_orderdate < '1920-01-02'\n")))}d.isMDXComponent=!0}}]);