"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([[67621],{15680:(e,r,a)=>{a.d(r,{xA:()=>y,yg:()=>d});var t=a(296540);function n(e,r,a){return r in e?Object.defineProperty(e,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[r]=a,e}function o(e,r){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);r&&(t=t.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),a.push.apply(a,t)}return a}function i(e){for(var r=1;r<arguments.length;r++){var a=null!=arguments[r]?arguments[r]:{};r%2?o(Object(a),!0).forEach((function(r){n(e,r,a[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(a,r))}))}return e}function m(e,r){if(null==e)return{};var a,t,n=function(e,r){if(null==e)return{};var a,t,n={},o=Object.keys(e);for(t=0;t<o.length;t++)a=o[t],r.indexOf(a)>=0||(n[a]=e[a]);return n}(e,r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(t=0;t<o.length;t++)a=o[t],r.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=t.createContext({}),s=function(e){var r=t.useContext(l),a=r;return e&&(a="function"==typeof e?e(r):i(i({},r),e)),a},y=function(e){var r=s(e.components);return t.createElement(l.Provider,{value:r},e.children)},c="mdxType",g={inlineCode:"code",wrapper:function(e){var r=e.children;return t.createElement(t.Fragment,{},r)}},p=t.forwardRef((function(e,r){var a=e.components,n=e.mdxType,o=e.originalType,l=e.parentName,y=m(e,["components","mdxType","originalType","parentName"]),c=s(a),p=n,d=c["".concat(l,".").concat(p)]||c[p]||g[p]||o;return a?t.createElement(d,i(i({ref:r},y),{},{components:a})):t.createElement(d,i({ref:r},y))}));function d(e,r){var a=arguments,n=r&&r.mdxType;if("string"==typeof e||n){var o=a.length,i=new Array(o);i[0]=p;var m={};for(var l in r)hasOwnProperty.call(r,l)&&(m[l]=r[l]);m.originalType=e,m[c]="string"==typeof e?e:n,i[1]=m;for(var s=2;s<o;s++)i[s]=a[s];return t.createElement.apply(null,i)}return t.createElement.apply(null,a)}p.displayName="MDXCreateElement"},74172:(e,r,a)=>{a.r(r),a.d(r,{assets:()=>l,contentTitle:()=>i,default:()=>g,frontMatter:()=>o,metadata:()=>m,toc:()=>s});var t=a(58168),n=(a(296540),a(15680));const o={title:"OOM Killer Crash Analysis",language:"en"},i=void 0,m={unversionedId:"admin-manual/memory-management/memory-analysis/oom-crash-analysis",id:"admin-manual/memory-management/memory-analysis/oom-crash-analysis",title:"OOM Killer Crash Analysis",description:"\x3c!--",source:"@site/docs/admin-manual/memory-management/memory-analysis/oom-crash-analysis.md",sourceDirName:"admin-manual/memory-management/memory-analysis",slug:"/admin-manual/memory-management/memory-analysis/oom-crash-analysis",permalink:"/docs/dev/admin-manual/memory-management/memory-analysis/oom-crash-analysis",draft:!1,tags:[],version:"current",frontMatter:{title:"OOM Killer Crash Analysis",language:"en"},sidebar:"docs",previous:{title:"Query error Memory Tracker Limit Exceeded",permalink:"/docs/dev/admin-manual/memory-management/memory-analysis/query-cancelled-after-query-memory-exceeded"},next:{title:"Memory Log Analysis",permalink:"/docs/dev/admin-manual/memory-management/memory-analysis/memory-log-analysis"}},l={},s=[{value:"Find the memory log before the OOM Killer is triggered",id:"find-the-memory-log-before-the-oom-killer-is-triggered",level:2},{value:"Excessive cluster memory pressure triggers OOM Killer",id:"excessive-cluster-memory-pressure-triggers-oom-killer",level:2},{value:"Some abnormal problems trigger OOM Killer",id:"some-abnormal-problems-trigger-oom-killer",level:2},{value:"Memory Tracker Statistics Missing",id:"memory-tracker-statistics-missing",level:3},{value:"Query Cancel stuck",id:"query-cancel-stuck",level:3},{value:"Jemalloc Metadata has a large memory footprint",id:"jemalloc-metadata-has-a-large-memory-footprint",level:3},{value:"Jemalloc Cache has a large memory footprint",id:"jemalloc-cache-has-a-large-memory-footprint",level:3}],y={toc:s},c="wrapper";function g(e){let{components:r,...a}=e;return(0,n.yg)(c,(0,t.A)({},y,a,{components:r,mdxType:"MDXLayout"}),(0,n.yg)("p",null,"If there is no error message in ",(0,n.yg)("inlineCode",{parentName:"p"},"log/be.out")," after the BE process crashes, execute ",(0,n.yg)("inlineCode",{parentName:"p"},"dmesg -T"),". If you see the following log, it means that the OOM Killer has been triggered. It can be seen that at ",(0,n.yg)("inlineCode",{parentName:"p"},"20240718 15:03:59"),", the physical memory (anon-rss) of the doris_be process with pid 360303 is about 60 GB."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre"},"[Thu Jul 18 15:03:59 2024] Out of memory: Killed process 360303 (doris_be) total-vm:213416916kB, anon-rss:62273128kB, file-rss:0kB, shmem-rss:0kB, UID:0 pgtables:337048kB oom_score_adj:0\n")),(0,n.yg)("p",null,"Ideally, Doris will regularly detect the remaining available memory of the operating system, and take a series of actions including blocking subsequent memory requests and triggering memory GC to avoid triggering OOM Killer when memory is insufficient. However, refreshing memory status and memory GC have a certain lag, and it is difficult to completely catch all large memory requests. When the cluster pressure is too high, there is still a certain probability of triggering OOM Killer, causing the BE process to crash. In addition, if the memory status of the process is abnormal, the memory GC cannot release the memory, resulting in a decrease in the actual available memory of the process, which will increase the memory pressure of the cluster."),(0,n.yg)("p",null,"If the OOM Killer is triggered, first analyze the memory status and task execution of the BE process before the OOM Killer is triggered based on the log, and then adjust the parameters in a targeted manner to restore the cluster to stability."),(0,n.yg)("h2",{id:"find-the-memory-log-before-the-oom-killer-is-triggered"},"Find the memory log before the OOM Killer is triggered"),(0,n.yg)("p",null,"When the OOM Killer is triggered, it means that the process has insufficient available memory. Refer to ",(0,n.yg)("a",{parentName:"p",href:"/docs/dev/admin-manual/memory-management/memory-analysis/memory-log-analysis"},"Memory Log Analysis")," to find the last printed ",(0,n.yg)("inlineCode",{parentName:"p"},"Memory Tracker Summary")," keyword from bottom to top at the time when the OOM Killer is triggered in ",(0,n.yg)("inlineCode",{parentName:"p"},"be/log/be.INFO")," and analyze the main memory location of the BE process."),(0,n.yg)("blockquote",null,(0,n.yg)("p",{parentName:"blockquote"},(0,n.yg)("inlineCode",{parentName:"p"},"less be/log/be.INFO")," After opening the file, first jump to the log corresponding to the time when OOM Killer was triggered. Taking the result of ",(0,n.yg)("inlineCode",{parentName:"p"},"dmesg -T")," above as an example, enter ",(0,n.yg)("inlineCode",{parentName:"p"},"/20240718 15:03:59")," and press Enter to search for the corresponding time. If it cannot be found, it may be that the time when OOM Killer was triggered is somewhat deviated. You can search for ",(0,n.yg)("inlineCode",{parentName:"p"},"/20240718 15:03:"),". After the log jumps to the corresponding time, enter ",(0,n.yg)("inlineCode",{parentName:"p"},"/Memory Tracker Summary")," and press Enter to search for keywords. By default, it will search downward in the log. If it cannot be found or the time does not match, you need to press ",(0,n.yg)("inlineCode",{parentName:"p"},"shift + n")," to search upward first to find the last printed ",(0,n.yg)("inlineCode",{parentName:"p"},"Memory Tracker Summary")," and the ",(0,n.yg)("inlineCode",{parentName:"p"},"Process Memory Summary")," memory logs printed at the same time.")),(0,n.yg)("h2",{id:"excessive-cluster-memory-pressure-triggers-oom-killer"},"Excessive cluster memory pressure triggers OOM Killer"),(0,n.yg)("p",null,"If the following phenomenon is met, it can be considered that the cluster memory pressure is too high, resulting in the process memory status not being refreshed in time at a certain moment, and the memory GC failing to release the memory in time, resulting in the failure to effectively control the BE process memory."),(0,n.yg)("blockquote",null,(0,n.yg)("p",{parentName:"blockquote"},"Before Doris 2.1, Memory GC was not perfect, and when the memory was constantly tight, it was often easier to trigger the OOM Killer.")),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("p",{parentName:"li"},"Analysis of ",(0,n.yg)("inlineCode",{parentName:"p"},"Memory Tracker Summary")," found that the memory usage of queries and other tasks, various caches, metadata, etc. is reasonable.")),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("p",{parentName:"li"},"BE process memory monitoring in the corresponding time period shows that the memory usage rate is maintained at a high level for a long time, and there is no sign of memory leak")),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("p",{parentName:"li"},"Locate the memory log before the OOM Killer time point in ",(0,n.yg)("inlineCode",{parentName:"p"},"be/log/be.INFO"),", search the ",(0,n.yg)("inlineCode",{parentName:"p"},"GC")," keyword from bottom to top, and find that the BE process frequently executes memory GC."))),(0,n.yg)("p",null,"At this time, refer to ",(0,n.yg)("a",{parentName:"p",href:"/docs/dev/admin-manual/config/be-config"},"BE Configuration Items")," to reduce ",(0,n.yg)("inlineCode",{parentName:"p"},"mem_limit")," and increase ",(0,n.yg)("inlineCode",{parentName:"p"},"max_sys_mem_available_low_water_mark_bytes")," in ",(0,n.yg)("inlineCode",{parentName:"p"},"be/conf/be.conf"),". For more information about memory limits, watermark calculation methods, and memory GC, see ",(0,n.yg)("a",{parentName:"p",href:"/docs/dev/admin-manual/memory-management/memory-feature/memory-control-strategy"},"Memory Control Strategy"),"."),(0,n.yg)("p",null,"In addition, other parameters can be adjusted to control memory status refresh and GC, including ",(0,n.yg)("inlineCode",{parentName:"p"},"memory_gc_sleep_time_ms"),", ",(0,n.yg)("inlineCode",{parentName:"p"},"soft_mem_limit_frac"),", ",(0,n.yg)("inlineCode",{parentName:"p"},"memory_maintenance_sleep_time_ms"),", ",(0,n.yg)("inlineCode",{parentName:"p"},"process_minor_gc_size"),", ",(0,n.yg)("inlineCode",{parentName:"p"},"process_full_gc_size"),", ",(0,n.yg)("inlineCode",{parentName:"p"},"enable_query_memory_overcommit"),", ",(0,n.yg)("inlineCode",{parentName:"p"},"thread_wait_gc_max_milliseconds"),", etc."),(0,n.yg)("h2",{id:"some-abnormal-problems-trigger-oom-killer"},"Some abnormal problems trigger OOM Killer"),(0,n.yg)("p",null,"If the cluster memory pressure is too high, the memory status may be abnormal at this time, and the memory GC may not be able to release the memory in time. The following are some common abnormal problems that trigger OOM Killer."),(0,n.yg)("h3",{id:"memory-tracker-statistics-missing"},"Memory Tracker Statistics Missing"),(0,n.yg)("p",null,"If the difference between ",(0,n.yg)("inlineCode",{parentName:"p"},"Label=process resident memory")," Memory Tracker and ",(0,n.yg)("inlineCode",{parentName:"p"},"Label=sum of all trackers")," Memory Tracker in the log ",(0,n.yg)("inlineCode",{parentName:"p"},"Memory Tracker Summary")," is large, or the Orphan Memory Tracker value is too large, it means that there is a statistical missing in the Memory Tracker. Refer to the ","[Memory Tracker Statistics Missing]"," section in ",(0,n.yg)("a",{parentName:"p",href:"/docs/dev/admin-manual/memory-management/memory-feature/memory-tracker"},"Memory Tracker")," for further analysis."),(0,n.yg)("h3",{id:"query-cancel-stuck"},"Query Cancel stuck"),(0,n.yg)("p",null,"Locate the time point of OOM Killer in the ",(0,n.yg)("inlineCode",{parentName:"p"},"be/log/be.INFO")," log, and then search ",(0,n.yg)("inlineCode",{parentName:"p"},"Memory Tracker Summary")," in the context to find the process memory statistics log. If there is a query that uses a large amount of memory in the ",(0,n.yg)("inlineCode",{parentName:"p"},"Memory Tracker Summary"),", execute ",(0,n.yg)("inlineCode",{parentName:"p"},"grep {queryID} be/log/be.INFO")," to confirm whether there is a log with the keyword ",(0,n.yg)("inlineCode",{parentName:"p"},"Cancel"),". The corresponding time point is the time when the query was canceled. If the query has been canceled, and the time point when the query was canceled is a long time away from the time point when the OOM Killer was triggered, refer to the analysis of ","[Query Cancel process stuck]"," in ",(0,n.yg)("a",{parentName:"p",href:"./memory-issue-faq.md"},"Memory Problem FAQ"),". For analysis of ",(0,n.yg)("inlineCode",{parentName:"p"},"Memory Tracker Summary"),", refer to ",(0,n.yg)("a",{parentName:"p",href:"/docs/dev/admin-manual/memory-management/memory-analysis/memory-log-analysis"},"Memory Log Analysis"),"."),(0,n.yg)("h3",{id:"jemalloc-metadata-has-a-large-memory-footprint"},"Jemalloc Metadata has a large memory footprint"),(0,n.yg)("p",null,"Memory GC currently cannot release Jemalloc Metadata. Refer to the analysis of ",(0,n.yg)("inlineCode",{parentName:"p"},"Label=tc/jemalloc_metadata")," Memory Tracker in ",(0,n.yg)("a",{parentName:"p",href:"/docs/dev/admin-manual/memory-management/memory-feature/memory-tracker"},"Memory Tracker")," to reduce memory usage."),(0,n.yg)("h3",{id:"jemalloc-cache-has-a-large-memory-footprint"},"Jemalloc Cache has a large memory footprint"),(0,n.yg)("blockquote",null,(0,n.yg)("p",{parentName:"blockquote"},"Common in Doris 2.0")),(0,n.yg)("p",null,"The default value of ",(0,n.yg)("inlineCode",{parentName:"p"},"lg_tcache_max")," in ",(0,n.yg)("inlineCode",{parentName:"p"},"JEMALLOC_CONF")," in ",(0,n.yg)("inlineCode",{parentName:"p"},"be.conf")," of Doris 2.0 is 20, which will cause the Jemalloc Cache to be too large and unable to be automatically released in some scenarios. Refer to ",(0,n.yg)("a",{parentName:"p",href:"/docs/dev/admin-manual/memory-management/memory-analysis/jemalloc-memory-analysis"},"Jemalloc Memory Analysis")," to reduce the memory footprint of Jemalloc Cache."))}g.isMDXComponent=!0}}]);