"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([[203777],{15680:(e,t,a)=>{a.d(t,{xA:()=>u,yg:()=>d});var i=a(296540);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,i)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,i,n=function(e,t){if(null==e)return{};var a,i,n={},r=Object.keys(e);for(i=0;i<r.length;i++)a=r[i],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)a=r[i],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var o=i.createContext({}),c=function(e){var t=i.useContext(o),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},u=function(e){var t=c(e.components);return i.createElement(o.Provider,{value:t},e.children)},p="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},g=i.forwardRef((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,o=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=c(a),g=n,d=p["".concat(o,".").concat(g)]||p[g]||m[g]||r;return a?i.createElement(d,l(l({ref:t},u),{},{components:a})):i.createElement(d,l({ref:t},u))}));function d(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,l=new Array(r);l[0]=g;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s[p]="string"==typeof e?e:n,l[1]=s;for(var c=2;c<r;c++)l[c]=a[c];return i.createElement.apply(null,l)}return i.createElement.apply(null,a)}g.displayName="MDXCreateElement"},683664:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>o,contentTitle:()=>l,default:()=>m,frontMatter:()=>r,metadata:()=>s,toc:()=>c});var i=a(58168),n=(a(296540),a(15680));const r={title:"Transparent Rewriting with Sync-Materialized View",language:"en"},l=void 0,s={unversionedId:"query-acceleration/tuning/tuning-plan/transparent-rewriting-with-sync-mv",id:"version-2.1/query-acceleration/tuning/tuning-plan/transparent-rewriting-with-sync-mv",title:"Transparent Rewriting with Sync-Materialized View",description:"\x3c!--",source:"@site/versioned_docs/version-2.1/query-acceleration/tuning/tuning-plan/transparent-rewriting-with-sync-mv.md",sourceDirName:"query-acceleration/tuning/tuning-plan",slug:"/query-acceleration/tuning/tuning-plan/transparent-rewriting-with-sync-mv",permalink:"/docs/query-acceleration/tuning/tuning-plan/transparent-rewriting-with-sync-mv",draft:!1,tags:[],version:"2.1",frontMatter:{title:"Transparent Rewriting with Sync-Materialized View",language:"en"},sidebar:"docs",previous:{title:"Optimizing Table Scanning",permalink:"/docs/query-acceleration/tuning/tuning-plan/optimizing-table-scanning"},next:{title:"Transparent Rewriting by Async-Materialized View",permalink:"/docs/query-acceleration/tuning/tuning-plan/transparent-rewriting-with-async-mv"}},o={},c=[{value:"Principle",id:"principle",level:2},{value:"Usage Process",id:"usage-process",level:2},{value:"1 Create a Materialized View",id:"1-create-a-materialized-view",level:3},{value:"2 Automatic Query Matching",id:"2-automatic-query-matching",level:3},{value:"3 Update Strategy",id:"3-update-strategy",level:3},{value:"4 Supported Aggregation Functions",id:"4-supported-aggregation-functions",level:3},{value:"Tuning Usage Case",id:"tuning-usage-case",level:2},{value:"Create a Materialized View",id:"create-a-materialized-view",level:3},{value:"Query Data",id:"query-data",level:3},{value:"Summary",id:"summary",level:2}],u={toc:c},p="wrapper";function m(e){let{components:t,...a}=e;return(0,n.yg)(p,(0,i.A)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,n.yg)("h2",{id:"principle"},"Principle"),(0,n.yg)("p",null,"A sync-materialized view is a special type of table that precomputes and stores data based on a predefined SELECT statement. Its primary purpose is to satisfy users' analytical needs for arbitrary dimensions of raw detailed data while also enabling rapid fixed-dimension analytical queries."),(0,n.yg)("p",null,"Materialized views are suitable for the following scenarios:"),(0,n.yg)("ol",null,(0,n.yg)("li",{parentName:"ol"},(0,n.yg)("p",{parentName:"li"},"Analytical requirements cover both detailed data queries and fixed-dimension queries.")),(0,n.yg)("li",{parentName:"ol"},(0,n.yg)("p",{parentName:"li"},"Queries only involve a small subset of columns or rows in the table.")),(0,n.yg)("li",{parentName:"ol"},(0,n.yg)("p",{parentName:"li"},"Queries contain time-consuming processing operations, such as long aggregation operations.")),(0,n.yg)("li",{parentName:"ol"},(0,n.yg)("p",{parentName:"li"},"Queries require matching different prefix indexes."))),(0,n.yg)("p",null,"For queries that frequently reuse the same subquery results, a sync-materialized view can significantly enhance performance. Doris automatically maintains the data in the materialized view, ensuring data consistency between the base table and the materialized view without additional manual maintenance costs. During queries, the system automatically matches the optimal materialized view and reads data directly from it."),(0,n.yg)("p",null,"When using materialized views, please note the following points:"),(0,n.yg)("ol",null,(0,n.yg)("li",{parentName:"ol"},(0,n.yg)("p",{parentName:"li"},"In Doris version 2.0, materialized views have enhanced features. It is recommended that users confirm in a test environment whether the expected queries can hit the desired materialized views before using them in a formal production environment.")),(0,n.yg)("li",{parentName:"ol"},(0,n.yg)("p",{parentName:"li"},"It is not advisable to create multiple similar materialized views on the same table, as this may lead to conflicts between them, resulting in query misses."))),(0,n.yg)("h2",{id:"usage-process"},"Usage Process"),(0,n.yg)("p",null,"The usage process for materialized views is as follows:"),(0,n.yg)("h3",{id:"1-create-a-materialized-view"},"1 Create a Materialized View"),(0,n.yg)("ol",null,(0,n.yg)("li",{parentName:"ol"},(0,n.yg)("p",{parentName:"li"},"Determine the type of materialized view to create based on the characteristics of the query statement.")),(0,n.yg)("li",{parentName:"ol"},(0,n.yg)("p",{parentName:"li"},"Extract the common grouping and aggregation methods from multiple queries as the basis for defining the materialized view.")),(0,n.yg)("li",{parentName:"ol"},(0,n.yg)("p",{parentName:"li"},"It is not necessary to create materialized views for all dimension combinations; only create them for commonly used dimension combinations.")),(0,n.yg)("li",{parentName:"ol"},(0,n.yg)("p",{parentName:"li"},"Creating a materialized view is an asynchronous operation. After submitting the creation task, Doris will compute the existing data in the background until the creation is successful."))),(0,n.yg)("h3",{id:"2-automatic-query-matching"},"2 Automatic Query Matching"),(0,n.yg)("ol",null,(0,n.yg)("li",{parentName:"ol"},(0,n.yg)("p",{parentName:"li"},"After the materialized view is successfully created, when a user queries the base table, Doris will automatically select an optimal materialized view and read data from it for computation.")),(0,n.yg)("li",{parentName:"ol"},(0,n.yg)("p",{parentName:"li"},"Users can use the EXPLAIN command to check whether the current query is using a materialized view."))),(0,n.yg)("h3",{id:"3-update-strategy"},"3 Update Strategy"),(0,n.yg)("p",null,"To ensure data consistency between the materialized view and the base table, Doris synchronizes operations on the base table to the materialized view, using incremental updates to improve update efficiency and ensuring the atomicity of operations through transactions."),(0,n.yg)("h3",{id:"4-supported-aggregation-functions"},"4 Supported Aggregation Functions"),(0,n.yg)("ol",null,(0,n.yg)("li",{parentName:"ol"},(0,n.yg)("p",{parentName:"li"},"SUM, MIN, MAX (applicable to Version 0.12)")),(0,n.yg)("li",{parentName:"ol"},(0,n.yg)("p",{parentName:"li"},"COUNT, BITMAP_UNION, HLL_UNION (applicable to Version 0.13)")),(0,n.yg)("li",{parentName:"ol"},(0,n.yg)("p",{parentName:"li"},"General aggregation functions (applicable to Version 2.0)"))),(0,n.yg)("h2",{id:"tuning-usage-case"},"Tuning Usage Case"),(0,n.yg)("p",null,"The following is a specific example to illustrate the use of single-table materialized views:"),(0,n.yg)("p",null,"Suppose we have a detailed sales record table ",(0,n.yg)("inlineCode",{parentName:"p"},"sales_records")," that records various information for each transaction, including transaction ID, salesperson ID, store ID, sales date, and transaction amount. Now, we frequently need to perform analytical queries on sales volumes for different stores."),(0,n.yg)("p",null,"To optimize the performance of these queries, we can create a materialized view ",(0,n.yg)("inlineCode",{parentName:"p"},"store_amt")," that groups by store ID and sums the sales amounts for the same store. The specific steps are as follows:"),(0,n.yg)("h3",{id:"create-a-materialized-view"},"Create a Materialized View"),(0,n.yg)("p",null,"First, we use the following SQL statement to create the materialized view ",(0,n.yg)("inlineCode",{parentName:"p"},"store_amt"),":"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sql"},"CREATE MATERIALIZED VIEW store_amt AS \nSELECT store_id, SUM(sale_amt) \nFROM sales_records\nGROUP BY store_id;\n")),(0,n.yg)("p",null,"After submitting the creation task, Doris will asynchronously build this materialized view in the background. We can view the creation progress of the materialized view through the following command:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sql"},"SHOW ALTER TABLE MATERIALIZED VIEW FROM db_name; \n")),(0,n.yg)("p",null,"When the ",(0,n.yg)("inlineCode",{parentName:"p"},"State")," field changes to ",(0,n.yg)("inlineCode",{parentName:"p"},"FINISHED"),", it indicates that the ",(0,n.yg)("inlineCode",{parentName:"p"},"store_amt")," materialized view has been successfully created."),(0,n.yg)("h3",{id:"query-data"},"Query Data"),(0,n.yg)("p",null,"After the materialized view is created, when we query the sales volumes of different stores, Doris will automatically match the ",(0,n.yg)("inlineCode",{parentName:"p"},"store_amt")," materialized view and read the pre-aggregated data directly from it, significantly improving query efficiency."),(0,n.yg)("p",null,"The query statement is as follows:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sql"},"SELECT store_id, SUM(sale_amt) FROM sales_records GROUP BY store_id;\n")),(0,n.yg)("p",null,"We can also use the ",(0,n.yg)("inlineCode",{parentName:"p"},"EXPLAIN")," command to check whether the query successfully hits the materialized view:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sql"},"EXPLAIN SELECT store_id, SUM(sale_amt) FROM sales_records GROUP BY store_id;\n")),(0,n.yg)("p",null,"At the end of the execution plan, if similar content is displayed, it indicates that the query successfully hits the ",(0,n.yg)("inlineCode",{parentName:"p"},"store_amt")," materialized view:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sql"},"TABLE: default_cluster:test.sales_records(store_amt), PREAGGREGATION: ON\n")),(0,n.yg)("p",null,"By following these steps, we can utilize single-table materialized views to optimize query performance and improve the efficiency of data analysis."),(0,n.yg)("h2",{id:"summary"},"Summary"),(0,n.yg)("p",null,"By creating materialized views, we can significantly enhance the query speed for related aggregation analyses. Materialized views not only enable us to perform statistical analyses quickly but also flexibly support the query requirements of detailed data, making them a very powerful feature in Doris."))}m.isMDXComponent=!0}}]);