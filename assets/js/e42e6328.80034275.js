"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([[875668],{15680:(e,n,i)=>{i.d(n,{xA:()=>p,yg:()=>g});var t=i(296540);function r(e,n,i){return n in e?Object.defineProperty(e,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[n]=i,e}function a(e,n){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),i.push.apply(i,t)}return i}function o(e){for(var n=1;n<arguments.length;n++){var i=null!=arguments[n]?arguments[n]:{};n%2?a(Object(i),!0).forEach((function(n){r(e,n,i[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):a(Object(i)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(i,n))}))}return e}function l(e,n){if(null==e)return{};var i,t,r=function(e,n){if(null==e)return{};var i,t,r={},a=Object.keys(e);for(t=0;t<a.length;t++)i=a[t],n.indexOf(i)>=0||(r[i]=e[i]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(t=0;t<a.length;t++)i=a[t],n.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(r[i]=e[i])}return r}var s=t.createContext({}),u=function(e){var n=t.useContext(s),i=n;return e&&(i="function"==typeof e?e(n):o(o({},n),e)),i},p=function(e){var n=u(e.components);return t.createElement(s.Provider,{value:n},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},y=t.forwardRef((function(e,n){var i=e.components,r=e.mdxType,a=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=u(i),y=r,g=c["".concat(s,".").concat(y)]||c[y]||m[y]||a;return i?t.createElement(g,o(o({ref:n},p),{},{components:i})):t.createElement(g,o({ref:n},p))}));function g(e,n){var i=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var a=i.length,o=new Array(a);o[0]=y;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[c]="string"==typeof e?e:r,o[1]=l;for(var u=2;u<a;u++)o[u]=i[u];return t.createElement.apply(null,o)}return t.createElement.apply(null,i)}y.displayName="MDXCreateElement"},820935:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>s,contentTitle:()=>o,default:()=>m,frontMatter:()=>a,metadata:()=>l,toc:()=>u});var t=i(58168),r=(i(296540),i(15680));const a={title:"Query Profile",language:"en"},o=void 0,l={unversionedId:"query-acceleration/tuning/query-profile",id:"version-2.1/query-acceleration/tuning/query-profile",title:"Query Profile",description:"\x3c!--",source:"@site/versioned_docs/version-2.1/query-acceleration/tuning/query-profile.md",sourceDirName:"query-acceleration/tuning",slug:"/query-acceleration/tuning/query-profile",permalink:"/docs/query-acceleration/tuning/query-profile",draft:!1,tags:[],version:"2.1",frontMatter:{title:"Query Profile",language:"en"},sidebar:"docs",previous:{title:"Overview",permalink:"/docs/query-acceleration/tuning/overview"},next:{title:"Optimizing Table Schema Design",permalink:"/docs/query-acceleration/tuning/tuning-plan/optimizing-table-schema"}},s={},u=[{value:"Identifying Slow Queries with QueryID",id:"identifying-slow-queries-with-queryid",level:2},{value:"Analyzing Query Performance using Profile",id:"analyzing-query-performance-using-profile",level:2},{value:"Profile File Structure",id:"profile-file-structure",level:3},{value:"Analyzing BE Execution with Merged Profile",id:"analyzing-be-execution-with-merged-profile",level:3},{value:"Analyzing BE Execution with Execution Profile",id:"analyzing-be-execution-with-execution-profile",level:3},{value:"Analyzing PipelineTask Execution Times",id:"analyzing-pipelinetask-execution-times",level:3},{value:"Troubleshooting Steps for Performance Issues",id:"troubleshooting-steps-for-performance-issues",level:2},{value:"1 Identify Operator Execution Issues",id:"1-identify-operator-execution-issues",level:3},{value:"2 Identify Data Skew Issues",id:"2-identify-data-skew-issues",level:3},{value:"3 Identify High RPC Latency Issues",id:"3-identify-high-rpc-latency-issues",level:3},{value:"4 Identify High Cluster Load Issues",id:"4-identify-high-cluster-load-issues",level:3}],p={toc:u},c="wrapper";function m(e){let{components:n,...i}=e;return(0,r.yg)(c,(0,t.A)({},p,i,{components:n,mdxType:"MDXLayout"}),(0,r.yg)("p",null,"When executing queries in Doris and encountering performance issues, it is recommended to conduct a further analysis. This document provides a comprehensive guide on how to analyze query performance in Doris."),(0,r.yg)("p",null,"In Doris, since profile collection introduces overhead, it is disabled by default. To perform query performance analysis, you first need to enable it by executing the following command in the MySQL Client:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-sql"},"set enable_profile = true;\n")),(0,r.yg)("h2",{id:"identifying-slow-queries-with-queryid"},"Identifying Slow Queries with QueryID"),(0,r.yg)("p",null,"The first step in analyzing query performance is to obtain the QueryID of the query in question. You can find the QueryID in the ",(0,r.yg)("inlineCode",{parentName:"p"},"fe/log/fe.audit.log")," log file."),(0,r.yg)("p",null,"For example, let's consider a specific query from TPC-H. By examining the log information, we can identify the QueryID as ",(0,r.yg)("inlineCode",{parentName:"p"},"QueryId=704185c15570441b-98ad0634c88584f0"),"."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-json"},'2024-08-20 14:37:23,729 [query] IClient=127.0.0.1:33570|User=root|Ctl=internal Db=regression_test_tpch_sf0_1_p1I|State=EOF|ErrorCode=0|ErrorMessage=|Time(ms)=153|ScanBytes=0|ScanRows=0|ReturnRows=1|StmtId=1191|QueryId=704185c15570441b-98ad0634c88584f0|IsQuery=true|isNereids=true|feIp=168.45.0.1|StmtType=SELECT|Stmt=SELECT sum(l_extendedprice) / 7.0 AS avg_yearly FROM lineitem, part WHERE p_partkey = l_partkey AND p_brand_ "Brand#23" AND p_container = "MED BOX" AND l_quantity < ( SELECT 0.2*avg(l_quantity) FROM lineitem WHERE l_partkey= p_partkey) |CpuTimeMS=401ShuffleSendBytes=0|ShuffleSendRows=0|SqlHash=\u0435\u04412e14fac69b9711dc305e218f1e94b8|peakMemoryBytes=33792|SqlDigest=|cloudClusterName=UNKNOWN|TraceId=|WcorkloadGroup=normal|FuzzyVariables=|scanBytesFromLocalStorage=0|scanBytesFromRemoteStorage=0\n')),(0,r.yg)("h2",{id:"analyzing-query-performance-using-profile"},"Analyzing Query Performance using Profile"),(0,r.yg)("p",null,"After obtaining the QueryID, you can retrieve the Profile details by accessing the corresponding FE's WebUI. For example, by visiting the link ",(0,r.yg)("inlineCode",{parentName:"p"},"http://{fe_ip}:{http_port}/QueryProfile/704185c15570441b-98ad0634c88584f0"),", you can view the Profile information. For more detailed information, you can download the ",(0,r.yg)("inlineCode",{parentName:"p"},"profile_704185c15570441b-98ad0634c88584f0.txt")," file."),(0,r.yg)("h3",{id:"profile-file-structure"},"Profile File Structure"),(0,r.yg)("p",null,"The Profile file consists of several main sections:"),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Basic Query Information: Includes ID, timestamp, database, etc.")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"SQL Statement and Execution Plan.")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"FE Time Breakdown (Plan Time, Schedule Time, etc.).")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"BE Operator Execution Times: Breakdown of each Operator's execution time (Merged Profile, Execution Profile, and each PipelineTask within Execution Profile)."))),(0,r.yg)("p",null,"In slow queries, the bottlenecks usually lie in the BE execution process. The following sections will focus on analyzing this part."),(0,r.yg)("h3",{id:"analyzing-be-execution-with-merged-profile"},"Analyzing BE Execution with Merged Profile"),(0,r.yg)("p",null,"Doris provides an aggregated view of Operator performance in the Merged Profile to help users identify performance bottlenecks more accurately."),(0,r.yg)("p",null,"Taking ",(0,r.yg)("inlineCode",{parentName:"p"},"EXCHANGE_OPERATOR")," (id=4) as an example:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-Python"},"EXCHANGE_OPERATOR  (id=4):\n    -  BlocksProduced:  sum  0,  avg  0,  max  0,  min  0\n    -  CloseTime:  avg  34.133us,  max  38.287us,  min  29.979us\n    -  ExecTime:  avg  700.357us,  max  706.351us,  min  694.364us\n    -  InitTime:  avg  648.104us,  max  648.604us,  min  647.605us\n    -  MemoryUsage:  sum  ,  avg  ,  max  ,  min  \n        -  PeakMemoryUsage:  sum  0.00  ,  avg  0.00  ,  max  0.00  ,  min  0.00  \n    -  OpenTime:  avg  4.541us,  max  5.943us,  min  3.139us\n    -  ProjectionTime:  avg  0ns,  max  0ns,  min  0ns\n    -  RowsProduced:  sum  0,  avg  0,  max  0,  min  0\n    -  WaitForDependencyTime:  avg  0ns,  max  0ns,  min  0ns\n        -  WaitForData0:  avg  9.434ms,  max  9.476ms,  min  9.391ms\n")),(0,r.yg)("p",null,"The Merged Profile consolidates core metrics for each Operator:"),(0,r.yg)("table",null,(0,r.yg)("thead",{parentName:"table"},(0,r.yg)("tr",{parentName:"thead"},(0,r.yg)("th",{parentName:"tr",align:null},"Metric Name"),(0,r.yg)("th",{parentName:"tr",align:null},"Description"))),(0,r.yg)("tbody",{parentName:"table"},(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"BlocksProduced"),(0,r.yg)("td",{parentName:"tr",align:null},"Number of Data Blocks produced")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"CloseTime"),(0,r.yg)("td",{parentName:"tr",align:null},"Time taken by the Operator during Close")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"ExecTime"),(0,r.yg)("td",{parentName:"tr",align:null},"Total execution time of the Operator")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"InitTime"),(0,r.yg)("td",{parentName:"tr",align:null},"Time taken by the Operator during Init")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"MemoryUsage"),(0,r.yg)("td",{parentName:"tr",align:null},"Memory usage during Operator execution")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"OpenTime"),(0,r.yg)("td",{parentName:"tr",align:null},"Time taken by the Operator during Open")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"ProjectionTime"),(0,r.yg)("td",{parentName:"tr",align:null},"Time taken during Projection")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"RowsProduced"),(0,r.yg)("td",{parentName:"tr",align:null},"Number of rows returned by the Operator")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"WaitForDependencyTime"),(0,r.yg)("td",{parentName:"tr",align:null},"Time spent waiting for dependencies")))),(0,r.yg)("p",null,"In Doris, each Operator executes concurrently based on user-defined concurrency levels. Therefore, the Merged Profile calculates Max, Avg, and Min values for each metric across all concurrent executions."),(0,r.yg)("p",null,"The ",(0,r.yg)("inlineCode",{parentName:"p"},"WaitForDependencyTime")," metric varies for different Operators depending on their execution dependencies. For example, in the case of EXCHANGE_OPERATOR, it represents the time spent waiting for data from upstream Operators via RPC."),(0,r.yg)("h3",{id:"analyzing-be-execution-with-execution-profile"},"Analyzing BE Execution with Execution Profile"),(0,r.yg)("p",null,"Unlike the Merged Profile, the Execution Profile provides detailed metrics for a specific concurrent execution."),(0,r.yg)("p",null,"Again, taking ",(0,r.yg)("inlineCode",{parentName:"p"},"EXCHANGE_OPERATOR")," (id=4) as an example:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-Python"},"EXCHANGE_OPERATOR  (id=4):(ExecTime:  706.351us)\n      -  BlocksProduced:  0\n      -  CloseTime:  38.287us\n      -  DataArrivalWaitTime:  0ns\n      -  DecompressBytes:  0.00  \n      -  DecompressTime:  0ns\n      -  DeserializeRowBatchTimer:  0ns\n      -  ExecTime:  706.351us\n      -  FirstBatchArrivalWaitTime:  0ns\n      -  InitTime:  647.605us\n      -  LocalBytesReceived:  0.00  \n      -  MemoryUsage:  \n          -  PeakMemoryUsage:  0.00  \n      -  OpenTime:  5.943us\n      -  ProjectionTime:  0ns\n      -  RemoteBytesReceived:  0.00  \n      -  RowsProduced:  0\n      -  SendersBlockedTotalTimer(*):  0ns\n      -  WaitForDependencyTime:  0ns\n          -  WaitForData0:  9.476ms\n")),(0,r.yg)("admonition",{title:"Note",type:"info"},(0,r.yg)("p",{parentName:"admonition"},"In this Profile, ",(0,r.yg)("inlineCode",{parentName:"p"},"LocalBytesReceived")," is unique to the Exchange Operator and not present in other Operators, hence it's not included in the Merged Profile.")),(0,r.yg)("h3",{id:"analyzing-pipelinetask-execution-times"},"Analyzing PipelineTask Execution Times"),(0,r.yg)("p",null,"In Doris, a PipelineTask consists of multiple Operators. When analyzing the execution time of a PipelineTask, focus on the following aspects:"),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"ExecuteTime: Represents the actual execution time of the entire PipelineTask, roughly equal to the sum of ExecTime for all Operators within the Task.")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"WaitWorkerTime: Represents the time the Task waits for an available Worker to execute. When a task is in the ",(0,r.yg)("inlineCode",{parentName:"p"},"runnable")," state, it waits for an idle worker to execute, which depends on cluster load.")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Wait Time for Dependencies: A Task can execute when all its Operators' dependencies are met. The wait time for dependencies is the sum of these wait times."))),(0,r.yg)("p",null,"Taking one of the tasks from the previous example:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-Python"},"PipelineTask  (index=1):(ExecTime:  4.773ms)\n  -  ExecuteTime:  1.656ms\n      -  CloseTime:  90.402us\n      -  GetBlockTime:  11.235us\n      -  OpenTime:  1.448ms\n      -  PrepareTime:  1.555ms\n      -  SinkTime:  14.228us\n  -  WaitWorkerTime:  63.868us\n    DATA_STREAM_SINK_OPERATOR  (id=8,dst_id=8):(ExecTime:  1.688ms)\n      -  WaitForDependencyTime:  0ns\n          -  WaitForBroadcastBuffer:  0ns\n          -  WaitForRpcBufferQueue:  0ns\n    AGGREGATION_OPERATOR  (id=7  ,  nereids_id=648):(ExecTime:  398.12us)\n      -  WaitForDependency[AGGREGATION_OPERATOR_DEPENDENCY]Time:  10.495ms\n")),(0,r.yg)("p",null,"This task includes ",(0,r.yg)("inlineCode",{parentName:"p"},"DATA_STREAM_SINK_OPERATOR")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"AGGREGATION_OPERATOR"),". Among them:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"p"},"DATA_STREAM_SINK_OPERATOR")," has two dependencies: ",(0,r.yg)("inlineCode",{parentName:"p"},"WaitForBroadcastBuffer")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"WaitForRpcBufferQueue"),".")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"p"},"AGGREGATION_OPERATOR")," has one dependency: ",(0,r.yg)("inlineCode",{parentName:"p"},"AGGREGATION_OPERATOR_DEPENDENCY"),"."))),(0,r.yg)("p",null,"The time distribution for this task is:"),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"ExecuteTime: 1.656ms (approximately the sum of ExecTime for both Operators)")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"WaitWorkerTime: 63.868us (indicating low cluster load as the Task executed immediately after becoming runnable)")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Wait Time for Dependencies: 10.495ms (sum of wait times for all dependencies, including ",(0,r.yg)("inlineCode",{parentName:"p"},"WaitForBroadcastBuffer"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"WaitForRpcBufferQueue"),", and ",(0,r.yg)("inlineCode",{parentName:"p"},"WaitForDependency[AGGREGATION_OPERATOR_DEPENDENCY]"),")"))),(0,r.yg)("h2",{id:"troubleshooting-steps-for-performance-issues"},"Troubleshooting Steps for Performance Issues"),(0,r.yg)("p",null,"When troubleshooting performance issues in Doris, follow these four steps:"),(0,r.yg)("h3",{id:"1-identify-operator-execution-issues"},"1 Identify Operator Execution Issues"),(0,r.yg)("p",null,"Slow Operator execution is a common issue in production environments. To locate these issues, analyze the ",(0,r.yg)("inlineCode",{parentName:"p"},"ExecTime")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"WaitForDependencyTime")," for each Operator in the Merged Profile's Plan Tree."),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"If ",(0,r.yg)("inlineCode",{parentName:"p"},"ExecTime")," is high, it indicates an Operator performance issue, which could stem from the Operator's inherent performance or an unoptimized execution plan.")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"If ",(0,r.yg)("inlineCode",{parentName:"p"},"ExecTime")," is low but ",(0,r.yg)("inlineCode",{parentName:"p"},"WaitForDependencyTime")," is high, the bottleneck likely lies upstream and requires further investigation along the Plan Tree."))),(0,r.yg)("h3",{id:"2-identify-data-skew-issues"},"2 Identify Data Skew Issues"),(0,r.yg)("p",null,"When troubleshooting Operator performance, observe significant differences between minimum and maximum ",(0,r.yg)("inlineCode",{parentName:"p"},"ExecTime")," values for an Operator. If present, check if there are also significant differences in the amount of data processed (",(0,r.yg)("inlineCode",{parentName:"p"},"RowsProduced"),"). If so, this indicates data skew."),(0,r.yg)("h3",{id:"3-identify-high-rpc-latency-issues"},"3 Identify High RPC Latency Issues"),(0,r.yg)("p",null,"If no slow Operators are identified after traversing the entire Plan Tree, investigate RPC latency issues. Examine each ",(0,r.yg)("inlineCode",{parentName:"p"},"DATA_STREAM_SINK_OPERATOR")," in the Execution Profile and check for abnormal ",(0,r.yg)("inlineCode",{parentName:"p"},"RpcMaxTime")," values. High RPC latency may indicate network issues."),(0,r.yg)("h3",{id:"4-identify-high-cluster-load-issues"},"4 Identify High Cluster Load Issues"),(0,r.yg)("p",null,"Doris's execution engine has a fixed number of execution threads. High cluster load can lead to tasks waiting for available workers. Analyze ",(0,r.yg)("inlineCode",{parentName:"p"},"WaitWorkerTime")," for each PipelineTask in the Execution Profile to assess cluster load."))}m.isMDXComponent=!0}}]);