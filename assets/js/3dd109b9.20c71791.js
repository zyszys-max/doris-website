"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([[577933],{15680:(e,a,n)=>{n.d(a,{xA:()=>c,yg:()=>g});var i=n(296540);function t(e,a,n){return a in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}function r(e,a){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);a&&(i=i.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),n.push.apply(n,i)}return n}function l(e){for(var a=1;a<arguments.length;a++){var n=null!=arguments[a]?arguments[a]:{};a%2?r(Object(n),!0).forEach((function(a){t(e,a,n[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(n,a))}))}return e}function s(e,a){if(null==e)return{};var n,i,t=function(e,a){if(null==e)return{};var n,i,t={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],a.indexOf(n)>=0||(t[n]=e[n]);return t}(e,a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],a.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(t[n]=e[n])}return t}var o=i.createContext({}),d=function(e){var a=i.useContext(o),n=a;return e&&(n="function"==typeof e?e(a):l(l({},a),e)),n},c=function(e){var a=d(e.components);return i.createElement(o.Provider,{value:a},e.children)},u="mdxType",p={inlineCode:"code",wrapper:function(e){var a=e.children;return i.createElement(i.Fragment,{},a)}},m=i.forwardRef((function(e,a){var n=e.components,t=e.mdxType,r=e.originalType,o=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=d(n),m=t,g=u["".concat(o,".").concat(m)]||u[m]||p[m]||r;return n?i.createElement(g,l(l({ref:a},c),{},{components:n})):i.createElement(g,l({ref:a},c))}));function g(e,a){var n=arguments,t=a&&a.mdxType;if("string"==typeof e||t){var r=n.length,l=new Array(r);l[0]=m;var s={};for(var o in a)hasOwnProperty.call(a,o)&&(s[o]=a[o]);s.originalType=e,s[u]="string"==typeof e?e:t,l[1]=s;for(var d=2;d<r;d++)l[d]=n[d];return i.createElement.apply(null,l)}return i.createElement.apply(null,n)}m.displayName="MDXCreateElement"},951848:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>o,contentTitle:()=>l,default:()=>p,frontMatter:()=>r,metadata:()=>s,toc:()=>d});var i=n(58168),t=(n(296540),n(15680));const r={title:"Sync-Materialized View",language:"en"},l=void 0,s={unversionedId:"query-acceleration/materialized-view/sync-materialized-view",id:"version-2.1/query-acceleration/materialized-view/sync-materialized-view",title:"Sync-Materialized View",description:"\x3c!--",source:"@site/versioned_docs/version-2.1/query-acceleration/materialized-view/sync-materialized-view.md",sourceDirName:"query-acceleration/materialized-view",slug:"/query-acceleration/materialized-view/sync-materialized-view",permalink:"/docs/query-acceleration/materialized-view/sync-materialized-view",draft:!1,tags:[],version:"2.1",frontMatter:{title:"Sync-Materialized View",language:"en"},sidebar:"docs",previous:{title:"Materialized View Overview",permalink:"/docs/query-acceleration/materialized-view/overview"},next:{title:"Overview",permalink:"/docs/query-acceleration/materialized-view/async-materialized-view/overview"}},o={},d=[{value:"What is a Synchronous Materialized View",id:"what-is-a-synchronous-materialized-view",level:2},{value:"Applicable Scenarios",id:"applicable-scenarios",level:2},{value:"Limitations",id:"limitations",level:2},{value:"Using Materialized Views",id:"using-materialized-views",level:2},{value:"Creating a Materialized View",id:"creating-a-materialized-view",level:3},{value:"Checking if the Materialized View is Created",id:"checking-if-the-materialized-view-is-created",level:3},{value:"Canceling Materialized View Creation",id:"canceling-materialized-view-creation",level:3},{value:"Viewing the Materialized View Structure",id:"viewing-the-materialized-view-structure",level:3},{value:"Viewing the Creation Statement of a Materialized View",id:"viewing-the-creation-statement-of-a-materialized-view",level:3},{value:"Querying a Materialized View",id:"querying-a-materialized-view",level:3},{value:"Dropping a Materialized View",id:"dropping-a-materialized-view",level:3},{value:"Usage Examples",id:"usage-examples",level:2},{value:"Example 1: Accelerating Aggregation Queries",id:"example-1-accelerating-aggregation-queries",level:3},{value:"Example 2: Matching Different Prefix Indexes",id:"example-2-matching-different-prefix-indexes",level:3},{value:"Example 3: Pre-filtering and Expression Computation to Accelerate Queries",id:"example-3-pre-filtering-and-expression-computation-to-accelerate-queries",level:3},{value:"FAQ",id:"faq",level:2}],c={toc:d},u="wrapper";function p(e){let{components:a,...n}=e;return(0,t.yg)(u,(0,i.A)({},c,n,{components:a,mdxType:"MDXLayout"}),(0,t.yg)("h2",{id:"what-is-a-synchronous-materialized-view"},"What is a Synchronous Materialized View"),(0,t.yg)("p",null,"A synchronous materialized view is a special type of table in Doris that stores pre-computed data sets based on defined SELECT statements. Doris automatically maintains the data in synchronous materialized views, ensuring that any new imports or deletions in the base table are reflected in the materialized view in real-time, maintaining data consistency without requiring any additional manual maintenance. When querying, Doris automatically selects the optimal materialized view and retrieves data directly from it."),(0,t.yg)("h2",{id:"applicable-scenarios"},"Applicable Scenarios"),(0,t.yg)("ul",null,(0,t.yg)("li",{parentName:"ul"},(0,t.yg)("p",{parentName:"li"},"Accelerating time-consuming aggregation operations")),(0,t.yg)("li",{parentName:"ul"},(0,t.yg)("p",{parentName:"li"},"Queries requiring prefix index matching")),(0,t.yg)("li",{parentName:"ul"},(0,t.yg)("p",{parentName:"li"},"Reducing the amount of data scanned by pre-filtering")),(0,t.yg)("li",{parentName:"ul"},(0,t.yg)("p",{parentName:"li"},"Speeding up queries by pre-computing complex expressions"))),(0,t.yg)("h2",{id:"limitations"},"Limitations"),(0,t.yg)("ul",null,(0,t.yg)("li",{parentName:"ul"},(0,t.yg)("p",{parentName:"li"},"Synchronous materialized views only support SELECT statements for a single table, including WHERE, GROUP BY, and ORDER BY clauses, but not JOIN, HAVING, LIMIT clauses, LATERAL VIEW.")),(0,t.yg)("li",{parentName:"ul"},(0,t.yg)("p",{parentName:"li"},"Unlike asynchronous materialized views, synchronous materialized views cannot be queried directly.")),(0,t.yg)("li",{parentName:"ul"},(0,t.yg)("p",{parentName:"li"},"The SELECT list cannot include auto-increment columns, constants, duplicate expressions, or window functions.")),(0,t.yg)("li",{parentName:"ul"},(0,t.yg)("p",{parentName:"li"},"If the SELECT list contains aggregation functions, these must be root expressions (e.g., ",(0,t.yg)("inlineCode",{parentName:"p"},"sum(a + 1)")," is supported, but ",(0,t.yg)("inlineCode",{parentName:"p"},"sum(a) + 1")," is not), and no non-aggregation function expressions can follow the aggregation function (e.g., ",(0,t.yg)("inlineCode",{parentName:"p"},"SELECT x, sum(a)")," is allowed, but ",(0,t.yg)("inlineCode",{parentName:"p"},"SELECT sum(a), x")," is not).")),(0,t.yg)("li",{parentName:"ul"},(0,t.yg)("p",{parentName:"li"},"If the condition column for a DELETE statement exists in the materialized view, the DELETE operation cannot proceed. If data deletion is necessary, the materialized view must be dropped first.")),(0,t.yg)("li",{parentName:"ul"},(0,t.yg)("p",{parentName:"li"},"Excessive materialized views on a single table can impact import efficiency: When importing data, both the materialized views and the base table are updated synchronously. Excessive materialized views on a table can slow down imports, similar to importing data into multiple tables simultaneously.")),(0,t.yg)("li",{parentName:"ul"},(0,t.yg)("p",{parentName:"li"},"Materialized views on Unique Key data models can only reorder columns and do not support aggregation. Therefore, coarse-grained aggregation operations cannot be performed through materialized views on Unique Key models."))),(0,t.yg)("h2",{id:"using-materialized-views"},"Using Materialized Views"),(0,t.yg)("p",null,"Doris provides a comprehensive set of DDL syntax for materialized views, including creation, viewing, and deletion. Below is an example demonstrating how to use materialized views to accelerate aggregation calculations. Suppose a user has a sales record detail table that stores transaction IDs, salespersons, stores, sale dates, and amounts. The table creation and data insertion statements are as follows:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},'-- Create a test_db  \ncreate database test_db;  \nuse test_db;  \n  \n-- Create table  \ncreate table sales_records  \n(  \n    record_id int,   \n    seller_id int,   \n    store_id int,   \n    sale_date date,   \n    sale_amt bigint  \n)   \ndistributed by hash(record_id)   \nproperties("replication_num" = "1");  \n  \n-- Insert data  \ninsert into sales_records values(1,1,1,\'2020-02-02\',1);\n')),(0,t.yg)("h3",{id:"creating-a-materialized-view"},"Creating a Materialized View"),(0,t.yg)("p",null,"If users frequently need to analyze sales volumes by different stores, they can create a materialized view for the ",(0,t.yg)("inlineCode",{parentName:"p"},"sales_records")," table, grouped by store ID and summing sales amounts for each store. The creation statement is as follows:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"create materialized view store_amt as   \nselect store_id, sum(sale_amt) from sales_records group by store_id;\n")),(0,t.yg)("h3",{id:"checking-if-the-materialized-view-is-created"},"Checking if the Materialized View is Created"),(0,t.yg)("p",null,"Since creating a materialized view is an asynchronous operation, users need to check the status of the materialized view creation task asynchronously after submitting it. The command is as follows:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"show alter table materialized view from test_db;\n")),(0,t.yg)("p",null,"The output will show all materialized view creation tasks for that database. A sample output is:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"+--------+---------------+---------------------+---------------------+---------------+-----------------+----------+---------------+----------+------+----------+---------+  \n| JobId  | TableName     | CreateTime          | FinishTime          | BaseIndexName | RollupIndexName | RollupId | TransactionId | State    | Msg  | Progress | Timeout |  \n+--------+---------------+---------------------+---------------------+---------------+-----------------+----------+---------------+----------+------+----------+---------+  \n| 494349 | sales_records | 2020-07-30 20:04:56 | 2020-07-30 20:04:57 | sales_records | store_amt       | 494350   | 133107        | FINISHED |      | NULL     | 2592000 |  \n+--------+---------------+---------------------+---------------------+---------------+-----------------+----------+---------------+----------+------+----------+---------+\n")),(0,t.yg)("p",null,"The ",(0,t.yg)("inlineCode",{parentName:"p"},"State")," column indicates the status. When the state changes to ",(0,t.yg)("inlineCode",{parentName:"p"},"FINISHED"),", the materialized view is successfully created."),(0,t.yg)("h3",{id:"canceling-materialized-view-creation"},"Canceling Materialized View Creation"),(0,t.yg)("p",null,"If the background asynchronous task for creating the materialized view has not yet completed, it can be canceled with the following command:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"cancel alter table materialized view from test_db.sales_records;\n")),(0,t.yg)("p",null,"If the materialized view has already been created, it cannot be canceled, but it can be deleted using the DROP command."),(0,t.yg)("h3",{id:"viewing-the-materialized-view-structure"},"Viewing the Materialized View Structure"),(0,t.yg)("p",null,"The structure of all materialized views created on a target table can be viewed using the following command:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"desc sales_records all;\n")),(0,t.yg)("h3",{id:"viewing-the-creation-statement-of-a-materialized-view"},"Viewing the Creation Statement of a Materialized View"),(0,t.yg)("p",null,"The creation statement for a materialized view can be viewed with the following command:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"show create materialized view store_amt on sales_records;\n")),(0,t.yg)("h3",{id:"querying-a-materialized-view"},"Querying a Materialized View"),(0,t.yg)("p",null,"Once a materialized view is created, Doris automatically retrieves pre-aggregated data from the materialized view when querying by store ID, improving query efficiency. Users can still query the ",(0,t.yg)("inlineCode",{parentName:"p"},"sales_records")," table, e.g.,:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"select store_id, sum(sale_amt) from sales_records group by store_id;\n")),(0,t.yg)("p",null,"This query will automatically match the ",(0,t.yg)("inlineCode",{parentName:"p"},"store_amt")," materialized view. Users can verify this with the ",(0,t.yg)("inlineCode",{parentName:"p"},"explain")," command:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"explain select store_id, sum(sale_amt) from sales_records group by store_id;\n")),(0,t.yg)("h3",{id:"dropping-a-materialized-view"},"Dropping a Materialized View"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"drop materialized view store_amt on sales_records;\n")),(0,t.yg)("h2",{id:"usage-examples"},"Usage Examples"),(0,t.yg)("p",null,"Below are additional examples demonstrating the use of materialized views."),(0,t.yg)("h3",{id:"example-1-accelerating-aggregation-queries"},"Example 1: Accelerating Aggregation Queries"),(0,t.yg)("p",null,"Business Scenario: Calculating ad UV (Unique Visitors) and PV (Page Views)."),(0,t.yg)("p",null,"Assuming the raw ad click data is stored in Doris, creating a materialized view with ",(0,t.yg)("inlineCode",{parentName:"p"},"bitmap_union")," can speed up queries for ad PV and UV. First, create a table to store ad click details:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},'create table advertiser_view_record  \n(  \n    click_time datetime,   \n    advertiser varchar(10),   \n    channel varchar(10),   \n    user_id int  \n) distributed by hash(user_id) properties("replication_num" = "1");  \ninsert into advertiser_view_record values("2020-02-02 02:02:02",\'a\',\'a\',1);\n')),(0,t.yg)("p",null,"Since users want to query the UV value of advertisements, which requires an exact deduplication of users for the same advertisement, the typical query would be:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"create materialized view advertiser_uv as   \nselect   \n    advertiser,   \n    channel,   \n    bitmap_union(to_bitmap(user_id))   \nfrom   \n    advertiser_view_record   \ngroup by   \n    advertiser, channel;\n")),(0,t.yg)("p",null,"For this UV calculation scenario, we can create a materialized view with ",(0,t.yg)("inlineCode",{parentName:"p"},"bitmap_union")," to achieve pre-exact deduplication. In Doris, the result of the ",(0,t.yg)("inlineCode",{parentName:"p"},"count(distinct)")," aggregation is identical to the result of the ",(0,t.yg)("inlineCode",{parentName:"p"},"bitmap_union_count")," aggregation. And ",(0,t.yg)("inlineCode",{parentName:"p"},"bitmap_union_count")," is equivalent to counting the results of ",(0,t.yg)("inlineCode",{parentName:"p"},"bitmap_union"),". Therefore, if the query involves ",(0,t.yg)("inlineCode",{parentName:"p"},"count(distinct)"),", creating a materialized view with ",(0,t.yg)("inlineCode",{parentName:"p"},"bitmap_union")," aggregation can speed up the query. Based on current usage scenarios, a materialized view can be created to group by advertisement and channel, with exact deduplication for ",(0,t.yg)("inlineCode",{parentName:"p"},"user_id"),"."),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"create materialized view advertiser_uv as \nselect \n    advertiser, \n    channel, \n    bitmap_union(to_bitmap(user_id)) \nfrom \n    advertiser_view_record \ngroup by \n    advertiser, channel;\n")),(0,t.yg)("p",null,"Once the materialized view table is created, when querying the UV for advertisements, Doris will automatically retrieve data from the newly created materialized view ",(0,t.yg)("inlineCode",{parentName:"p"},"advertiser_uv"),". If the previous SQL is executed:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"select \n    advertiser, \n    channel, \n    count(distinct user_id) \nfrom \n    advertiser_view_record \ngroup by \n    advertiser, channel;\n")),(0,t.yg)("p",null,"After selecting the materialized view, the actual query will be transformed into:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"select \n    advertiser, \n    channel, \n    bitmap_union_count(to_bitmap(user_id)) \nfrom \n    advertiser_uv \ngroup by \n    advertiser, channel;\n")),(0,t.yg)("p",null,"Use the ",(0,t.yg)("inlineCode",{parentName:"p"},"explain")," command to check if the query matches the materialized view:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"explain select \n    advertiser, \n    channel, \n    count(distinct user_id) \nfrom \n    advertiser_view_record \ngroup by \n    advertiser, channel;\n")),(0,t.yg)("p",null,"The output will be:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"+-------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Explain String(Nereids Planner)                                                                                                                       |\n+-------------------------------------------------------------------------------------------------------------------------------------------------------+\n| PLAN FRAGMENT 0                                                                                                                                       |\n|   OUTPUT EXPRS:                                                                                                                                       |\n|     advertiser[#13]                                                                                                                                   |\n|     channel[#14]                                                                                                                                      |\n|     count(DISTINCT user_id)[#15]                                                                                                                      |\n|   PARTITION: HASH_PARTITIONED: mv_advertiser[#7], mv_channel[#8]                                                                                      |\n|                                                                                                                                                       |\n|   HAS_COLO_PLAN_NODE: false                                                                                                                           |\n|                                                                                                                                                       |\n|   VRESULT SINK                                                                                                                                        |\n|      MYSQL_PROTOCAL                                                                                                                                   |\n|                                                                                                                                                       |\n|   3:VAGGREGATE (merge finalize)(145)                                                                                                                  |\n|   |  output: bitmap_union_count(partial_bitmap_union_count(mva_BITMAP_UNION__to_bitmap_with_check(cast(user_id as BIGINT)))[#9])[#12]                 |\n|   |  group by: mv_advertiser[#7], mv_channel[#8]                                                                                                      |\n|   |  sortByGroupKey:false                                                                                                                             |\n|   |  cardinality=1                                                                                                                                    |\n|   |  final projections: mv_advertiser[#10], mv_channel[#11], bitmap_union_count(mva_BITMAP_UNION__to_bitmap_with_check(cast(user_id as BIGINT)))[#12] |\n|   |  final project output tuple id: 4                                                                                                                 |\n|   |  distribute expr lists: mv_advertiser[#7], mv_channel[#8]                                                                                         |\n|   |                                                                                                                                                   |\n|   2:VEXCHANGE                                                                                                                                         |\n|      offset: 0                                                                                                                                        |\n|      distribute expr lists:                                                                                                                           |\n|                                                                                                                                                       |\n| PLAN FRAGMENT 1                                                                                                                                       |\n|                                                                                                                                                       |\n|   PARTITION: HASH_PARTITIONED: user_id[#6]                                                                                                            |\n|                                                                                                                                                       |\n|   HAS_COLO_PLAN_NODE: false                                                                                                                           |\n|                                                                                                                                                       |\n|   STREAM DATA SINK                                                                                                                                    |\n|     EXCHANGE ID: 02                                                                                                                                   |\n|     HASH_PARTITIONED: mv_advertiser[#7], mv_channel[#8]                                                                                               |\n|                                                                                                                                                       |\n|   1:VAGGREGATE (update serialize)(139)                                                                                                                |\n|   |  STREAMING                                                                                                                                        |\n|   |  output: partial_bitmap_union_count(mva_BITMAP_UNION__to_bitmap_with_check(cast(user_id as BIGINT))[#2])[#9]                                      |\n|   |  group by: mv_advertiser[#0], mv_channel[#1]                                                                                                      |\n|   |  sortByGroupKey:false                                                                                                                             |\n|   |  cardinality=1                                                                                                                                    |\n|   |  distribute expr lists:                                                                                                                           |\n|   |                                                                                                                                                   |\n|   0:VOlapScanNode(136)                                                                                                                                |\n|      TABLE: test_db.advertiser_view_record(advertiser_uv), PREAGGREGATION: ON                                            |\n|      partitions=1/1 (advertiser_view_record)                                                                                                          |\n|      tablets=10/10, tabletList=494552,494554,494556 ...                                                                                               |\n|      cardinality=1, avgRowSize=0.0, numNodes=1                                                                                                        |\n|      pushAggOp=NONE                                                                                                                                   |\n|                                                                                                                                                       |\n|                                                                                                                                                       |\n| Statistics                                                                                                                                            |\n|  planed with unknown column statistics                                                                                                                |\n+-------------------------------------------------------------------------------------------------------------------------------------------------------+\n")),(0,t.yg)("p",null,"In the result of the explain command, you can see ",(0,t.yg)("inlineCode",{parentName:"p"},"advertiser_view_record(advertiser_uv)")," under the ",(0,t.yg)("inlineCode",{parentName:"p"},"VOlapScanNode"),". This indicates that the query will directly scan the data from the materialized view, confirming a successful match. Additionally, the ",(0,t.yg)("inlineCode",{parentName:"p"},"count(distinct)")," operation on the ",(0,t.yg)("inlineCode",{parentName:"p"},"user_id")," field has been rewritten as ",(0,t.yg)("inlineCode",{parentName:"p"},"bitmap_union_count(to_bitmap)"),", which achieves precise deduplication through the use of Bitmap."),(0,t.yg)("h3",{id:"example-2-matching-different-prefix-indexes"},"Example 2: Matching Different Prefix Indexes"),(0,t.yg)("p",null,"Business Scenario: Matching prefix indexes."),(0,t.yg)("p",null,"If a table has prefix indexes on k1 and k2, but queries sometimes involve k3, a materialized view can be created with k3 as the first column to leverage indexing:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},'create table test_table  \n(  \n    k1 int,   \n    k2 int,   \n    k3 int,   \n    kx date  \n)   \ndistributed by hash(k1)   \nproperties("replication_num" = "1");  \n  \ninsert into test_table values(1,1,1,1);  \n')),(0,t.yg)("p",null,"Create a materialized view with k3 as the prefix index:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"create materialized view mv_1 as SELECT k3, k2, k1 FROM test_table;\n")),(0,t.yg)("p",null,"Queries with ",(0,t.yg)("inlineCode",{parentName:"p"},"WHERE k3 = 3")," will match the materialized view, as verified by ",(0,t.yg)("inlineCode",{parentName:"p"},"explain"),"."),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"explain select k1, k2, k3 from test_table where k3=3;\n")),(0,t.yg)("p",null,"The output will be:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"+----------------------------------------------------------+\n| Explain String(Nereids Planner)                          |\n+----------------------------------------------------------+\n| PLAN FRAGMENT 0                                          |\n|   OUTPUT EXPRS:                                          |\n|     k1[#7]                                               |\n|     k2[#8]                                               |\n|     k3[#9]                                               |\n|   PARTITION: HASH_PARTITIONED: mv_k1[#2]                 |\n|                                                          |\n|   HAS_COLO_PLAN_NODE: false                              |\n|                                                          |\n|   VRESULT SINK                                           |\n|      MYSQL_PROTOCAL                                      |\n|                                                          |\n|   0:VOlapScanNode(256)                                   |\n|      TABLE: test_db.test_table(mv_1), PREAGGREGATION: ON |\n|      PREDICATES: (mv_k3[#0] = 3)                         |\n|      partitions=1/1 (test_table)                         |\n|      tablets=10/10, tabletList=271177,271179,271181 ...  |\n|      cardinality=1, avgRowSize=0.0, numNodes=1           |\n|      pushAggOp=NONE                                      |\n|      final projections: mv_k1[#2], mv_k2[#1], mv_k3[#0]  |\n|      final project output tuple id: 2                    |\n|                                                          |\n|                                                          |\n| ========== MATERIALIZATIONS ==========                   |\n|                                                          |\n| MaterializedView                                         |\n| MaterializedViewRewriteSuccessAndChose:                  |\n|   internal.test_db.test_table.mv_1 chose,                |\n|                                                          |\n| MaterializedViewRewriteSuccessButNotChose:               |\n|   not chose: none,                                       |\n|                                                          |\n| MaterializedViewRewriteFail:                             |\n|                                                          |\n|                                                          |\n| ========== STATISTICS ==========                         |\n| planed with unknown column statistics                    |\n+----------------------------------------------------------+\n")),(0,t.yg)("p",null,"In the result of the explain command, you can see that ",(0,t.yg)("inlineCode",{parentName:"p"},"VOlapScanNode\u7684test_table(mv_1)"),", indicating that the query hit the materialized view."),(0,t.yg)("h3",{id:"example-3-pre-filtering-and-expression-computation-to-accelerate-queries"},"Example 3: Pre-filtering and Expression Computation to Accelerate Queries"),(0,t.yg)("p",null,"Business Scenario: Pre-filtering data or accelerating expression computation."),(0,t.yg)("p",null,"Create a table and materialized views for pre-filtering and expression computation:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"create table d_table (\n   k1 int null,\n   k2 int not null,\n   k3 bigint null,\n   k4 date null\n)\nduplicate key (k1,k2,k3)\ndistributed BY hash(k1) buckets 3\nproperties(\"replication_num\" = \"1\");\n\ninsert into d_table select 1,1,1,'2020-02-20';\ninsert into d_table select 2,2,2,'2021-02-20';\ninsert into d_table select 3,-3,null,'2022-02-20';\n")),(0,t.yg)("p",null,"Create some materialized views:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"-- mv1 Perform expression calculations ahead of time\ncreate materialized view mv1 as \nselect \n    abs(k1)+k2+1,        \n    sum(abs(k2+2)+k3+3) \nfrom \n    d_table \ngroup by \n    abs(k1)+k2+1;\n\n-- mv2 Use where expressions to filter in advance to reduce the amount of data in materialized views\ncreate materialized view mv2 as \nselect \n    year(k4),\n    month(k4) \nfrom \n    d_table \nwhere \n    year(k4) = 2020;\n")),(0,t.yg)("p",null,"Testing Whether the Materialized Views Are Successfully Hit with Some Queries:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"-- Hit mv1\nselect \n    abs(k1)+k2+1,\n    sum(abs(k2+2)+k3+3) \nfrom \n    d_table \ngroup by \n    abs(k1)+k2+1;\n    \n-- Hit mv1\nselect \n    bin(abs(k1)+k2+1),\n    sum(abs(k2+2)+k3+3) \nfrom \n    d_table \ngroup by \n    bin(abs(k1)+k2+1);\n\n-- Hit mv2\nselect \n    year(k4) + month(k4) \nfrom \n    d_table \nwhere \n    year(k4) = 2020;\n\n-- Hit table d_table but not hit mv2\uff0cbecause where condition does match\nselect \n    year(k4),\n    month(k4) \nfrom \n    d_table;\n\n")),(0,t.yg)("h2",{id:"faq"},"FAQ"),(0,t.yg)("p",null,"If materialized views do not match queries as expected, check if the materialized view is still being built using:"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-sql"},"show alter table materialized view from test_db;\n")),(0,t.yg)("p",null,"Wait until the status changes to ",(0,t.yg)("inlineCode",{parentName:"p"},"FINISHED")," before expecting materialized views to be available."))}p.isMDXComponent=!0}}]);