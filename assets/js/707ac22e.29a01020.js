"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([[681246],{15680:(e,t,a)=>{a.d(t,{xA:()=>c,yg:()=>m});var n=a(296540);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=n.createContext({}),p=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(l.Provider,{value:t},e.children)},g="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),g=p(a),d=r,m=g["".concat(l,".").concat(d)]||g[d]||u[d]||o;return a?n.createElement(m,s(s({ref:t},c),{},{components:a})):n.createElement(m,s({ref:t},c))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,s=new Array(o);s[0]=d;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[g]="string"==typeof e?e:r,s[1]=i;for(var p=2;p<o;p++)s[p]=a[p];return n.createElement.apply(null,s)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},876686:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>p});var n=a(58168),r=(a(296540),a(15680));const o={title:"Config Doris to Deploy",language:"en"},s=void 0,i={unversionedId:"install/cluster-deployment/k8s-deploy/install-config-cluster",id:"version-2.1/install/cluster-deployment/k8s-deploy/install-config-cluster",title:"Config Doris to Deploy",description:"\x3c!--",source:"@site/versioned_docs/version-2.1/install/cluster-deployment/k8s-deploy/install-config-cluster.md",sourceDirName:"install/cluster-deployment/k8s-deploy",slug:"/install/cluster-deployment/k8s-deploy/install-config-cluster",permalink:"/docs/install/cluster-deployment/k8s-deploy/install-config-cluster",draft:!1,tags:[],version:"2.1",frontMatter:{title:"Config Doris to Deploy",language:"en"},sidebar:"docs",previous:{title:"Deploying Doris Operator",permalink:"/docs/install/cluster-deployment/k8s-deploy/install-operator"},next:{title:"Cluster Operation",permalink:"/docs/install/cluster-deployment/k8s-deploy/cluster-operation"}},l={},p=[{value:"Cluster planning",id:"cluster-planning",level:2},{value:"Image settings",id:"image-settings",level:3},{value:"Replicas settings",id:"replicas-settings",level:3},{value:"Computing resource settings",id:"computing-resource-settings",level:3},{value:"Custom startup configuration",id:"custom-startup-configuration",level:2},{value:"Custom FE startup configuration",id:"custom-fe-startup-configuration",level:3},{value:"Custom BE startup configuration",id:"custom-be-startup-configuration",level:3},{value:"Mounting multiple ConfigMaps",id:"mounting-multiple-configmaps",level:3},{value:"Persistent storage",id:"persistent-storage",level:2},{value:"Persistent storage for FE",id:"persistent-storage-for-fe",level:3},{value:"Persistent metadata",id:"persistent-metadata",level:4},{value:"Persistent FE log",id:"persistent-fe-log",level:4},{value:"Persistent storage for BE",id:"persistent-storage-for-be",level:3},{value:"Persistent data",id:"persistent-data",level:4},{value:"Persistent BE log",id:"persistent-be-log",level:4},{value:"Access Configuration",id:"access-configuration",level:2},{value:"ClusterIP",id:"clusterip",level:3},{value:"NodePort",id:"nodeport",level:3},{value:"LoadBalancer",id:"loadbalancer",level:3},{value:"Configuring the Username and Password for the Management Cluster",id:"configuring-the-username-and-password-for-the-management-cluster",level:2},{value:"Configuring the Root User Password during Cluster Deployment",id:"configuring-the-root-user-password-during-cluster-deployment",level:3},{value:"Automatically Creating Non-Root Management Users and Passwords during Deployment (Recommended)",id:"automatically-creating-non-root-management-users-and-passwords-during-deployment-recommended",level:3},{value:"Setting the Root User Password after Cluster Deployment",id:"setting-the-root-user-password-after-cluster-deployment",level:3}],c={toc:p},g="wrapper";function u(e){let{components:t,...a}=e;return(0,r.yg)(g,(0,n.A)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,r.yg)("h2",{id:"cluster-planning"},"Cluster planning"),(0,r.yg)("p",null,"In the default deployed DorisCluster resources, the images used by FE and BE may not be the latest versions. The default number of replicas is FE = 3, BE = 3. The computing resources used by FE are 6c and 12Gi, and the resources used by BE are 8 c and 16Gi. Please refer to the following instructions for making changes."),(0,r.yg)("h3",{id:"image-settings"},"Image settings"),(0,r.yg)("p",null,"The Doris Operator is decoupled from the Doris version. Essentially, the Doris Operator can deploy any version of Doris if not explicitly specified."),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"FE image settings"),(0,r.yg)("br",{parentName:"p"}),"\n","Specify the image for fe as follows:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  feSpec:\n    image: ${image}\n")),(0,r.yg)("p",null,"Replace ${image} with the name of the image you want to deploy, update the configuration to the ",(0,r.yg)("a",{parentName:"p",href:"/docs/install/cluster-deployment/k8s-deploy/install-quickstart#step-3-deploy-doris-cluster"},"DorisCluster resource")," that needs to be deployed."),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"BE image settings"),(0,r.yg)("br",{parentName:"p"}),"\n","Specify the image for be as follows:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  beSpec:\n    image: ${image}\n")),(0,r.yg)("p",null,"Replace ${image} with the name of the image you want to deploy, update the configuration to the ",(0,r.yg)("a",{parentName:"p",href:"/docs/install/cluster-deployment/k8s-deploy/install-quickstart#step-3-deploy-doris-cluster"},"DorisCluster resource")," that needs to be deployed."),(0,r.yg)("h3",{id:"replicas-settings"},"Replicas settings"),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"FE Replicas Setting"),(0,r.yg)("br",{parentName:"p"}),"\n","Specify the replicas of fe as follows:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  feSpec:\n    replicas: 5\n")),(0,r.yg)("p",null,"Update the configuration to the ",(0,r.yg)("a",{parentName:"p",href:"/docs/install/cluster-deployment/k8s-deploy/install-quickstart#step-3-deploy-doris-cluster"},"DorisCluster resource")," that needs to be deployed."),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"BE Replicas Setting"),(0,r.yg)("br",{parentName:"p"}),"\n","Specify the replicas of be as follows:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  beSpec:\n    replicas: 5\n")),(0,r.yg)("p",null,"Update the configuration to the ",(0,r.yg)("a",{parentName:"p",href:"/docs/install/cluster-deployment/k8s-deploy/install-quickstart#step-3-deploy-doris-cluster"},"DorisCluster resource")," that needs to be deployed."),(0,r.yg)("h3",{id:"computing-resource-settings"},"Computing resource settings"),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"FE computing resource settings"),(0,r.yg)("br",{parentName:"p"}),"\n","To change the computing resources of fe to 8c and 16Gi, the configuration is as follows:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  feSpec:\n    requests:\n      cpu: 8\n      memory: 16Gi\n    limits:\n      cpu: 8\n      memory: 16Gi\n")),(0,r.yg)("p",null,"Update the configuration to the ",(0,r.yg)("a",{parentName:"p",href:"/docs/install/cluster-deployment/k8s-deploy/install-quickstart#step-3-deploy-doris-cluster"},"DorisCluster resource")," that needs to be deployed."),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"BE computing resource settings"),(0,r.yg)("br",{parentName:"p"}),"\n","To change the computing resources of be to 16c and 32Gi, the configuration is as follows:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  beSpec:\n    requests:\n      cpu: 16\n      memory: 32Gi\n    limits:\n      cpu: 16\n      memory: 32Gi\n")),(0,r.yg)("p",null,"Update the configuration to the ",(0,r.yg)("a",{parentName:"p",href:"/docs/install/cluster-deployment/k8s-deploy/install-quickstart#step-3-deploy-doris-cluster"},"DorisCluster resource")," that needs to be deployed."),(0,r.yg)("admonition",{title:"Tip  ",type:"tip"},(0,r.yg)("p",{parentName:"admonition"},"The minimum resources required for FE and BE are 4c and 8Gi. This is the minimum required for startup. The normal testing needed resources are 8c and 8Gi.  ")),(0,r.yg)("h2",{id:"custom-startup-configuration"},"Custom startup configuration"),(0,r.yg)("p",null,"Doris uses ConfigMap to decouple configuration files from services, in Kubernetes. By default, services use the default configurations in the image as startup parameter configurations.Customized the startup parameters into a specific ConfigMap according to the introductions in the ",(0,r.yg)("a",{parentName:"p",href:"/docs/admin-manual/config/fe-config"},"FE Configuration Document")," and the ",(0,r.yg)("a",{parentName:"p",href:"/docs/admin-manual/config/be-config"},"BE Configuration Document"),",\nand deploy the customized ConfigMap to the namespace where the ",(0,r.yg)("a",{parentName:"p",href:"/docs/install/cluster-deployment/k8s-deploy/install-quickstart#step-3-deploy-doris-cluster"},"DorisCluster resource")," needs to be deployed.  "),(0,r.yg)("h3",{id:"custom-fe-startup-configuration"},"Custom FE startup configuration"),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Deploying ConfigMap\nThe following defines a ConfigMap named fe-conf that can be used by Doris FE:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: fe-conf\n  labels:\n    app.kubernetes.io/component: fe\ndata:\n  fe.conf: |\n    CUR_DATE=`date +%Y%m%d-%H%M%S`\n\n    # the output dir of stderr and stdout\n    LOG_DIR = ${DORIS_HOME}/log\n\n    JAVA_OPTS="-Djavax.security.auth.useSubjectCredsOnly=false -Xss4m -Xmx8192m -XX:+UseMembar -XX:SurvivorRatio=8 -XX:MaxTenuringThreshold=7 -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+CMSClassUnloadingEnabled -XX:-CMSParallelRemarkEnabled -XX:CMSInitiatingOccupancyFraction=80 -XX:SoftRefLRUPolicyMSPerMB=0 -Xloggc:$DORIS_HOME/log/fe.gc.log.$CUR_DATE"\n\n    # For jdk 9+, this JAVA_OPTS will be used as default JVM options\n    JAVA_OPTS_FOR_JDK_9="-Djavax.security.auth.useSubjectCredsOnly=false -Xss4m -Xmx8192m -XX:SurvivorRatio=8 -XX:MaxTenuringThreshold=7 -XX:+CMSClassUnloadingEnabled -XX:-CMSParallelRemarkEnabled -XX:CMSInitiatingOccupancyFraction=80 -XX:SoftRefLRUPolicyMSPerMB=0 -Xlog:gc*:$DORIS_HOME/log/fe.gc.log.$CUR_DATE:time"\n\n    # INFO, WARN, ERROR, FATAL\n    sys_log_level = INFO\n\n    # NORMAL, BRIEF, ASYNC\n    sys_log_mode = NORMAL\n\n    # Default dirs to put jdbc drivers,default value is ${DORIS_HOME}/jdbc_drivers\n    # jdbc_drivers_dir = ${DORIS_HOME}/jdbc_drivers\n\n    http_port = 8030\n    rpc_port = 9020\n    query_port = 9030\n    edit_log_port = 9010\n    enable_fqdn_mode = true\n')),(0,r.yg)("p",{parentName:"li"},"When using the ConfigMap to mount FE startup configuration, the key corresponding to the configuration must be ",(0,r.yg)("inlineCode",{parentName:"p"},"fe.conf"),". Write the ConfigMap to a file and deploy it to the namespace where the DorisCluster resource is deployed, using the following command:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"kubectl -n ${namespace} apply -f ${feConfigMapFile}.yaml\n")),(0,r.yg)("p",{parentName:"li"},"${namespace} is the namespace to which the DorisCluster resource needs to be deployed, and ${feConfigMapFile} is the name of the configMap file used by FE.")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Configuring DorisCluster resource",(0,r.yg)("br",{parentName:"p"}),"\n","When use the ConfigMap named by ",(0,r.yg)("inlineCode",{parentName:"p"},"fe-conf")," to mount startup configuration, add the following config to the FE spec of the ",(0,r.yg)("a",{parentName:"p",href:"/docs/install/cluster-deployment/k8s-deploy/install-quickstart#step-3-deploy-doris-cluster"},"DorisCluster resource")," to be deployed:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  feSpec:\n    configMapInfo:\n      configMapName: fe-conf\n      resolveKey: fe.conf\n")))),(0,r.yg)("admonition",{title:"Tip",type:"tip"},(0,r.yg)("p",{parentName:"admonition"},"Please add ",(0,r.yg)("inlineCode",{parentName:"p"},"enable_fqdn_mode=true")," in start config. If you want to use ip mode and K8s have the ability that the pod IP keep the same after restarted, please refer to the ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/apache/doris-operator/issues/138"},"issue")," to config.")),(0,r.yg)("h3",{id:"custom-be-startup-configuration"},"Custom BE startup configuration"),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Deploying ConfigMap",(0,r.yg)("br",{parentName:"p"}),"\n","The following defines a ConfigMap named ",(0,r.yg)("inlineCode",{parentName:"p"},"be-conf")," that can be used by Doris BE:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: be-conf\n  labels:\n    app.kubernetes.io/component: be\ndata:\n  be.conf: |\n    CUR_DATE=`date +%Y%m%d-%H%M%S`\n\n    PPROF_TMPDIR="$DORIS_HOME/log/"\n\n    JAVA_OPTS="-Xmx1024m -DlogPath=$DORIS_HOME/log/jni.log -Xloggc:$DORIS_HOME/log/be.gc.log.$CUR_DATE -Djavax.security.auth.useSubjectCredsOnly=false -Dsun.java.command=DorisBE -XX:-CriticalJNINatives -DJDBC_MIN_POOL=1 -DJDBC_MAX_POOL=100 -DJDBC_MAX_IDLE_TIME=300000 -DJDBC_MAX_WAIT_TIME=5000"\n\n    # For jdk 9+, this JAVA_OPTS will be used as default JVM options\n    JAVA_OPTS_FOR_JDK_9="-Xmx1024m -DlogPath=$DORIS_HOME/log/jni.log -Xlog:gc:$DORIS_HOME/log/be.gc.log.$CUR_DATE -Djavax.security.auth.useSubjectCredsOnly=false -Dsun.java.command=DorisBE -XX:-CriticalJNINatives -DJDBC_MIN_POOL=1 -DJDBC_MAX_POOL=100 -DJDBC_MAX_IDLE_TIME=300000 -DJDBC_MAX_WAIT_TIME=5000"\n\n    # since 1.2, the JAVA_HOME need to be set to run BE process.\n    # JAVA_HOME=/path/to/jdk/\n\n    # https://github.com/apache/doris/blob/master/docs/zh-CN/community/developer-guide/debug-tool.md#jemalloc-heap-profile\n    # https://jemalloc.net/jemalloc.3.html\n    JEMALLOC_CONF="percpu_arena:percpu,background_thread:true,metadata_thp:auto,muzzy_decay_ms:15000,dirty_decay_ms:15000,oversize_threshold:0,lg_tcache_max:20,prof:false,lg_prof_interval:32,lg_prof_sample:19,prof_gdump:false,prof_accum:false,prof_leak:false,prof_final:false"\n    JEMALLOC_PROF_PRFIX=""\n\n    # INFO, WARNING, ERROR, FATAL\n    sys_log_level = INFO\n\n    # ports for admin, web, heartbeat service\n    be_port = 9060\n    webserver_port = 8040\n    heartbeat_service_port = 9050\n    brpc_port = 8060\n')),(0,r.yg)("p",{parentName:"li"},"When using the ConfigMap to mount BE startup configuration, the key corresponding to the configuration must be ",(0,r.yg)("inlineCode",{parentName:"p"},"be.conf"),". Write the ConfigMap to a file and deploy it to the namespace where the ",(0,r.yg)("a",{parentName:"p",href:"/docs/install/cluster-deployment/k8s-deploy/install-quickstart#step-3-deploy-doris-cluster"},"DorisCluster resource")," is deployed, using the following command:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"kubectl -n ${namespace} apply -f ${beConfigMapFile}.yaml\n")),(0,r.yg)("p",{parentName:"li"},"${namespace} is the namespace to which the DorisCluster resource needs to be deployed, and ${beConfigMapFile} is the name of the configMap file used by BE.")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Configuring DorisCluster Resource",(0,r.yg)("br",{parentName:"p"}),"\n","When use the ConfigMap named by ",(0,r.yg)("inlineCode",{parentName:"p"},"be-conf")," to mount startup configuration, add the following config to the BE spec of the ",(0,r.yg)("a",{parentName:"p",href:"/docs/install/cluster-deployment/k8s-deploy/install-quickstart#step-3-deploy-doris-cluster"},"DorisCluster resource")," to be deployed:"))),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  feSpec:\n    configMapInfo:\n      configMapName: be-conf\n      resolveKey: be.conf\n")),(0,r.yg)("admonition",{title:"Tip  ",type:"tip"},(0,r.yg)("p",{parentName:"admonition"},"Please use the startup configMap to mount files, when you want mount the file into the config directory in container, the config directory is ${DORIS_HOME}/conf.  ")),(0,r.yg)("h3",{id:"mounting-multiple-configmaps"},"Mounting multiple ConfigMaps"),(0,r.yg)("p",null,"In addition to providing the ability to mount configuration files, the Doris Operator also has the capability to mount multiple ConfigMaps to different directories within the container."),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Mounting multiple ConfigMaps for FE"),(0,r.yg)("br",{parentName:"p"}),"\n",'The following is an example of mounting the ConfigMaps named test-fe1 and test-fe2 to the directories "/etc/fe/config1/" and "/etc/fe/config2" within the FE container respectively:'),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  feSpec:\n    configMaps:\n    - configMapName: test-fe1\n      mountPath: /etc/fe/config1\n    - configMapName: test-fe2\n      mountPath: /etc/fe/config2\n")),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Mounting multiple ConfigMaps for BE"),(0,r.yg)("br",{parentName:"p"}),"\n",'The following is an example of mounting the ConfigMaps named test-be1 and test-be2 to the directories "/etc/be/config1/" and "/etc/be/config2" within the BE container respectively:'),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  beSpec:\n    configMaps:\n      - configMapName: test-be1\n        mountPath: /etc/be/config1\n      - configMapName: test-be2\n        mountPath: /etc/be/config2\n")),(0,r.yg)("h2",{id:"persistent-storage"},"Persistent storage"),(0,r.yg)("p",null,"Kubernetes provides the ",(0,r.yg)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/storage/persistent-volumes/"},"Persistent Volumes")," to persist data to physical storage. In Kubernetes, the Doris Operator automatically creates corresponding PersistentVolumeClaims associated with appropriate PersistentVolumes using the template that defined in the need deployed ",(0,r.yg)("a",{parentName:"p",href:"/docs/install/cluster-deployment/k8s-deploy/install-quickstart#step-3-deploy-doris-cluster"},"DorisCluster Resource"),".  "),(0,r.yg)("h3",{id:"persistent-storage-for-fe"},"Persistent storage for FE"),(0,r.yg)("p",null,"In the deployment of Doris on K8s, it is recommended to persist the ",(0,r.yg)("inlineCode",{parentName:"p"},"/opt/apache-doris/fe/doris-meta")," mount point by default. This is the default storage path for FE metadata. When Doris is deployed on K8s, logs are output to the console by default. If the cluster has the ability to collect logs, they can be directly collected through the console. If the cluster lacks a log collection system, it is recommended to persist the log path, default value is ",(0,r.yg)("inlineCode",{parentName:"p"},"/opt/apache-doris/fe/log"),"."),(0,r.yg)("h4",{id:"persistent-metadata"},"Persistent metadata"),(0,r.yg)("p",null,"When using the default configuration file, add the following configuration to the ",(0,r.yg)("a",{parentName:"p",href:"/docs/install/cluster-deployment/k8s-deploy/install-quickstart#step-3-deploy-doris-cluster"},"DorisCluster resource")," to be deployed:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  feSpec:\n    persistentVolumes:\n    - mountPath: /opt/apache-doris/fe/doris-meta\n      name: meta\n      persistentVolumeClaimSpec:\n        # when use specific storageclass, the storageClassName should reConfig, example as annotation.\n        storageClassName: ${your_storageclass}\n        accessModes:\n        - ReadWriteOnce\n        resources:\n          # notice: if the storage size less 5G, fe will not start normal.\n          requests:\n            storage: ${storageSize}\n")),(0,r.yg)("p",null,"In the above configuration, ${your_storageclass} represents the name of the StorageClass you want to use, and ${storageSize} represents the storage size you want to allocation. The format of ${storageSize} follows the ",(0,r.yg)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/kubernetes-api/common-definitions/quantity/"},"quantity expression")," method of K8s, such as: 100Gi. Please replace them as needed when using."),(0,r.yg)("h4",{id:"persistent-fe-log"},"Persistent FE log"),(0,r.yg)("p",null,"When using the default configuration file, add the following configuration to the ",(0,r.yg)("a",{parentName:"p",href:"/docs/install/cluster-deployment/k8s-deploy/install-quickstart#step-3-deploy-doris-cluster"},"DorisCluster resource")," to be deployed:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  feSpec:\n    persistentVolumes:\n    - mountPath: /opt/apache-doris/fe/log\n      name: log\n      persistentVolumeClaimSpec:\n        # when use specific storageclass, the storageClassName should reConfig, example as annotation.\n        storageClassName: ${your_storageclass}\n        accessModes:\n        - ReadWriteOnce\n        resources:\n          # notice: if the storage size less 5G, fe will not start normal.\n          requests:\n            storage: ${storageSize}\n")),(0,r.yg)("p",null,"In the above configuration, ${your_storageclass} represents the name of the StorageClass you want to use, and ${storageSize} represents the storage size you want to allocation. The format of ${storageSize} follows the ",(0,r.yg)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/kubernetes-api/common-definitions/quantity/"},"quantity expression")," method of K8s, such as: 100Gi. Please replace them as needed when using."),(0,r.yg)("admonition",{title:"Tip",type:"tip"},(0,r.yg)("ul",{parentName:"admonition"},(0,r.yg)("li",{parentName:"ul"},"If you have reconfigured meta_dir or sys_log_dir in the ",(0,r.yg)("a",{parentName:"li",href:"#custom-fe-startup-configuration"},"customized configuration file"),", please reconfigure the mountPath."))),(0,r.yg)("h3",{id:"persistent-storage-for-be"},"Persistent storage for BE"),(0,r.yg)("p",null,"In the deployment of Doris on K8s, it is recommended to persist the ",(0,r.yg)("inlineCode",{parentName:"p"},"/opt/apache-doris/be/storage")," mount point by default. This is the default storage path for storing actual data on BE nodes. When Doris is deployed on K8s, logs are output to the console by default. If the cluster has the ability to collect logs, they can be directly collected through the console. If the cluster lacks a log collection system, it is recommended to persist the log path, default value is ",(0,r.yg)("inlineCode",{parentName:"p"},"/opt/apache-doris/be/log"),"."),(0,r.yg)("h4",{id:"persistent-data"},"Persistent data"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("strong",{parentName:"p"},"Using default storage path"),(0,r.yg)("br",{parentName:"p"}),"\n","If BE uses the default configuration, please update the following configuration information to the ",(0,r.yg)("a",{parentName:"p",href:"/docs/install/cluster-deployment/k8s-deploy/install-quickstart#step-3-deploy-doris-cluster"},"DorisCluster resource")," to be deployed:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"beSpec:\n  persistentVolumes:\n  - mountPath: /opt/apache-doris/be/storage\n    name: be-storage\n    persistentVolumeClaimSpec:\n      storageClassName: ${your_storageclass}\n      accessModes:\n        - ReadWriteOnce\n      resources:\n        requests:\n          storage: ${storageSize}\n")),(0,r.yg)("p",{parentName:"li"},"In the above configuration, ${your_storageclass} represents the name of the StorageClass you want to use, and ${storageSize} represents the storage size you want to use. The format of ${storageSize} follows the ",(0,r.yg)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/kubernetes-api/common-definitions/quantity/"},"quantity expression method")," of K8s, such as: 100Gi. Please replace them as needed when using.")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("strong",{parentName:"p"},"Custom storage paths for BE")),(0,r.yg)("p",{parentName:"li"},"  Doris provides the ability to configure multiple storage directories to fully utilize the advantages of multiple disks. If multiple storage directories are specified through ",(0,r.yg)("inlineCode",{parentName:"p"},"storage_root_path")," in the customized configuration, the deployed DorisCluster should add multiple templates . For example, if ",(0,r.yg)("inlineCode",{parentName:"p"},"storage_root_path=/home/disk1/doris.HDD;/home/disk2/doris.SSD"),", you need to add the following configuration to the deployment resource:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"beSpec:\n  persistentVolumes:\n  - mountPath: /home/disk1/doris\n    name: be-storage1\n    persistentVolumeClaimSpec:\n      storageClassName: ${your_storageclass}\n      accessModes:\n        - ReadWriteOnce\n      resources:\n        requests:\n          storage: ${storageSize}\n  - mountPath: /home/disk2/doris\n    name: be-storage2\n    persistentVolumeClaimSpec:\n      storageClassName: ${your_storageclass}\n      accessModes:\n        - ReadWriteOnce\n      resources:\n        requests:\n          storage: ${storageSize}\n")),(0,r.yg)("p",{parentName:"li"},"  In the above configuration, ${your_storageclass} represents the name of the StorageClass you want to use, and ${storageSize} represents the storage size you want to use. The format of ${storageSize} follows the ",(0,r.yg)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/kubernetes-api/common-definitions/quantity/"},"quantity expression method")," of K8s, such as: 100Gi. Please replace them as needed when using."))),(0,r.yg)("h4",{id:"persistent-be-log"},"Persistent BE log"),(0,r.yg)("p",null,"When using the default configuration file, add the following configuration to the ",(0,r.yg)("a",{parentName:"p",href:"/docs/install/cluster-deployment/k8s-deploy/install-quickstart#step-3-deploy-doris-cluster"},"DorisCluster resource")," to be deployed:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"beSpec:\n  persistentVolumes:\n  - mountPath: /opt/apache-doris/be/log\n    name: belog\n    persistentVolumeClaimSpec:\n      storageClassName: ${your_storageclass}\n      accessModes:\n      - ReadWriteOnce\n      resources:\n        requests:\n          storage: ${storageSize}\n")),(0,r.yg)("p",null,"In the above configuration, ${your_storageclass} represents the name of the StorageClass you want to use, and ${storageSize} represents the storage size you want to use. The format of ${storageSize} follows the ",(0,r.yg)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/kubernetes-api/common-definitions/quantity/"},"quantity expression method")," of K8s, such as: 100Gi. Please replace them as needed when using."),(0,r.yg)("h2",{id:"access-configuration"},"Access Configuration"),(0,r.yg)("p",null,"Kubernetes provides the use of Service as VIP (Virtual IP) and load balancer. There are three external exposure modes for Service: ClusterIP, NodePort, and LoadBalancer."),(0,r.yg)("h3",{id:"clusterip"},"ClusterIP"),(0,r.yg)("p",null,"Doris provides the ClusterIP access mode by default on Kubernetes. The ClusterIP access mode provides an internal IP address within the Kubernetes cluster to expose services through this internal IP. With the ClusterIP mode, services can only be accessed within the cluster."),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Configure ClusterIP as the service type",(0,r.yg)("br",{parentName:"p"}),"\n","Doris provides the ClusterIP access mode by default on Kubernetes. You can use the ClusterIP access mode without any modification.")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Obtain the Service",(0,r.yg)("br",{parentName:"p"}),"\n","After deploying the cluster, you can view the services exposed by the Doris Operator using the following command:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"kubectl -n doris get svc\n")),(0,r.yg)("p",{parentName:"li"},"The returned result is as follows:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"NAME                              TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)                               AGE\ndoriscluster-sample-be-internal   ClusterIP   None          <none>        9050/TCP                              9m\ndoriscluster-sample-be-service    ClusterIP   10.1.68.128   <none>        9060/TCP,8040/TCP,9050/TCP,8060/TCP   9m\ndoriscluster-sample-fe-internal   ClusterIP   None          <none>        9030/TCP                              14m\ndoriscluster-sample-fe-service    ClusterIP   10.1.118.16   <none>        8030/TCP,9020/TCP,9030/TCP,9010/TCP   14m\n")),(0,r.yg)("p",{parentName:"li"},'In the above results, there are two types of services for FE and BE, with suffixes of "internal" and "service" respectively:'))),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},'The services with the "internal" suffix can only be used for internal communication within Doris, such as heartbeat, data exchange, and other operations, and are not for external use.'),(0,r.yg)("li",{parentName:"ul"},'The services with the "service" suffix can be used by users.')),(0,r.yg)("ol",{start:3},(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Access Doris from Inside the Container  "),(0,r.yg)("p",{parentName:"li"},"You can create a pod containing the mysql client in the current Kubernetes cluster using the following command:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"kubectl run mysql-client --image=mysql:5.7 -it --rm --restart=Never --namespace=doris -- /bin/bash\n")),(0,r.yg)("p",{parentName:"li"},'From within the container in the cluster, you can access the Doris cluster using the service name with the "service" suffix that is exposed externally:'),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"mysql -uroot -P9030 -hdoriscluster-sample-fe-service\n")))),(0,r.yg)("h3",{id:"nodeport"},"NodePort"),(0,r.yg)("p",null,"If users need to access Doris from outside the Kubernetes cluster, they can choose to use the NodePort mode. There are two ways to use NodePort: mapping the host port in advance and dynamically allocating the host port during deployment."),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"Dynamic Allocation:"),(0,r.yg)("p",{parentName:"li"},"If the port mapping is not explicitly set, Kubernetes will automatically allocate an unused port (the default range is 30000 - 32767) when creating the pod.")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"Static Allocation:"),(0,r.yg)("p",{parentName:"li"},"If the port mapping is explicitly specified, Kubernetes will fixedly allocate that port when it is unused and there is no conflict.  "))),(0,r.yg)("p",null,"Static allocation requires planning the port mapping. Doris provides the following ports for interacting with the outside:"),(0,r.yg)("table",null,(0,r.yg)("thead",{parentName:"table"},(0,r.yg)("tr",{parentName:"thead"},(0,r.yg)("th",{parentName:"tr",align:null},"Port Name"),(0,r.yg)("th",{parentName:"tr",align:null},"default value"),(0,r.yg)("th",{parentName:"tr",align:null},"Port Description"))),(0,r.yg)("tbody",{parentName:"table"},(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"Query Port"),(0,r.yg)("td",{parentName:"tr",align:null},"9030"),(0,r.yg)("td",{parentName:"tr",align:null},"Used to access the Doris cluster via the MySQL protocol")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"HTTP Port"),(0,r.yg)("td",{parentName:"tr",align:null},"8030"),(0,r.yg)("td",{parentName:"tr",align:null},"The http server port on FE, used to view FE information")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"Web Server Port"),(0,r.yg)("td",{parentName:"tr",align:null},"8040"),(0,r.yg)("td",{parentName:"tr",align:null},"The http server port on BE, used to view BE information")))),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},"Configure NodePort ")),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"FE NodePort"),"  "),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"The configuration for dynamic allocation of FE NodePort is as follows:",(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  feSpec:\n    service:\n      type: NodePort\n"))),(0,r.yg)("li",{parentName:"ul"},"An example of static configuration for FE NodePort is as follows:",(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  feSpec:\n    service:\n      type: NodePort\n      servicePorts:\n        - nodePort: 31001\n          targetPort: 8030\n        - nodePort: 31002\n          targetPort: 9030\n")))),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"BE NodePort"),"  "),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"The configuration for dynamic allocation of BE NodePort is as follows:",(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  beSpec:\n    service:\n      type: NodePort\n"))),(0,r.yg)("li",{parentName:"ul"},"An example of static allocation of BE NodePort is as follows:",(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"  beSpec:\n    service:\n      type: NodePort\n      servicePorts:\n        - nodePort: 31006\n          targetPort: 8040\n")))),(0,r.yg)("ol",{start:2},(0,r.yg)("li",{parentName:"ol"},"Obtain the Service",(0,r.yg)("br",{parentName:"li"}),"After deploying the cluster, you can view the services exposed by the Doris Operator using the following command:",(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"kubectl get service\n")),"The returned result is as follows:",(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"NAME                              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                       AGE\nkubernetes                        ClusterIP   10.152.183.1     <none>        443/TCP                                                       169d\ndoriscluster-sample-fe-internal   ClusterIP   None             <none>        9030/TCP                                                      2d\ndoriscluster-sample-fe-service    NodePort    10.152.183.58    <none>        8030:31041/TCP,9020:30783/TCP,9030:31545/TCP,9010:31610/TCP   2d\ndoriscluster-sample-be-internal   ClusterIP   None             <none>        9050/TCP                                                      2d\ndoriscluster-sample-be-service    NodePort    10.152.183.244   <none>        9060:30940/TCP,8040:32713/TCP,9050:30621/TCP,8060:30926/TCP   2d\n"))),(0,r.yg)("li",{parentName:"ol"},"Access Services Using NodePort",(0,r.yg)("br",{parentName:"li"}),"Taking the mysql connection as an example. The default Query Port of Doris is 9030, which is mapped to the host port 31545 in the above example. When accessing the Doris cluster, you also need to obtain the corresponding IP address, which can be viewed using the following command:",(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"kubectl get nodes -owide\n")),"The returned result is as follows:",(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"NAME   STATUS   ROLES           AGE   VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE          KERNEL-VERSION          CONTAINER-RUNTIME\nr60    Ready    control-plane   14d   v1.28.2   192.168.88.60   <none>        CentOS Stream 8   4.18.0-294.el8.x86_64   containerd://1.6.22\nr61    Ready    <none>          14d   v1.28.2   192.168.88.61   <none>        CentOS Stream 8   4.18.0-294.el8.x86_64   containerd://1.6.22\nr62    Ready    <none>          14d   v1.28.2   192.168.88.62   <none>        CentOS Stream 8   4.18.0-294.el8.x86_64   containerd://1.6.22\nr63    Ready    <none>          14d   v1.28.2   192.168.88.63   <none>        CentOS Stream 8   4.18.0-294.el8.x86_64   containerd://1.6.22\n")),"In the NodePort mode, you can access the services within the Kubernetes cluster based on the host IP of any node and the port mapping. In this example, you can use the IP of any node, such as 192.168.88.61, 192.168.88.62, or 192.168.88.63, to access the Doris service. For example, in the following, the node 192.168.88.62 and the mapped query port 31545 are used to access the cluster:",(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"mysql -h 192.168.88.62 -P 31545 -uroot\n")))),(0,r.yg)("h3",{id:"loadbalancer"},"LoadBalancer"),(0,r.yg)("p",null,(0,r.yg)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer"},"LoadBalancer")," is an additional load balancer provided by cloud service providers. This mode can only be configured when deploying the Doris cluster on K8s provided by the cloud platform.  "),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Configure the LoadBalancer Mode",(0,r.yg)("br",{parentName:"p"}),"\n",(0,r.yg)("strong",{parentName:"p"},"FE LoadBalancer"),"  "),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  feSpec:\n    service:\n      type: LoadBalancer\n")),(0,r.yg)("p",{parentName:"li"},(0,r.yg)("strong",{parentName:"p"},"BE LoadBalancer")),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  beSpec:\n    service:\n      type: LoadBalancer\n"))),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Obtain the Service",(0,r.yg)("br",{parentName:"p"}),"\n","After deploying the cluster, you can view the services exposed by the Doris Operator using the following command:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"kubectl get service\n")),(0,r.yg)("p",{parentName:"li"},"The returned result is as follows:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"NAME                              TYPE           CLUSTER-IP       EXTERNAL-IP                                                                     PORT(S)                                                       AGE\nkubernetes                        ClusterIP      10.152.183.1     <none>                                                                          443/TCP                                                       169d\ndoriscluster-sample-fe-internal   ClusterIP      None             <none>                                                                          9030/TCP                                                      2d\ndoriscluster-sample-fe-service    LoadBalancer   10.152.183.58    ac4828493dgrftb884g67wg4tb68gyut-1137856348.us-east-1.elb.amazonaws.com         8030:31041/TCP,9020:30783/TCP,9030:31545/TCP,9010:31610/TCP   2d\ndoriscluster-sample-be-internal   ClusterIP      None             <none>                                                                          9050/TCP                                                      2d\ndoriscluster-sample-be-service    LoadBalancer   10.152.183.244   ac4828493dgrftb884g67wg4tb68gyut-1137823345.us-east-1.elb.amazonaws.com         9060:30940/TCP,8040:32713/TCP,9050:30621/TCP,8060:30926/TCP   2d\n"))),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"Access Using the LoadBalancer Mode",(0,r.yg)("br",{parentName:"p"}),"\n","Taking the mysql connection as an example:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"mysql -h ac4828493dgrftb884g67wg4tb68gyut-1137856348.us-east-1.elb.amazonaws.com -P 31545 -uroot\n")))),(0,r.yg)("h2",{id:"configuring-the-username-and-password-for-the-management-cluster"},"Configuring the Username and Password for the Management Cluster"),(0,r.yg)("p",null,"The management of Doris nodes requires connecting to the live FE nodes via the MySQL protocol using a username and password for operations. Doris implements ",(0,r.yg)("a",{parentName:"p",href:"../../../admin-manual/auth/authentication-and-authorization?_highlight=rbac"},"a permission management mechanism similar to RBAC"),", and the management of nodes requires the user to have the ",(0,r.yg)("a",{parentName:"p",href:"/docs/admin-manual/auth/authentication-and-authorization#types-of-permissions"},"Node_priv")," permission. By default, Doris Operator deploys and manages the cluster configured with DorisCluster resources using the root user with all permissions in passwordless mode. After adding a password to the root user, it is necessary to explicitly configure the username and password with Node_Priv permission in the DorisCluster resource, so that Doris Operator can perform automated management operations on the cluster."),(0,r.yg)("p",null,"DorisCluster resources provide two ways to configure the username and password required for managing cluster nodes, including the way of environment variable configuration and the way of using ",(0,r.yg)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/configuration/secret/"},"Secret"),". Configuring the username and password for cluster management can be divided into three cases:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"initializing the root user password during cluster deployment;"),(0,r.yg)("li",{parentName:"ul"},"automatically setting a non-root user with management permissions in the root passwordless deployment;"),(0,r.yg)("li",{parentName:"ul"},"setting the root user password after deploying the cluster in root passwordless mode.")),(0,r.yg)("h3",{id:"configuring-the-root-user-password-during-cluster-deployment"},"Configuring the Root User Password during Cluster Deployment"),(0,r.yg)("p",null,"Doris supports configuring the root user's password in encrypted form in ",(0,r.yg)("inlineCode",{parentName:"p"},"fe.conf"),". To configure the root user's password during the first deployment of Doris, follow these steps so that Doris Operator can automatically manage the cluster nodes:"),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("strong",{parentName:"p"},"Generate the Root Encrypted Password")),(0,r.yg)("p",{parentName:"li"},"Doris supports setting the root user's password in the ",(0,r.yg)("a",{parentName:"p",href:"../../../admin-manual/config/fe-config?_highlight=initial_#initial_root_password"},"fe.conf")," in encrypted form. The password encryption is implemented using two-stage SHA-1 encryption. The code implementation is as follows:"),(0,r.yg)("p",{parentName:"li"},"Java Code for Two-Stage SHA-2 Encryption:  "),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-java"},'import org.apache.commons.codec.digest.DigestUtils;\n\npublic static void main( String[] args ) {\n      //the original password\n      String a = "123456";\n      String b = DigestUtils.sha1Hex(DigestUtils.sha1(a.getBytes())).toUpperCase();\n      //output the 2 stage encrypted password.\n      System.out.println("*"+b);\n  }\n')),(0,r.yg)("p",{parentName:"li"},"Golang Code for Two-Stage SHA-1 Encryption:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-go"},'import (\n"crypto/sha1"\n"encoding/hex"\n"fmt"\n"strings"\n)\n\nfunc main() {\n    //original password\n    plan := "123456"\n    //the first stage encryption.\n    h := sha1.New()\n    h.Write([]byte(plan))\n    eb := h.Sum(nil)\n    \n    //the two stage encryption.\n    h.Reset()\n    h.Write(eb)\n    teb := h.Sum(nil)\n    dst := hex.EncodeToString(teb)\n    tes := strings.ToUpper(fmt.Sprintf("%s", dst))\n    //output the 2 stage encrypted password. \n    fmt.Println("*"+tes)\n}\n')),(0,r.yg)("p",{parentName:"li"},"Configure the encrypted password into ",(0,r.yg)("inlineCode",{parentName:"p"},"fe.conf")," according to the requirements of the configuration file format. Then, distribute the configuration file to the K8s cluster in the form of a configmap according to the introduction in ",(0,r.yg)("a",{parentName:"p",href:"/docs/install/cluster-deployment/k8s-deploy/install-config-cluster"},"the Cluster Parameter Configuration Section"),".  ")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("strong",{parentName:"p"},"Configure the DorisCluster Resource"),"  "),(0,r.yg)("p",{parentName:"li"},"After setting the root initialization password in the configuration file, the root password will take effect immediately after the first Doris FE node starts. When other nodes join the cluster, Doris Operator needs to operate using the root username + password. It is necessary to specify the username + password in the deployed DorisCluster resource so that Doris Operator can automatically manage the cluster nodes."),(0,r.yg)("p",{parentName:"li"},(0,r.yg)("strong",{parentName:"p"},"Using Environment Variables:"),"  "),(0,r.yg)("p",{parentName:"li"},'Configure the username root and password into the ".spec.adminUser.name" and ".spec.adminUser.password" fields in the DorisCluster resource. Doris Operator will automatically convert the following configuration into environment variables for the container to use. The auxiliary services inside the container will use the username and password configured by the environment variables to add themselves to the specified cluster. The configuration format is as follows:'),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  adminUser:\n    name: root\n    password: ${password}\n")),(0,r.yg)("p",{parentName:"li"},"Here, ${password} is the unencrypted password of root."),(0,r.yg)("p",{parentName:"li"},(0,r.yg)("strong",{parentName:"p"},"Using Secret:"),"  "),(0,r.yg)("p",{parentName:"li"},"Doris Operator provides the use of ",(0,r.yg)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/configuration/secret/#basic-authentication-secret"},"Basic authentication Secret")," to specify the username and password of the management node. After the DorisCluster resource is configured to use the required Secret, Doris Operator will automatically mount the Secret to the specified location of the container in the form of a file. The auxiliary services of the container will parse the username and password from the file to automatically add themselves to the specified cluster. The stringData of basic-authentication-secret only contains two fields: username and password. The process of using Secret to configure the management username and password is as follows:"),(0,r.yg)("p",{parentName:"li"},"a. Configure the Required Secret"),(0,r.yg)("p",{parentName:"li"},"Configure the required Basic authentication Secret according to the following format:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"stringData:\n  username: root\n  password: ${password}\n")),(0,r.yg)("p",{parentName:"li"},"Here, ${password} is the unencrypted password set for root."),(0,r.yg)("p",{parentName:"li"},"b. Configure the DorisCluster Resource to be Deployed"),(0,r.yg)("p",{parentName:"li"},"Configure the DorisCluster to specify the required Secret in the following format:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  authSecret: ${secretName}\n")),(0,r.yg)("p",{parentName:"li"},"Here, ${secretName} is the name of the Secret containing the root username and password."))),(0,r.yg)("h3",{id:"automatically-creating-non-root-management-users-and-passwords-during-deployment-recommended"},"Automatically Creating Non-Root Management Users and Passwords during Deployment (Recommended)"),(0,r.yg)("p",null,"During the first deployment, do not set the initialization password of root. Instead, set the non-root user and login password through the environment variable or using Secret. The auxiliary services of the Doris container will automatically create the configured user in the database, set the password, and grant the Node_priv permission. Doris Operator will manage the cluster nodes using the automatically created username and password."),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"Using Environment Variables:"),(0,r.yg)("p",{parentName:"li"},"Configure the DorisCluster resource to be deployed according to the following format:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  adminUser:\n    name: ${DB_ADMIN_USER}\n    password: ${DB_ADMIN_PASSWD}\n")),(0,r.yg)("p",{parentName:"li"},"Here, ${DB_ADMIN_USER} is the newly created username, and ${DB_ADMIN_PASSWD} is the password set for the newly created username.")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"Using Secret:"),(0,r.yg)("p",{parentName:"li"},"a. Configure the Required Secret"),(0,r.yg)("p",{parentName:"li"},"Configure the required Basic authentication Secret according to the following format:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"stringData:\n  username: ${DB_ADMIN_USER}\n  password: ${DB_ADMIN_PASSWD}\n")),(0,r.yg)("p",{parentName:"li"},"Here, ${DB_ADMIN_USER} is the newly created username, and ${DB_ADMIN_PASSWD} is the password set for the newly created username.",(0,r.yg)("br",{parentName:"p"}),"\n","Deploy the updated Secret to the K8s cluster by running ",(0,r.yg)("inlineCode",{parentName:"p"},"kubectl -n ${namespace} apply -f ${secretFileName}.yaml"),". Here, ${namespace} is the namespace where the DorisCluster resource needs to be deployed, and ${secretFileName} is the file name of the Secret to be deployed."),(0,r.yg)("p",{parentName:"li"},"b. Configure the DorisCluster Resource Requiring Secret"),(0,r.yg)("p",{parentName:"li"},"Update the DorisCluster resource according to the following format:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  authSecret: ${secretName}\n")),(0,r.yg)("p",{parentName:"li"},"Here, ${secretName} is the name of the deployed Basic authentication Secret."))),(0,r.yg)("admonition",{title:"Tip  ",type:"tip"},(0,r.yg)("p",{parentName:"admonition"},"After deployment, please set the root password. Doris Operator will switch to using the automatically newly created username and password to manage the nodes. Please avoid deleting the automatically created user.  ")),(0,r.yg)("h3",{id:"setting-the-root-user-password-after-cluster-deployment"},"Setting the Root User Password after Cluster Deployment"),(0,r.yg)("p",null,"After the Doris cluster is deployed and the root user's password is set, it is necessary to configure a user with ",(0,r.yg)("a",{parentName:"p",href:"/docs/admin-manual/auth/authentication-and-authorization#types-of-permissions"},"Node_priv")," permission into the DorisCluster resource so that Doris Operator can automatically manage the cluster nodes. It is not recommended to use root as this username. Please refer to ",(0,r.yg)("a",{parentName:"p",href:"/docs/sql-manual/sql-statements/Account-Management-Statements/CREATE-USER"},"the User Creation and Permission Assignment Section")," to create a new user and grant Node_priv permission. After creating the user, specify the new management user and password through the environment variable or Secret method, and configure the corresponding DorisCluster resource."),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("strong",{parentName:"p"},"Create a User with Node_priv Permission")),(0,r.yg)("p",{parentName:"li"},"After connecting to the database using the MySQL protocol, use the following command to create a simple user with only Node_priv permission and set the password."),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"CREATE USER '${DB_ADMIN_USER}' IDENTIFIED BY '${DB_ADMIN_PASSWD}';\n")),(0,r.yg)("p",{parentName:"li"},"Here, ${DB_ADMIN_USER} is the username you hope to create, and ${DB_ADMIN_PASSWD} is the password you hope to set for the newly created user.")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("strong",{parentName:"p"},"Grant Node_priv Permission to the Newly Created User")),(0,r.yg)("p",{parentName:"li"},"After connecting to the database using the MySQL protocol, use the following command to grant Node_priv permission to the newly created user."),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"GRANT NODE_PRIV ON *.*.* TO ${DB_ADMIN_USER};\n")),(0,r.yg)("p",{parentName:"li"},"Here, ${DB_ADMIN_USER} is the newly created username."),(0,r.yg)("p",{parentName:"li"},"For detailed usage of creating users, setting passwords, and granting permissions, please refer to the official document ",(0,r.yg)("a",{parentName:"p",href:"/docs/sql-manual/sql-statements/Account-Management-Statements/CREATE-USER"},"CREATE-USER")," section.")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("strong",{parentName:"p"},"Configure DorisCluster")),(0,r.yg)("p",{parentName:"li"},(0,r.yg)("strong",{parentName:"p"},"Using Environment Variables"),"  "),(0,r.yg)("p",{parentName:"li"},'Configure the newly created username and password into the ".spec.adminUser.name" and ".spec.adminUser.password" fields in the DorisCluster resource. Doris Operator will automatically convert the following configuration into environment variables. The auxiliary services inside the container will use the username and password configured by the environment variables to add themselves to the specified cluster. The configuration format is as follows:'),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  adminUser:\n    name: ${DB_ADMIN_USER}\n    password: ${DB_ADMIN_PASSWD}\n")),(0,r.yg)("p",{parentName:"li"},"Here, ${DB_ADMIN_USER} is the newly created username, and ${DB_ADIC_PASSWD} is the password set for the newly created user."),(0,r.yg)("p",{parentName:"li"},(0,r.yg)("strong",{parentName:"p"},"Using Secret"),"  "),(0,r.yg)("p",{parentName:"li"},"a. Configure the Required Secret"),(0,r.yg)("p",{parentName:"li"},"Configure the required Basic authentication Secret according to the following format:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"stringData:\n  username: ${DB_ADMIN_USER}\n  password: ${DB_ADMIN_PASSWD}\n")),(0,r.yg)("p",{parentName:"li"},"Here, ${DB_ADMIN_USER} is the newly created username, and ${DB_ADMIN_PASSWD} is the password set for the newly created username.",(0,r.yg)("br",{parentName:"p"}),"\n","Deploy the configured Secret to the K8s cluster by running kubectl -n ${namespace} apply -f ${secretFileName}.yaml. Here, ${namespace} is the namespace where the DorisCluster resource needs to be deployed, and ${secretFileName} is the file name of the Secret to be deployed."),(0,r.yg)("p",{parentName:"li"},"b. Update the DorisCluster Resource Requiring Secret"),(0,r.yg)("p",{parentName:"li"},"Update the DorisCluster resource according to the following format:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  authSecret: ${secretName}\n")),(0,r.yg)("p",{parentName:"li"},"Here, ${secretName} is the name of the deployed Basic authentication Secret."))),(0,r.yg)("admonition",{title:"Tip  ",type:"tip"},(0,r.yg)("p",{parentName:"admonition"},"After setting the root password and configuring the new username and password for managing nodes after deployment, the existing services will be restarted once in a rolling manner.  ")))}u.isMDXComponent=!0}}]);