"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([[785479],{15680:(e,t,n)=>{n.d(t,{xA:()=>p,yg:()=>y});var i=n(296540);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n,i,r={},o=Object.keys(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=i.createContext({}),d=function(e){var t=i.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},p=function(e){var t=d(e.components);return i.createElement(s.Provider,{value:t},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},c=i.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),m=d(n),c=r,y=m["".concat(s,".").concat(c)]||m[c]||u[c]||o;return n?i.createElement(y,a(a({ref:t},p),{},{components:n})):i.createElement(y,a({ref:t},p))}));function y(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,a=new Array(o);a[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[m]="string"==typeof e?e:r,a[1]=l;for(var d=2;d<o;d++)a[d]=n[d];return i.createElement.apply(null,a)}return i.createElement.apply(null,n)}c.displayName="MDXCreateElement"},204271:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>d});var i=n(58168),r=(n(296540),n(15680));const o={title:"TOPN Query Optimization",language:"en"},a=void 0,l={unversionedId:"query/topn-query",id:"version-2.0/query/topn-query",title:"TOPN Query Optimization",description:"\x3c!--",source:"@site/versioned_docs/version-2.0/query/topn-query.md",sourceDirName:"query",slug:"/query/topn-query",permalink:"/docs/2.0/query/topn-query",draft:!1,tags:[],version:"2.0",frontMatter:{title:"TOPN Query Optimization",language:"en"},sidebar:"docs",previous:{title:"High-Concurrency Point Query",permalink:"/docs/2.0/query/high-concurrent-point-query"},next:{title:"Statistics of query execution",permalink:"/docs/2.0/query/query-analysis/query-profile"}},s={},d=[{value:"Optimization Points",id:"optimization-points",level:2},{value:"Limitations",id:"limitations",level:2},{value:"Configuration and Query Analysis",id:"configuration-and-query-analysis",level:2},{value:"Checking if TOPN Query Optimization is Enabled",id:"checking-if-topn-query-optimization-is-enabled",level:3},{value:"Checking the Effectiveness of TOPN Query Optimization During Execution",id:"checking-the-effectiveness-of-topn-query-optimization-during-execution",level:3}],p={toc:d},m="wrapper";function u(e){let{components:t,...n}=e;return(0,r.yg)(m,(0,i.A)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.yg)("p",null,"TOPN queries refer to queries that involve ORDER BY LIMIT operations, which are common in log retrieval and other detailed query scenarios. Doris automatically optimizes this type of query."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-sql"},"SELECT * FROM tablex WHERE xxx ORDER BY c1,c2 ... LIMIT n\n")),(0,r.yg)("h2",{id:"optimization-points"},"Optimization Points"),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},"During execution, dynamic range filters are built for the sorting columns (e.g., c1 >= 1000), which automatically apply the preceding conditions when reading data, leveraging zonemap indexes to filter out some rows or even entire files."),(0,r.yg)("li",{parentName:"ol"},"If the sorting fields c1, c2 are exactly the prefix of the table key, further optimization is applied. When reading data, only the header or tail of the data files is read, reducing the amount of data read to just the n rows needed."),(0,r.yg)("li",{parentName:"ol"},"SELECT * deferred materialization, during the data reading and sorting process, only the sorting columns are read, not the other columns. After obtaining the row numbers that meet the conditions, the entire data of those n rows needed is read, significantly reducing the amount of data read and sorted.")),(0,r.yg)("h2",{id:"limitations"},"Limitations"),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},"It only applies to DUP and MOW tables, not to MOR and AGG tables."),(0,r.yg)("li",{parentName:"ol"},"Due to the high memory consumption on very large ",(0,r.yg)("inlineCode",{parentName:"li"},"n"),", it will not take effect if n is greater than ",(0,r.yg)("inlineCode",{parentName:"li"},"topn_opt_limit_threshold"),".")),(0,r.yg)("h2",{id:"configuration-and-query-analysis"},"Configuration and Query Analysis"),(0,r.yg)("p",null,"The following two parameters are session variables that can be set for a specific SQL or globally."),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"p"},"topn_opt_limit_threshold"),": This session variable determines whether TOPN optimization is applied. It defaults to 1024, and setting it to 0 disables the optimization.")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"p"},"enable_two_phase_read_optimization"),": This session variable determines whether to enable this optimization. It defaults to true, and setting it to false disables the optimization."))),(0,r.yg)("h3",{id:"checking-if-topn-query-optimization-is-enabled"},"Checking if TOPN Query Optimization is Enabled"),(0,r.yg)("p",null,"To confirm if TOPN query optimization is enabled for a particular SQL, you can use the ",(0,r.yg)("inlineCode",{parentName:"p"},"EXPLAIN")," statement to get the query plan. An example is as follows:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"TOPN OPT")," indicates that optimization point 1 is applied."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"VOlapScanNode")," with ",(0,r.yg)("inlineCode",{parentName:"li"},"SORT LIMIT")," indicates optimization point 2 is applied."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"OPT TWO PHASE")," indicates optimization point 3 is applied.")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-sql"},"   1:VTOP-N(137)\n   |   order by: @timestamp18 DESC\n   |   TOPN OPT\n   |   OPT TWO PHASE\n   |   offset: 0\n   |   limit: 10\n   |   distribute expr lists: applicationName5\n   |  \n   0:VOlapScanNode(106)\n      TABLE: log_db.log_core_all_no_index(log_core_all_no_index), PREAGGREGATION: ON\n      SORT INFO:\n           @timestamp18\n      SORT LIMIT: 10\n      TOPN OPT:1\n      PREDICATES: ZYCFC-TRACE-ID4 like '%flowId-1720055220933%'\n      partitions=1/8 (p20240704), tablets=250/250, tabletList=1727094,1727096,1727098 ...\n      cardinality=345472780, avgRowSize=0.0, numNodes=1\n      pushAggOp=NONE\n")),(0,r.yg)("h3",{id:"checking-the-effectiveness-of-topn-query-optimization-during-execution"},"Checking the Effectiveness of TOPN Query Optimization During Execution"),(0,r.yg)("p",null,"First, set ",(0,r.yg)("inlineCode",{parentName:"p"},"topn_opt_limit_threshold")," to 0 to disable TOPN query optimization and compare the execution time of the SQL with and without optimization enabled."),(0,r.yg)("p",null,"After enabling TOPN query optimization, search for ",(0,r.yg)("inlineCode",{parentName:"p"},"RuntimePredicate")," in the query profile and focus on the following metrics:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"RowsZonemapRuntimePredicateFiltered"),": The number of rows filtered out, the higher the better."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"NumSegmentFiltered"),": The number of data files filtered out, the higher the better."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"BlockConditionsFilteredZonemapRuntimePredicateTime"),": The time taken to filter data, the lower the better.")),(0,r.yg)("p",null,"Before version 2.0.3, the ",(0,r.yg)("inlineCode",{parentName:"p"},"RuntimePredicate")," metrics were not separated out, and the ",(0,r.yg)("inlineCode",{parentName:"p"},"Zonemap")," metrics can be used as a rough guide."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"    SegmentIterator:\n          -  BitmapIndexFilterTimer:  46.54us\n          -  BlockConditionsFilteredBloomFilterTime:  10.352us\n          -  BlockConditionsFilteredDictTime:  7.299us\n          -  BlockConditionsFilteredTime:  202.23ms\n          -  BlockConditionsFilteredZonemapRuntimePredicateTime:  0ns\n          -  BlockConditionsFilteredZonemapTime:  402.917ms\n          -  BlockInitSeekCount:  399\n          -  BlockInitSeekTime:  11.309ms\n          -  BlockInitTime:  215.59ms\n          -  BlockLoadTime:  7s567ms\n          -  BlocksLoad:  392.97K  (392970)\n          -  CachedPagesNum:  0\n          -  CollectIteratorMergeTime:  0ns\n          -  CollectIteratorNormalTime:  0ns\n          -  CompressedBytesRead:  29.76  MB\n          -  DecompressorTimer:  427.713ms\n          -  ExprFilterEvalTime:  3s930ms\n          -  FirstReadSeekCount:  392.921K  (392921)\n          -  FirstReadSeekTime:  528.287ms\n          -  FirstReadTime:  1s134ms\n          -  IOTimer:  51.286ms\n          -  InvertedIndexFilterTime:  49.457us\n          -  InvertedIndexQueryBitmapCopyTime:  0ns\n          -  InvertedIndexQueryBitmapOpTime:  0ns\n          -  InvertedIndexQueryCacheHit:  0\n          -  InvertedIndexQueryCacheMiss:  0\n          -  InvertedIndexQueryTime:  0ns\n          -  InvertedIndexSearcherOpenTime:  0ns\n          -  InvertedIndexSearcherSearchTime:  0ns\n          -  LazyReadSeekCount:  0\n          -  LazyReadSeekTime:  0ns\n          -  LazyReadTime:  106.952us\n          -  NumSegmentFiltered:  0\n          -  NumSegmentTotal:  50\n          -  OutputColumnTime:  61.987ms\n          -  OutputIndexResultColumnTimer:  12.345ms\n          -  RawRowsRead:  3.929151M  (3929151)\n          -  RowsBitmapIndexFiltered:  0\n          -  RowsBloomFilterFiltered:  0\n          -  RowsConditionsFiltered:  6.38976M  (6389760)\n          -  RowsDictFiltered:  0\n          -  RowsInvertedIndexFiltered:  0\n          -  RowsKeyRangeFiltered:  0\n          -  RowsShortCircuitPredFiltered:  0\n          -  RowsShortCircuitPredInput:  0\n          -  RowsStatsFiltered:  6.38976M  (6389760)\n          -  RowsVectorPredFiltered:  0\n          -  RowsVectorPredInput:  0\n          -  RowsZonemapRuntimePredicateFiltered:  6.38976M  (6389760)\n          -  SecondReadTime:  0ns\n          -  ShortPredEvalTime:  0ns\n          -  TotalPagesNum:  2.301K  (2301)\n          -  UncompressedBytesRead:  137.99  MB\n          -  VectorPredEvalTime:  0ns\n")))}u.isMDXComponent=!0}}]);