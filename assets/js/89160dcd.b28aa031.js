"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([[724498],{15680:(e,a,t)=>{t.d(a,{xA:()=>p,yg:()=>m});var n=t(296540);function i(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function r(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function o(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?r(Object(t),!0).forEach((function(a){i(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function s(e,a){if(null==e)return{};var t,n,i=function(e,a){if(null==e)return{};var t,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)t=r[n],a.indexOf(t)>=0||(i[t]=e[t]);return i}(e,a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)t=r[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var l=n.createContext({}),g=function(e){var a=n.useContext(l),t=a;return e&&(t="function"==typeof e?e(a):o(o({},a),e)),t},p=function(e){var a=g(e.components);return n.createElement(l.Provider,{value:a},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},u=n.forwardRef((function(e,a){var t=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),c=g(t),u=i,m=c["".concat(l,".").concat(u)]||c[u]||d[u]||r;return t?n.createElement(m,o(o({ref:a},p),{},{components:t})):n.createElement(m,o({ref:a},p))}));function m(e,a){var t=arguments,i=a&&a.mdxType;if("string"==typeof e||i){var r=t.length,o=new Array(r);o[0]=u;var s={};for(var l in a)hasOwnProperty.call(a,l)&&(s[l]=a[l]);s.originalType=e,s[c]="string"==typeof e?e:i,o[1]=s;for(var g=2;g<r;g++)o[g]=t[g];return n.createElement.apply(null,o)}return n.createElement.apply(null,t)}u.displayName="MDXCreateElement"},737783:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>s,toc:()=>g});var n=t(58168),i=(t(296540),t(15680));const r={title:"How AI unicorn MiniMax migrated from Loki and built a PB-scale logging system with Apache Doris",summary:"Serving a PB-scale data size with over 99.9% availability, Apache Doris is the vital signs monitor of MiniMax, a generative AI startup backed by Alibaba.",description:"Serving a PB-scale data size with over 99.9% availability, Apache Doris is the vital signs monitor of MiniMax, a generative AI startup backed by Alibaba.",date:"2024-08-29",author:"Apache Doris",tags:["Best Practice"],picked:"true",order:"3",image:"/images/minimax-migrated-from-loki-to-doris.png"},o=void 0,s={permalink:"/blog/ai-unicorn-minimax-from-loki-and-built-a-pb-scale-logging-system-with-doris",source:"@site/blog/ai-unicorn-minimax-from-loki-and-built-a-pb-scale-logging-system-with-doris.md",title:"How AI unicorn MiniMax migrated from Loki and built a PB-scale logging system with Apache Doris",description:"Serving a PB-scale data size with over 99.9% availability, Apache Doris is the vital signs monitor of MiniMax, a generative AI startup backed by Alibaba.",date:"2024-08-29T00:00:00.000Z",formattedDate:"August 29, 2024",tags:[{label:"Best Practice",permalink:"/blog/tags/best-practice"}],hasTruncateMarker:!1,authors:[{name:"Apache Doris"}],frontMatter:{title:"How AI unicorn MiniMax migrated from Loki and built a PB-scale logging system with Apache Doris",summary:"Serving a PB-scale data size with over 99.9% availability, Apache Doris is the vital signs monitor of MiniMax, a generative AI startup backed by Alibaba.",description:"Serving a PB-scale data size with over 99.9% availability, Apache Doris is the vital signs monitor of MiniMax, a generative AI startup backed by Alibaba.",date:"2024-08-29",author:"Apache Doris",tags:["Best Practice"],picked:"true",order:"3",image:"/images/minimax-migrated-from-loki-to-doris.png"},prevItem:{title:"Apache Doris 2.1.6 just released",permalink:"/blog/release-note-2.1.6"},nextItem:{title:"Apache Doris 3.0.1 just released",permalink:"/blog/release-note-3.0.1"}},l={authorsImageUrls:[void 0]},g=[{value:"The old Grafana Loki-based logging system",id:"the-old-grafana-loki-based-logging-system",level:2},{value:"Why Apache Doris",id:"why-apache-doris",level:2},{value:"Apache Doris-based logging system",id:"apache-doris-based-logging-system",level:2},{value:"Hands-on experience from MiniMax",id:"hands-on-experience-from-minimax",level:2},{value:"Value to MiniMax",id:"value-to-minimax",level:2},{value:"What&#39;s next",id:"whats-next",level:2}],p={toc:g},c="wrapper";function d(e){let{components:a,...r}=e;return(0,i.yg)(c,(0,n.A)({},p,r,{components:a,mdxType:"MDXLayout"}),(0,i.yg)("p",null,"MiniMax, ",(0,i.yg)("a",{parentName:"p",href:"https://fortune.com/asia/2024/03/05/alibaba-leads-financing-round-chinese-ai-startup-minimax/"},"a generative AI startup backed by Alibaba, Tencent, miHoYo, etc."),", has been investing most of its efforts in MoE (Mixture of Experts) before it became an industry consensus. In April 2024, MiniMax launched its first commercially deployed MoE-based LLM, ",(0,i.yg)("strong",{parentName:"p"},"MiniMax-abab 6.5"),", which contains over a trillion parameters and delivers performances comparable to GPT-4, Claude-3, and Gemini-1.5. "),(0,i.yg)("p",null,"As their LLM is getting more complex and called upon more frequently, it generates an exploding amount of logs from model training and inference. These logs provide the basis for performance monitoring, optimization, and troubleshooting. The existing Grafana Loki-based logging system of MiniMax faced performance and stability issues, so they planned for an upgrade. After looking at the common industry solutions, they came to Apache Doris."),(0,i.yg)("p",null,(0,i.yg)("strong",{parentName:"p"},"Now, all of MiniMax's business lines have been integrated with the Apache Doris-based logging system, which serves a PB-scale data size with over 99.9% availability. The query latency on 100 million logs is within seconds.")),(0,i.yg)("h2",{id:"the-old-grafana-loki-based-logging-system"},"The old Grafana Loki-based logging system"),(0,i.yg)("p",null,"The design of Loki, an open-source log aggregation system, was inspired by Prometheus and developed by the Grafana Labs team. It does not have an indexing structure, but instead builds indexes only on log labels and metadata. "),(0,i.yg)("p",null,"The major components of a Loki-based system typically include:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"Loki"),": the main server responsible for log storage and querying.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"Promtail"),": the agent layer for collecting logs and sending them to Loki.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"Grafana"),": for user interface visualization."))),(0,i.yg)("p",null,"To deploy Grafana Loki, each cluster should be deployed with a complete set of log collectors and Loki log storage/query services. "),(0,i.yg)("p",null,"Loki uses an Index + Chunk design for log storage, where during ingestion, the different log streams are dispersed across various Ingesters based on a hash of the log labels, and the Ingesters are responsible for writing the log data to object storage. During querying, the Querier retrieves the relevant Chunks from the object storage based on the Index, and then performs the log matching."),(0,i.yg)("p",null,(0,i.yg)("img",{alt:"The old Grafana Loki-based logging system",src:t(73766).A,width:"1280",height:"498"})),(0,i.yg)("p",null,"Although Grafana Loki is positioned as a lightweight, horizontally scalable, and highly available log management system, it still faces some challenges in practical business use:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"Excessive query resource consumption"),": Loki does not create indexes based on the log, but instead, it only performs preliminary filtering of logs at the label granularity. Thus, for searches on the logs, it applies the query mechanism to perform full-text regular expression matching on the entire log data set. This operation can lead to spikes in resource consumption, including CPU, memory, and network bandwidth. As the volume of data being queried and the query per second (QPS) increases, Loki shows increasingly intolerable resource consumption and instability.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"Complex architecture"),": In addition to the modules shown in the above diagram, Loki also includes components like the Index Gateway, Memcache, and Compactor. The large number of architectural components makes the system challenging to operate and manage, and complex to configure.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"High maintenance cost and difficulty"),": MiniMax has a large number of deployed clusters, and each cluster has differences in its system, resources, storage, and network environments. The need to deploy an independent Loki architecture in each cluster adds to the maintenance difficulty."))),(0,i.yg)("h2",{id:"why-apache-doris"},"Why Apache Doris"),(0,i.yg)("p",null,"As one of the most data-intensive industries, AI use cases are characterized by long processing pipelines, abundant contextual data, and large per-request data volumes. Thus, the log size the MiniMax generates far exceeds those of non-AI software products of the same user base. The gigantic log size of MiniMax requires their logging system to be:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"High-performance"),": They need the system to return query results on 100 million log entries within seconds.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"Flexible"),": The system should support log alerting and log metric queries, such as generating statistical trend lines for key terms.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"Low-cost"),": The petabyte-scale raw log data continues to grow, so it's a make-or-break factor to keep the storage and computational costs within reasonable bounds."))),(0,i.yg)("p",null,"After an evaluation of mature logging system architectures in the industry, MiniMax identified the following key components typically found in leading log management solutions: "),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"Collection agent"),": collecting logs from service standard outputs and pushing the data into a central message queue.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"Message queue"),": decoupling upstream and downstream components, absorbing spikes, and ensuring system stability even when downstream components are unavailable.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"Storage and query middleware"),": storing and querying the log data. In a logging system, this middleware should be capable of inverted indexing to support efficient log searches."))),(0,i.yg)("p",null,"MiniMax decided to use iLogtail for the collection agents, Kafka for the message queue, and Apache Doris as the storage and query middleware. In selecting the storage middleware, MiniMax compared the representative technologies of Apache Doris and Elasticsearch."),(0,i.yg)("p",null,"Based on such reference architecture, MiniMax decided to use iLogtail as the collection agent, Apache Kafka for the message queue, and ",(0,i.yg)("strong",{parentName:"p"},(0,i.yg)("a",{parentName:"strong",href:"https://doris.apache.org"},"Apache Doris")," as the storage and query middleware"),". The middleware decision was made after comparing Apache Doris and Elasticsearch."),(0,i.yg)("p",null,(0,i.yg)("img",{alt:"Why Apache Doris",src:t(873129).A,width:"1280",height:"578"})),(0,i.yg)("p",null,"Apache Doris shows competitiveness in cost and performance. It stands out particularly in storage efficiency, write throughput, and aggregation. Additionally, its compatibility with the MySQL syntax makes it more user-friendly."),(0,i.yg)("h2",{id:"apache-doris-based-logging-system"},"Apache Doris-based logging system"),(0,i.yg)("p",null,(0,i.yg)("img",{alt:"Apache Doris-based logging system",src:t(192980).A,width:"1280",height:"571"})),(0,i.yg)("p",null,"The new logging system of MiniMax, called Mlogs, is more streamlined, with a single architecture serving all clusters. The upper layer acts as the control plane for the logging system, which consists of the encapsulation of log query interfaces and the module for automatic configuration generation and distribution. The lower layer represents the data plane of the logging system, containing the log collection agent, message queue, log writer, and the ",(0,i.yg)("strong",{parentName:"p"},"Apache Doris")," database."),(0,i.yg)("p",null,"Logs generated by the cluster services are collected by iLogtail and pushed to Kafka. Part of these logs is pulled from Kafka by the Mlogs Ingester and written to the Doris cluster via the Stream Load method of Apache Doris. The rest is directly subscribed to in real-time by Doris via Routine Load, pulling the message stream from Kafka. ",(0,i.yg)("strong",{parentName:"p"},"Ultimately, Apache Doris handles the storage and querying of all log data, eliminating the need for separate deployments for each cluster.")),(0,i.yg)("h2",{id:"hands-on-experience-from-minimax"},"Hands-on experience from MiniMax"),(0,i.yg)("p",null,(0,i.yg)("strong",{parentName:"p"},"Log ingestion")),(0,i.yg)("p",null,"The new architecture utilizes both the Routine Load and Stream Load methods of Apache Doris. Routine Load is ready to use out of the box and can directly handle JSON logs without the need for additional parsing. For more complex logs that require filtering and processing, MiniMax has introduced a log writer called Mlogs Ingester between Kafka and Doris. The Mlogs Ingester parses and processes the logs before writing them to Doris via Stream Load."),(0,i.yg)("p",null,(0,i.yg)("strong",{parentName:"p"},"Log search")),(0,i.yg)("p",null,"For log searches, MiniMax utilizes the inverted indexes and full-text regular expression query capabilities of Apache Doris."),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},"The inverted index of Apache Doris fits into a wide range of use cases and delivers high query performance. It's mainly used in ",(0,i.yg)("inlineCode",{parentName:"p"},"MATCH")," and ",(0,i.yg)("inlineCode",{parentName:"p"},"MATCH_PHRASE")," queries.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},"Full-text regular expression query (",(0,i.yg)("inlineCode",{parentName:"p"},"REGEXP"),") provides higher precision but lower performance than token-based queries. It is suitable for smaller-scale queries where precision is critical."))),(0,i.yg)("p",null,(0,i.yg)("strong",{parentName:"p"},"Performance improvement")),(0,i.yg)("p",null,"MiniMax implements ",(0,i.yg)("strong",{parentName:"p"},"query truncation")," to further accelerate queries. Log data is arranged linearly in chronological order. If a query requests data of a large range, it can consume excessive computation, storage, and network resources and potentially lead to query timeouts or even system unavailability. So they set and truncate the time range of the queries to prevent overly broad queries, and pre-calculate the data volume for all tables every 15 minutes to dynamically estimate the maximum queryable time range across different tables."),(0,i.yg)("p",null,(0,i.yg)("strong",{parentName:"p"},"Cost control")),(0,i.yg)("p",null,"To cut down storage costs, MiniMax utilizes the ",(0,i.yg)("strong",{parentName:"p"},(0,i.yg)("a",{parentName:"strong",href:"https://doris.apache.org/docs/table-design/cold-hot-separation/"},"tiered storage"))," capabilities of Apache Doris. They define data within the last 7 days as hot data and data older than 7 days as cold data. Data will be moved to object storage as soon as it turns cold. Furthermore, they archive object storage data that is over 30 days old and only restore the archived data when necessary."),(0,i.yg)("h2",{id:"value-to-minimax"},"Value to MiniMax"),(0,i.yg)("p",null,"Now, the Apache Doris-based logging system has been supporting all business line log data within MiniMax, serving a ",(0,i.yg)("strong",{parentName:"p"},"PB-scale data size")," with over ",(0,i.yg)("strong",{parentName:"p"},"99.9% availability"),". It has also brought the following values to MiniMax:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"Simplified architecture"),": The new system is easier to deploy and allows a single framework to serve all clusters. This reduces maintenance and management complexity, thus saving operational manpower and costs.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"Fast query response"),": The new system can respond to keyword searches and aggregation queries from 1 billion log records within 2 seconds. Most log queries can return results within seconds, too.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"High write performance"),": With the current hardware setups, the system can deliver a log write throughput of 10 GB/s, while maintaining data latency within seconds.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"Low storage costs"),": The data compression ratio reaches 5:1 and tiered storage further reduces storage costs by 70%."))),(0,i.yg)("h2",{id:"whats-next"},"What's next"),(0,i.yg)("p",null,"After a successful initial experience with Apache Doris, MiniMax proceeds with the next phase of its upgrade plan, which includes the following efforts:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"Log pre-processing"),": introduce log sampling and structuring to improve data usability and storage efficiency.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"Tracing"),": integrate the logging system with other observability systems (monitoring, alerting, tracing, etc.) to provide comprehensive operational insights.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"Lakehousing"),": expand the use of Apache Doris include big data processing and analysis within MiniMax, laying the foundation for a data lakehouse."))),(0,i.yg)("p",null,"If you have any questions or require assistance regarding Apache Doris, join the ",(0,i.yg)("a",{parentName:"p",href:"https://join.slack.com/t/apachedoriscommunity/shared_invite/zt-2gmq5o30h-455W226d79zP3L96ZhXIoQ"},"community"),"."))}d.isMDXComponent=!0},192980:(e,a,t)=>{t.d(a,{A:()=>n});const n=t.p+"assets/images/apache-doris-based-logging-system-915a5c753d8bc0a6f406a5afab1da799.png"},73766:(e,a,t)=>{t.d(a,{A:()=>n});const n=t.p+"assets/images/the-old-grafana-Loki-based-logging-system-d4f25adbc22b2ca44321d0dbf84603dc.png"},873129:(e,a,t)=>{t.d(a,{A:()=>n});const n=t.p+"assets/images/why-Apache-Doris-1cf3509615f273424114b2dc5a8aab3d.png"}}]);