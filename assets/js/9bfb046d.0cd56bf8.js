"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([[567004],{15680:(e,n,t)=>{t.d(n,{xA:()=>u,yg:()=>m});var a=t(296540);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var s=a.createContext({}),c=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},u=function(e){var n=c(e.components);return a.createElement(s.Provider,{value:n},e.children)},p="mdxType",y={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),p=c(t),d=i,m=p["".concat(s,".").concat(d)]||p[d]||y[d]||r;return t?a.createElement(m,l(l({ref:n},u),{},{components:t})):a.createElement(m,l({ref:n},u))}));function m(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var r=t.length,l=new Array(r);l[0]=d;var o={};for(var s in n)hasOwnProperty.call(n,s)&&(o[s]=n[s]);o.originalType=e,o[p]="string"==typeof e?e:i,l[1]=o;for(var c=2;c<r;c++)l[c]=t[c];return a.createElement.apply(null,l)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},781031:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>l,default:()=>y,frontMatter:()=>r,metadata:()=>o,toc:()=>c});var a=t(58168),i=(t(296540),t(15680));const r={title:"Workload Policy",language:"en"},l=void 0,o={unversionedId:"admin-manual/resource-admin/workload-policy",id:"version-3.0/admin-manual/resource-admin/workload-policy",title:"Workload Policy",description:"\x3c!--",source:"@site/versioned_docs/version-3.0/admin-manual/resource-admin/workload-policy.md",sourceDirName:"admin-manual/resource-admin",slug:"/admin-manual/resource-admin/workload-policy",permalink:"/docs/3.0/admin-manual/resource-admin/workload-policy",draft:!1,tags:[],version:"3.0",frontMatter:{title:"Workload Policy",language:"en"},sidebar:"docs",previous:{title:"Grouping Workload Groups",permalink:"/docs/3.0/admin-manual/resource-admin/group-workload-groups"},next:{title:"Workload Analysis",permalink:"/docs/3.0/admin-manual/resource-admin/workload-analysis"}},s={},c=[{value:"Backgroup",id:"backgroup",level:2},{value:"Basic Concepts",id:"basic-concepts",level:2},{value:"Basic Usage",id:"basic-usage",level:2},{value:"Policy used in FE",id:"policy-used-in-fe",level:3},{value:"Policy used in BE",id:"policy-used-in-be",level:3},{value:"Properties",id:"properties",level:3},{value:"Attention",id:"attention",level:3},{value:"Example",id:"example",level:2},{value:"Test",id:"test",level:2},{value:"1 set session variables",id:"1-set-session-variables",level:3},{value:"2 big query fusing test",id:"2-big-query-fusing-test",level:3}],u={toc:c},p="wrapper";function y(e){let{components:n,...t}=e;return(0,i.yg)(p,(0,a.A)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,i.yg)("h2",{id:"backgroup"},"Backgroup"),(0,i.yg)("p",null,"The Workload Group solves the problem of isolation between different workload, but it cannot solve negative impact of large queries on stability within the same Group. When users encounter large queries that affect cluster stability, they can only manually handle them."),(0,i.yg)("p",null,"Therefore, Doris has implemented Workload Policy, which supports the automation of query load management, such as automatically canceling queries with running time exceeding 5 seconds."),(0,i.yg)("h2",{id:"basic-concepts"},"Basic Concepts"),(0,i.yg)("p",null,"Provide an example of Workload Policy"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre"},"create workload policy test_cancel_policy\nconditions(query_time > 1000)\nactions(cancel_query) \nproperties('enabled'='true'); \n")),(0,i.yg)("p",null,"Workload Policy mainly includes the following concepts:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"policy\uff0cuser-defined policies\uff0cContains conditions for triggering policies and actions after triggering policies."),(0,i.yg)("li",{parentName:"ul"},"conditions\uff0crepresents the triggering conditions of the policy.A policy can have multiple conditions, and there is an AND relationship between multiple conditions."),(0,i.yg)("li",{parentName:"ul"},"actions\uff0cthe action works when a policy is triggered, such as canceling a query, currently only a policy can only have one action (except for ",(0,i.yg)("inlineCode",{parentName:"li"},"set_session_variable"),")."),(0,i.yg)("li",{parentName:"ul"},"properties\uff0cdefined the properties of the current policy, including whether it is enabled and its priority.")),(0,i.yg)("p",null,"The meaning of the policy in the above example is to create a policy named test_cancel_policy, which will cancel queries in the cluster that have been running for more than 1 second, and it's enabled.\nCREATE POLICY needs admin_priv."),(0,i.yg)("h2",{id:"basic-usage"},"Basic Usage"),(0,i.yg)("p",null,"Due to the fact that some actions can only take effect in FE and others can only take effect in BE, so the policy also needs to be distinguished between the policy of FE and the policy of BE."),(0,i.yg)("h3",{id:"policy-used-in-fe"},"Policy used in FE"),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},"Condition",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"username\uff0cWhen the username of a query is a certain value, the corresponding action will be triggered."))),(0,i.yg)("li",{parentName:"ol"},"Action",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"set_session_variable\uff0cThis action can execute a statement that sets session variable. The same policy can have multiple ",(0,i.yg)("inlineCode",{parentName:"li"},"set_session_variable"),", which means that a policy can execute multiple statements that modify the session variable.")))),(0,i.yg)("p",null,"The policy used in FE is mainly used to modify the session variable, and currently does not support the ",(0,i.yg)("inlineCode",{parentName:"p"},"set global"),"."),(0,i.yg)("h3",{id:"policy-used-in-be"},"Policy used in BE"),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},(0,i.yg)("p",{parentName:"li"},"Condition"),(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"be_scan_rows\uff0cThe number of rows scanned by an SQL within a single BE process, if the SQL is executed concurrently on the BE, it is the cumulative value of multiple concurrency."),(0,i.yg)("li",{parentName:"ul"},"be_scan_bytes\uff0cThe number of bytes scanned by an SQL within a single BE process, if the SQL is executed concurrently on the BE, it is the cumulative value of multiple concurrency, measured in bytes."),(0,i.yg)("li",{parentName:"ul"},"query_time\uff0cThe running time of an SQL on a single BE process, measured in milliseconds."),(0,i.yg)("li",{parentName:"ul"},"query_be_memory_bytes, The memory used by an SQL within a BE process, if the SQL is executed concurrently on the BE, it is the cumulative value of multiple concurrency, measured in bytes."))),(0,i.yg)("li",{parentName:"ol"},(0,i.yg)("p",{parentName:"li"},"Action"),(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"cancel_query\uff0ccancel query")))),(0,i.yg)("p",null,"At present, BE's policy is mainly used for managing BE workload, such as canceling a query when the scan data volume is too large or the query time is too long."),(0,i.yg)("h3",{id:"properties"},"Properties"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"enabled, the value is either true or false. The default value is true, indicating that the current policy is enabled, while false indicates that the current policy is disabled."),(0,i.yg)("li",{parentName:"ul"},"priority, the value range is a positive integer from 0 to 100, with a default value of 0. The higher the value, the higher the priority of the policy. The main function of this attribute is to select the policy with the highest priority when multiple policies are matched."),(0,i.yg)("li",{parentName:"ul"},"workload_group, A policy can be bound to a workload group, indicating that this policy only applies to a certain workload group.The default value is empty, which means it will take effect for all queries.")),(0,i.yg)("h3",{id:"attention"},"Attention"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},"Conditions and actions of the same policy are either used in FE or used in BE at the same time, for example, ",(0,i.yg)("inlineCode",{parentName:"p"},"set_session_variable")," and ",(0,i.yg)("inlineCode",{parentName:"p"},"cancel_query")," cannot be configured into the same policy. Condition ",(0,i.yg)("inlineCode",{parentName:"p"},"be_scan_rows")," and condition ",(0,i.yg)("inlineCode",{parentName:"p"},"username")," cannot be configured into the same policy.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},"Due to the current policy being executed by asynchronous threads at fixed time intervals, there is a certain lag in the effectiveness of the policy. For example, if a user has configured a strategy of canceling queries when the number of scan rows exceeds one million, and the cluster resources are relatively idle at this time, it is possible that the query may have ended before the cancel policy takes effect. At present, the time interval is 500ms, which means that queries with too short running time may bypass policy checks.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},"The currently supported workload types include select/insert select/stream load/broker load/route load.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},"A query may match multiple policies, but only the policy with the highest priority will take effect.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},"At present, it does not support modifying actions and conditions, and can only be modified by deleting and creating new ones."))),(0,i.yg)("h2",{id:"example"},"Example"),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},"Change the workload group in all session variables with the username admin to normal.")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre"},"create workload policy test_set_var_policy\nconditions(username='admin')\nactions(set_session_variable 'workload_group=normal') \n")),(0,i.yg)("ol",{start:2},(0,i.yg)("li",{parentName:"ol"},"Cancel SQL with scan rows greater than 1000 on a single BE.")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre"},"create workload policy test_cancel_query\nconditions(be_scan_rows > 1000)\nactions(cancel_query) \n")),(0,i.yg)("ol",{start:3},(0,i.yg)("li",{parentName:"ol"},"Cancel all SQL with scan bytes greater than 5GB and running time exceeding 1s.")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre"},"create workload policy test_cancel_big_query\nconditions(query_time > 1000, be_scan_bytes > 5368709120)\nactions(cancel_query) \n")),(0,i.yg)("ol",{start:4},(0,i.yg)("li",{parentName:"ol"},"Alter properties.")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre"},"alter workload policy test_cancel_big_query properties('workload_group'='normal');\n")),(0,i.yg)("ol",{start:5},(0,i.yg)("li",{parentName:"ol"},"show all workload policy.")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre"},"mysql [information_schema]>select * from workload_policy;\n+-------+-----------------------+----------------------------------------------+--------------+----------+---------+---------+----------------+\n| ID    | NAME                  | CONDITION                                    | ACTION       | PRIORITY | ENABLED | VERSION | WORKLOAD_GROUP |\n+-------+-----------------------+----------------------------------------------+--------------+----------+---------+---------+----------------+\n| 35025 | test_cancel_big_query | query_time > 1000;be_scan_bytes > 5368709120 | cancel_query |        0 |       1 |       1 | normal         |\n+-------+-----------------------+----------------------------------------------+--------------+----------+---------+---------+----------------+\n1 row in set (0.03 sec)\n")),(0,i.yg)("ol",{start:6},(0,i.yg)("li",{parentName:"ol"},"drop policy.")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre"},"drop workload policy test_cancel_3s_query;\n")),(0,i.yg)("h2",{id:"test"},"Test"),(0,i.yg)("h3",{id:"1-set-session-variables"},"1 set session variables"),(0,i.yg)("p",null,"Attempt to modify concurrency related parameters in the session variable of the admin user."),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre"},"// show variable parallel_fragment_exec_instance_num of admin user.\nmysql [(none)]>show variables like '%parallel_fragment_exec_instance_num%';\n+-------------------------------------+-------+---------------+---------+\n| Variable_name                       | Value | Default_Value | Changed |\n+-------------------------------------+-------+---------------+---------+\n| parallel_fragment_exec_instance_num | 8     | 8             | 0       |\n+-------------------------------------+-------+---------------+---------+\n1 row in set (0.00 sec)\n\n\n// create a policy which reset session variable.\ncreate workload policy test_set_var_policy\nconditions(username='admin')\nactions(set_session_variable 'parallel_fragment_exec_instance_num=1') \n\n\n// After a while, check the session variable of the admin.\nmysql [(none)]>show variables like '%parallel_fragment_exec_instance_num%';\n+-------------------------------------+-------+---------------+---------+\n| Variable_name                       | Value | Default_Value | Changed |\n+-------------------------------------+-------+---------------+---------+\n| parallel_fragment_exec_instance_num | 1     | 8             | 1       |\n+-------------------------------------+-------+---------------+---------+\n1 row in set (0.01 sec)\n")),(0,i.yg)("h3",{id:"2-big-query-fusing-test"},"2 big query fusing test"),(0,i.yg)("p",null,"Test fusing queries that have run for more than 3 seconds. The following is the audit log of a successful execution of q29 in Clickbench. It can be seen that it takes 4.5 seconds for this SQL to run."),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre"},"mysql [hits]>SELECT REGEXP_REPLACE(Referer, '^https?://(?:www\\.)?([^/]+)/.*$', '\\1') AS k, AVG(length(Referer)) AS l, COUNT(*) AS c, MIN(Referer) FROM hits WHERE Referer <> '' GROUP BY k HAVING COUNT(*) > 100000 ORDER BY l DESC LIMIT 25;\n+-----------------------------------------------------------------------+------------------+----------+---------------------------------------------------------------------------------------------------------------------+\n| k                                                                     | l                | c        | min(Referer)                                                                                                        |\n+-----------------------------------------------------------------------+------------------+----------+---------------------------------------------------------------------------------------------------------------------+\n| 1                                                                     | 85.4611926713085 | 67259319 | http://%26ad%3D1%25EA%25D0%26utm_source=web&cd=19590&input_onlist/\u0431\u0438-2 \u043c\u0435\u0441\u0442\u043e \u0431\u0443\u0434\u0443\u0449\u0435\u0439 \u043a\u043e\u043d\u0434\u0438\u0446\u0438\u043d                       |\n| http:%2F%2Fwwww.regnancies/search&evL8gE&where=all&filmId=bEmYZc_WTDE |               69 |   207347 | http:%2F%2Fwwww.regnancies/search&evL8gE&where=all&filmId=bEmYZc_WTDE                                               |\n| http://\u043d\u043e\u0432\u043e\u0441\u0442\u0440\u0430\u0448\u043d\u0430\u044f                                                   |               31 |   740277 | http://\u043d\u043e\u0432\u043e\u0441\u0442\u0440\u0430\u0448\u043d\u0430\u044f                                                                                                 |\n| http://loveche.html?ctid                                              |               24 |   144901 | http://loveche.html?ctid                                                                                            |\n| http://rukodeliveresult                                               |               23 |   226135 | http://rukodeliveresult                                                                                             |\n| http://holodilnik.ru                                                  |               20 |   133893 | http://holodilnik.ru                                                                                                |\n| http://smeshariki.ru                                                  |               20 |   210736 | http://smeshariki.ru                                                                                                |\n| http:%2F%2Fviewtopic                                                  |               20 |   391115 | http:%2F%2Fviewtopic                                                                                                |\n| http:%2F%2Fwwww.ukr                                                   |               19 |   655178 | http:%2F%2Fwwww.ukr                                                                                                 |\n| http:%2F%2FviewType                                                   |               19 |   148907 | http:%2F%2FviewType                                                                                                 |\n| http://state=2008                                                     |               17 |   139630 | http://state=2008                                                                                                   |\n+-----------------------------------------------------------------------+------------------+----------+---------------------------------------------------------------------------------------------------------------------+\n11 rows in set (4.50 sec)\n")),(0,i.yg)("p",null,"Create a policy that cancels queries after running for more than 3 seconds"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre"},"create workload policy test_cancel_3s_query\nconditions(query_time > 3000)\nactions(cancel_query) \n")),(0,i.yg)("p",null,"Executing SQL again will result in a direct error message."),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre"},"mysql [hits]>SELECT REGEXP_REPLACE(Referer, '^https?://(?:www\\.)?([^/]+)/.*$', '\\1') AS k, AVG(length(Referer)) AS l, COUNT(*) AS c, MIN(Referer) FROM hits WHERE Referer <> '' GROUP BY k HAVING COUNT(*) > 100000 ORDER BY l DESC LIMIT 25;\nERROR 1105 (HY000): errCode = 2, detailMessage = (10.16.10.8)[CANCELLED]query canceled by workload policy,id:12345\n")))}y.isMDXComponent=!0}}]);