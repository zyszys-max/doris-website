"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([[309894],{15680:(e,t,a)=>{a.d(t,{xA:()=>y,yg:()=>N});var n=a(296540);function l(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function g(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){l(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,l=function(e,t){if(null==e)return{};var a,n,l={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(l[a]=e[a]);return l}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(l[a]=e[a])}return l}var m=n.createContext({}),p=function(e){var t=n.useContext(m),a=t;return e&&(a="function"==typeof e?e(t):g(g({},t),e)),a},y=function(e){var t=p(e.components);return n.createElement(m.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},o=n.forwardRef((function(e,t){var a=e.components,l=e.mdxType,r=e.originalType,m=e.parentName,y=i(e,["components","mdxType","originalType","parentName"]),d=p(a),o=l,N=d["".concat(m,".").concat(o)]||d[o]||u[o]||r;return a?n.createElement(N,g(g({ref:t},y),{},{components:a})):n.createElement(N,g({ref:t},y))}));function N(e,t){var a=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var r=a.length,g=new Array(r);g[0]=o;var i={};for(var m in t)hasOwnProperty.call(t,m)&&(i[m]=t[m]);i.originalType=e,i[d]="string"==typeof e?e:l,g[1]=i;for(var p=2;p<r;p++)g[p]=a[p];return n.createElement.apply(null,g)}return n.createElement.apply(null,a)}o.displayName="MDXCreateElement"},998627:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>m,contentTitle:()=>g,default:()=>u,frontMatter:()=>r,metadata:()=>i,toc:()=>p});var n=a(58168),l=(a(296540),a(15680));const r={title:"Aggregate Key Model",language:"en"},g=void 0,i={unversionedId:"table-design/data-model/aggregate",id:"version-2.1/table-design/data-model/aggregate",title:"Aggregate Key Model",description:"\x3c!--",source:"@site/versioned_docs/version-2.1/table-design/data-model/aggregate.md",sourceDirName:"table-design/data-model",slug:"/table-design/data-model/aggregate",permalink:"/docs/table-design/data-model/aggregate",draft:!1,tags:[],version:"2.1",frontMatter:{title:"Aggregate Key Model",language:"en"},sidebar:"docs",previous:{title:"Unique Key Model",permalink:"/docs/table-design/data-model/unique"},next:{title:"Usage Notes",permalink:"/docs/table-design/data-model/tips"}},m={},p=[{value:"Importing Data Aggregation",id:"importing-data-aggregation",level:3},{value:"Import data and aggregate with existing data.",id:"import-data-and-aggregate-with-existing-data",level:3},{value:"agg_state",id:"agg_state",level:3}],y={toc:p},d="wrapper";function u(e){let{components:t,...a}=e;return(0,l.yg)(d,(0,n.A)({},y,a,{components:t,mdxType:"MDXLayout"}),(0,l.yg)("p",null,"The aggregate data model, also known as the Aggregate model, aggregates data based on key columns. The Doris storage layer retains the aggregated data, which helps reduce storage space and improve query performance. This model is typically used in scenarios where summarization or aggregation of information (such as totals or averages) is required."),(0,l.yg)("p",null,"The following example illustrates what the aggregate model is and how to use it correctly."),(0,l.yg)("h3",{id:"importing-data-aggregation"},"Importing Data Aggregation"),(0,l.yg)("p",null,"Assume that the business has the following data table schema:"),(0,l.yg)("table",null,(0,l.yg)("thead",{parentName:"table"},(0,l.yg)("tr",{parentName:"thead"},(0,l.yg)("th",{parentName:"tr",align:null},"ColumnName"),(0,l.yg)("th",{parentName:"tr",align:null},"Type"),(0,l.yg)("th",{parentName:"tr",align:null},"AggregationType"),(0,l.yg)("th",{parentName:"tr",align:null},"Comment"))),(0,l.yg)("tbody",{parentName:"table"},(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"user_id"),(0,l.yg)("td",{parentName:"tr",align:null},"LARGEINT"),(0,l.yg)("td",{parentName:"tr",align:null}),(0,l.yg)("td",{parentName:"tr",align:null},"user id")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"date"),(0,l.yg)("td",{parentName:"tr",align:null},"DATE"),(0,l.yg)("td",{parentName:"tr",align:null}),(0,l.yg)("td",{parentName:"tr",align:null},"date of data filling")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"city"),(0,l.yg)("td",{parentName:"tr",align:null},"VARCHAR (20)"),(0,l.yg)("td",{parentName:"tr",align:null}),(0,l.yg)("td",{parentName:"tr",align:null},"User City")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"age"),(0,l.yg)("td",{parentName:"tr",align:null},"SMALLINT"),(0,l.yg)("td",{parentName:"tr",align:null}),(0,l.yg)("td",{parentName:"tr",align:null},"User age")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"sex"),(0,l.yg)("td",{parentName:"tr",align:null},"TINYINT"),(0,l.yg)("td",{parentName:"tr",align:null}),(0,l.yg)("td",{parentName:"tr",align:null},"User gender")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"last_visit_date"),(0,l.yg)("td",{parentName:"tr",align:null},"DATETIME"),(0,l.yg)("td",{parentName:"tr",align:null},"REPLACE"),(0,l.yg)("td",{parentName:"tr",align:null},"Last user access time")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"cost"),(0,l.yg)("td",{parentName:"tr",align:null},"BIGINT"),(0,l.yg)("td",{parentName:"tr",align:null},"SUM"),(0,l.yg)("td",{parentName:"tr",align:null},"Total User Consumption")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"max_dwell_time"),(0,l.yg)("td",{parentName:"tr",align:null},"INT"),(0,l.yg)("td",{parentName:"tr",align:null},"MAX"),(0,l.yg)("td",{parentName:"tr",align:null},"Maximum user residence time")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"min_dwell_time"),(0,l.yg)("td",{parentName:"tr",align:null},"INT"),(0,l.yg)("td",{parentName:"tr",align:null},"MIN"),(0,l.yg)("td",{parentName:"tr",align:null},"User minimum residence time")))),(0,l.yg)("p",null,"The corresponding to CREATE TABLE statement would be as follows (omitting the Partition and Distribution information):"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-sql"},'CREATE DATABASE IF NOT EXISTS example_db;\n\nCREATE TABLE IF NOT EXISTS example_db.example_tbl_agg1\n(\n    `user_id` LARGEINT NOT NULL COMMENT "user id",\n    `date` DATE NOT NULL COMMENT "data import time",\n    `city` VARCHAR(20) COMMENT "city",\n    `age` SMALLINT COMMENT "age",\n    `sex` TINYINT COMMENT "gender",\n    `last_visit_date` DATETIME REPLACE DEFAULT "1970-01-01 00:00:00" COMMENT "last visit date time",\n    `cost` BIGINT SUM DEFAULT "0" COMMENT "user total cost",\n    `max_dwell_time` INT MAX DEFAULT "0" COMMENT "user max dwell time",\n    `min_dwell_time` INT MIN DEFAULT "99999" COMMENT "user min dwell time"\n)\nAGGREGATE KEY(`user_id`, `date`, `city`, `age`, `sex`)\nDISTRIBUTED BY HASH(`user_id`) BUCKETS 10\nPROPERTIES (\n"replication_allocation" = "tag.location.default: 3"\n);\n')),(0,l.yg)("p",null,"As you can see, this is a typical fact table of user information and visit behaviors. In star models, user information and visit behaviors are usually stored in dimension tables and fact tables, respectively. Here, for the convenience of explanation, we store the two types of information in one single table."),(0,l.yg)("p",null,"The columns in the table are divided into Key (dimension) columns and Value (indicator columns) based on whether they are set with an ",(0,l.yg)("inlineCode",{parentName:"p"},"AggregationType"),". ",(0,l.yg)("strong",{parentName:"p"},"Key")," columns are not set with an  ",(0,l.yg)("inlineCode",{parentName:"p"},"AggregationType"),", such as ",(0,l.yg)("inlineCode",{parentName:"p"},"user_id"),", ",(0,l.yg)("inlineCode",{parentName:"p"},"date"),", and  ",(0,l.yg)("inlineCode",{parentName:"p"},"age"),", while ",(0,l.yg)("strong",{parentName:"p"},"Value")," columns are."),(0,l.yg)("p",null,"When data are imported, rows with the same contents in the Key columns will be aggregated into one row, and their values in the Value columns will be aggregated as their ",(0,l.yg)("inlineCode",{parentName:"p"},"AggregationType"),' specify. Currently, there are several aggregation methods and "agg_state" options available:'),(0,l.yg)("ul",null,(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("p",{parentName:"li"},"SUM: Accumulate the values in multiple rows.")),(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("p",{parentName:"li"},"REPLACE: The newly imported value will replace the previous value.")),(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("p",{parentName:"li"},"MAX: Keep the maximum value.")),(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("p",{parentName:"li"},"MIN: Keep the minimum value.")),(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("p",{parentName:"li"},"REPLACE_IF_NOT_NULL: Non-null value replacement. Unlike REPLACE, it does not replace null values.")),(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("p",{parentName:"li"},"HLL_UNION: Aggregation method for columns of HLL type, using the HyperLogLog algorithm for aggregation.")),(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("p",{parentName:"li"},"BITMAP_UNION: Aggregation method for columns of BITMAP type, performing a union aggregation of bitmaps."))),(0,l.yg)("admonition",{type:"tip"},(0,l.yg)("p",{parentName:"admonition"},'If these aggregation methods cannot meet the requirements, you can choose to use the "agg_state" type.')),(0,l.yg)("p",null,"Suppose that you have the following import data (raw data):"),(0,l.yg)("table",null,(0,l.yg)("thead",{parentName:"table"},(0,l.yg)("tr",{parentName:"thead"},(0,l.yg)("th",{parentName:"tr",align:null},"user","_","id"),(0,l.yg)("th",{parentName:"tr",align:null},"date"),(0,l.yg)("th",{parentName:"tr",align:null},"city"),(0,l.yg)("th",{parentName:"tr",align:null},"age"),(0,l.yg)("th",{parentName:"tr",align:null},"sex"),(0,l.yg)("th",{parentName:"tr",align:null},"last","_","visit","_","date"),(0,l.yg)("th",{parentName:"tr",align:null},"cost"),(0,l.yg)("th",{parentName:"tr",align:null},"max","_","dwell","_","time"),(0,l.yg)("th",{parentName:"tr",align:null},"min","_","dwell","_","time"))),(0,l.yg)("tbody",{parentName:"table"},(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10000"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01"),(0,l.yg)("td",{parentName:"tr",align:null},"Beijing"),(0,l.yg)("td",{parentName:"tr",align:null},"20"),(0,l.yg)("td",{parentName:"tr",align:null},"0"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01 06:00"),(0,l.yg)("td",{parentName:"tr",align:null},"20"),(0,l.yg)("td",{parentName:"tr",align:null},"10"),(0,l.yg)("td",{parentName:"tr",align:null},"10")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10000"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01"),(0,l.yg)("td",{parentName:"tr",align:null},"Beijing"),(0,l.yg)("td",{parentName:"tr",align:null},"20"),(0,l.yg)("td",{parentName:"tr",align:null},"0"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01 07:00"),(0,l.yg)("td",{parentName:"tr",align:null},"15"),(0,l.yg)("td",{parentName:"tr",align:null},"2"),(0,l.yg)("td",{parentName:"tr",align:null},"2")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10001"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01"),(0,l.yg)("td",{parentName:"tr",align:null},"Beijing"),(0,l.yg)("td",{parentName:"tr",align:null},"30"),(0,l.yg)("td",{parentName:"tr",align:null},"1"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01 17:05:45"),(0,l.yg)("td",{parentName:"tr",align:null},"2"),(0,l.yg)("td",{parentName:"tr",align:null},"22"),(0,l.yg)("td",{parentName:"tr",align:null},"22")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10002"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-02"),(0,l.yg)("td",{parentName:"tr",align:null},"Shanghai"),(0,l.yg)("td",{parentName:"tr",align:null},"20"),(0,l.yg)("td",{parentName:"tr",align:null},"1"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-02 12:59:12"),(0,l.yg)("td",{parentName:"tr",align:null},"200"),(0,l.yg)("td",{parentName:"tr",align:null},"5"),(0,l.yg)("td",{parentName:"tr",align:null},"5")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10003"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-02"),(0,l.yg)("td",{parentName:"tr",align:null},"Guangzhou"),(0,l.yg)("td",{parentName:"tr",align:null},"32"),(0,l.yg)("td",{parentName:"tr",align:null},"0"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-02 11:20:00"),(0,l.yg)("td",{parentName:"tr",align:null},"30"),(0,l.yg)("td",{parentName:"tr",align:null},"11"),(0,l.yg)("td",{parentName:"tr",align:null},"11")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10004"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01"),(0,l.yg)("td",{parentName:"tr",align:null},"Shenzhen"),(0,l.yg)("td",{parentName:"tr",align:null},"35"),(0,l.yg)("td",{parentName:"tr",align:null},"0"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01 10:00:15"),(0,l.yg)("td",{parentName:"tr",align:null},"100"),(0,l.yg)("td",{parentName:"tr",align:null},"3"),(0,l.yg)("td",{parentName:"tr",align:null},"3")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10004"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-03"),(0,l.yg)("td",{parentName:"tr",align:null},"Shenzhen"),(0,l.yg)("td",{parentName:"tr",align:null},"35"),(0,l.yg)("td",{parentName:"tr",align:null},"0"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-03 10:20:22"),(0,l.yg)("td",{parentName:"tr",align:null},"11"),(0,l.yg)("td",{parentName:"tr",align:null},"6"),(0,l.yg)("td",{parentName:"tr",align:null},"6")))),(0,l.yg)("p",null,"And you can import data with the following sql:"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-sql"},'insert into example_db.example_tbl_agg1 values\n(10000,"2017-10-01","Beijing",20,0,"2017-10-01 06:00:00",20,10,10),\n(10000,"2017-10-01","Beijing",20,0,"2017-10-01 07:00:00",15,2,2),\n(10001,"2017-10-01","Beijing",30,1,"2017-10-01 17:05:45",2,22,22),\n(10002,"2017-10-02","Shanghai",20,1,"2017-10-02 12:59:12",200,5,5),\n(10003,"2017-10-02","Guangzhou",32,0,"2017-10-02 11:20:00",30,11,11),\n(10004,"2017-10-01","Shenzhen",35,0,"2017-10-01 10:00:15",100,3,3),\n(10004,"2017-10-03","Shenzhen",35,0,"2017-10-03 10:20:22",11,6,6);\n')),(0,l.yg)("p",null,"This is a table recording the user behaviors when visiting a certain commodity page. The first row of data, for example, is explained as follows:"),(0,l.yg)("table",null,(0,l.yg)("thead",{parentName:"table"},(0,l.yg)("tr",{parentName:"thead"},(0,l.yg)("th",{parentName:"tr",align:null},"Data"),(0,l.yg)("th",{parentName:"tr",align:null},"Description"))),(0,l.yg)("tbody",{parentName:"table"},(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10000"),(0,l.yg)("td",{parentName:"tr",align:null},"User ID, each user uniquely identifies id")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01"),(0,l.yg)("td",{parentName:"tr",align:null},"Data storage time, accurate to date")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"Beijing"),(0,l.yg)("td",{parentName:"tr",align:null},"User City")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"20"),(0,l.yg)("td",{parentName:"tr",align:null},"User Age")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"0"),(0,l.yg)("td",{parentName:"tr",align:null},"Gender male (1 for female)")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01 06:00"),(0,l.yg)("td",{parentName:"tr",align:null},"User's time to visit this page, accurate to seconds")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"20"),(0,l.yg)("td",{parentName:"tr",align:null},"Consumption generated by the user's current visit")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10"),(0,l.yg)("td",{parentName:"tr",align:null},"User's visit, time to stay on the page")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10"),(0,l.yg)("td",{parentName:"tr",align:null},"User's current visit, time spent on the page (redundancy)")))),(0,l.yg)("p",null,"After this batch of data is imported into Doris correctly, it will be stored in Doris as follows:"),(0,l.yg)("table",null,(0,l.yg)("thead",{parentName:"table"},(0,l.yg)("tr",{parentName:"thead"},(0,l.yg)("th",{parentName:"tr",align:null},"user","_","id"),(0,l.yg)("th",{parentName:"tr",align:null},"date"),(0,l.yg)("th",{parentName:"tr",align:null},"city"),(0,l.yg)("th",{parentName:"tr",align:null},"age"),(0,l.yg)("th",{parentName:"tr",align:null},"sex"),(0,l.yg)("th",{parentName:"tr",align:null},"last","_","visit","_","date"),(0,l.yg)("th",{parentName:"tr",align:null},"cost"),(0,l.yg)("th",{parentName:"tr",align:null},"max","_","dwell","_","time"),(0,l.yg)("th",{parentName:"tr",align:null},"min","_","dwell","_","time"))),(0,l.yg)("tbody",{parentName:"table"},(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10000"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01"),(0,l.yg)("td",{parentName:"tr",align:null},"Beijing"),(0,l.yg)("td",{parentName:"tr",align:null},"20"),(0,l.yg)("td",{parentName:"tr",align:null},"0"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01 07:00"),(0,l.yg)("td",{parentName:"tr",align:null},"35"),(0,l.yg)("td",{parentName:"tr",align:null},"10"),(0,l.yg)("td",{parentName:"tr",align:null},"2")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10001"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01"),(0,l.yg)("td",{parentName:"tr",align:null},"Beijing"),(0,l.yg)("td",{parentName:"tr",align:null},"30"),(0,l.yg)("td",{parentName:"tr",align:null},"1"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01 17:05:45"),(0,l.yg)("td",{parentName:"tr",align:null},"2"),(0,l.yg)("td",{parentName:"tr",align:null},"22"),(0,l.yg)("td",{parentName:"tr",align:null},"22")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10002"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-02"),(0,l.yg)("td",{parentName:"tr",align:null},"Shanghai"),(0,l.yg)("td",{parentName:"tr",align:null},"20"),(0,l.yg)("td",{parentName:"tr",align:null},"1"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-02 12:59:12"),(0,l.yg)("td",{parentName:"tr",align:null},"200"),(0,l.yg)("td",{parentName:"tr",align:null},"5"),(0,l.yg)("td",{parentName:"tr",align:null},"5")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10003"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-02"),(0,l.yg)("td",{parentName:"tr",align:null},"Guangzhou"),(0,l.yg)("td",{parentName:"tr",align:null},"32"),(0,l.yg)("td",{parentName:"tr",align:null},"0"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-02 11:20:00"),(0,l.yg)("td",{parentName:"tr",align:null},"30"),(0,l.yg)("td",{parentName:"tr",align:null},"11"),(0,l.yg)("td",{parentName:"tr",align:null},"11")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10004"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01"),(0,l.yg)("td",{parentName:"tr",align:null},"Shenzhen"),(0,l.yg)("td",{parentName:"tr",align:null},"35"),(0,l.yg)("td",{parentName:"tr",align:null},"0"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01 10:00:15"),(0,l.yg)("td",{parentName:"tr",align:null},"100"),(0,l.yg)("td",{parentName:"tr",align:null},"3"),(0,l.yg)("td",{parentName:"tr",align:null},"3")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10004"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-03"),(0,l.yg)("td",{parentName:"tr",align:null},"Shenzhen"),(0,l.yg)("td",{parentName:"tr",align:null},"35"),(0,l.yg)("td",{parentName:"tr",align:null},"0"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-03 10:20:22"),(0,l.yg)("td",{parentName:"tr",align:null},"11"),(0,l.yg)("td",{parentName:"tr",align:null},"6"),(0,l.yg)("td",{parentName:"tr",align:null},"6")))),(0,l.yg)("p",null,"The data of User 10000 have been aggregated to one row, while those of other users remain the same. The explanation for the aggregated data of User 10000 is as follows (the first 5 columns remain unchanged, so it starts with Column 6 ",(0,l.yg)("inlineCode",{parentName:"p"},"last_visit_date"),"):"),(0,l.yg)("ul",null,(0,l.yg)("li",{parentName:"ul"},"The value in the 6th column is 2017-10-01 07:00: The ",(0,l.yg)("inlineCode",{parentName:"li"},"last_visit_date")," column is aggregated by REPLACE, so ",(0,l.yg)("inlineCode",{parentName:"li"},"2017-10-01 07:00")," has replaced  ",(0,l.yg)("inlineCode",{parentName:"li"},"2017-10-01 06:00"),".")),(0,l.yg)("admonition",{type:"tip"},(0,l.yg)("p",{parentName:"admonition"},"When using REPLACE to aggregate data from the same import batch, the order of replacement is uncertain. That means, in this case, the data eventually saved in Doris could be ",(0,l.yg)("inlineCode",{parentName:"p"},"2017-10-01 06:00"),". However, for different import batches, it is certain that data from the new batch will replace those from the old batch.")),(0,l.yg)("ul",null,(0,l.yg)("li",{parentName:"ul"},"The value in the 7th column is 35: The ",(0,l.yg)("inlineCode",{parentName:"li"},"cost"),"column is aggregated by SUM, so the update value ",(0,l.yg)("inlineCode",{parentName:"li"},"35")," is the result of ",(0,l.yg)("inlineCode",{parentName:"li"},"20")," + ",(0,l.yg)("inlineCode",{parentName:"li"},"15"),"."),(0,l.yg)("li",{parentName:"ul"},"The value in the 8th column is 10: The ",(0,l.yg)("inlineCode",{parentName:"li"},"max_dwell_time")," column is aggregated by MAX, so ",(0,l.yg)("inlineCode",{parentName:"li"},"10")," is saved as it is the maximum between ",(0,l.yg)("inlineCode",{parentName:"li"},"10")," and ",(0,l.yg)("inlineCode",{parentName:"li"},"2"),"."),(0,l.yg)("li",{parentName:"ul"},"The value in the 9th column is 2: The  ",(0,l.yg)("inlineCode",{parentName:"li"},"min_dwell_time")," column is aggregated by MIN, so ",(0,l.yg)("inlineCode",{parentName:"li"},"2")," is saved as it is the minimum between ",(0,l.yg)("inlineCode",{parentName:"li"},"10")," and ",(0,l.yg)("inlineCode",{parentName:"li"},"2"),".")),(0,l.yg)("p",null,"After aggregation, Doris only stores the aggregated data. In other words, the detailed raw data will no longer be available."),(0,l.yg)("h3",{id:"import-data-and-aggregate-with-existing-data"},"Import data and aggregate with existing data."),(0,l.yg)("p",null,"Assuming that the table already contains the previously imported data:"),(0,l.yg)("table",null,(0,l.yg)("thead",{parentName:"table"},(0,l.yg)("tr",{parentName:"thead"},(0,l.yg)("th",{parentName:"tr",align:null},"user_id"),(0,l.yg)("th",{parentName:"tr",align:null},"date"),(0,l.yg)("th",{parentName:"tr",align:null},"city"),(0,l.yg)("th",{parentName:"tr",align:null},"age"),(0,l.yg)("th",{parentName:"tr",align:null},"sex"),(0,l.yg)("th",{parentName:"tr",align:null},"last","_","visit","_","date"),(0,l.yg)("th",{parentName:"tr",align:null},"cost"),(0,l.yg)("th",{parentName:"tr",align:null},"max","_","dwell","_","time"),(0,l.yg)("th",{parentName:"tr",align:null},"min","_","dwell","_","time"))),(0,l.yg)("tbody",{parentName:"table"},(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10000"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01"),(0,l.yg)("td",{parentName:"tr",align:null},"Beijing"),(0,l.yg)("td",{parentName:"tr",align:null},"20"),(0,l.yg)("td",{parentName:"tr",align:null},"0"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01 07:00"),(0,l.yg)("td",{parentName:"tr",align:null},"35"),(0,l.yg)("td",{parentName:"tr",align:null},"10"),(0,l.yg)("td",{parentName:"tr",align:null},"2")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10001"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01"),(0,l.yg)("td",{parentName:"tr",align:null},"Beijing"),(0,l.yg)("td",{parentName:"tr",align:null},"30"),(0,l.yg)("td",{parentName:"tr",align:null},"1"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01 17:05:45"),(0,l.yg)("td",{parentName:"tr",align:null},"2"),(0,l.yg)("td",{parentName:"tr",align:null},"22"),(0,l.yg)("td",{parentName:"tr",align:null},"22")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10002"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-02"),(0,l.yg)("td",{parentName:"tr",align:null},"Shanghai"),(0,l.yg)("td",{parentName:"tr",align:null},"20"),(0,l.yg)("td",{parentName:"tr",align:null},"1"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-02 12:59:12"),(0,l.yg)("td",{parentName:"tr",align:null},"200"),(0,l.yg)("td",{parentName:"tr",align:null},"5"),(0,l.yg)("td",{parentName:"tr",align:null},"5")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10003"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-02"),(0,l.yg)("td",{parentName:"tr",align:null},"Guangzhou"),(0,l.yg)("td",{parentName:"tr",align:null},"32"),(0,l.yg)("td",{parentName:"tr",align:null},"0"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-02 11:20:00"),(0,l.yg)("td",{parentName:"tr",align:null},"30"),(0,l.yg)("td",{parentName:"tr",align:null},"11"),(0,l.yg)("td",{parentName:"tr",align:null},"11")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10004"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01"),(0,l.yg)("td",{parentName:"tr",align:null},"Shenzhen"),(0,l.yg)("td",{parentName:"tr",align:null},"35"),(0,l.yg)("td",{parentName:"tr",align:null},"0"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01 10:00:15"),(0,l.yg)("td",{parentName:"tr",align:null},"100"),(0,l.yg)("td",{parentName:"tr",align:null},"3"),(0,l.yg)("td",{parentName:"tr",align:null},"3")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10004"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-03"),(0,l.yg)("td",{parentName:"tr",align:null},"Shenzhen"),(0,l.yg)("td",{parentName:"tr",align:null},"35"),(0,l.yg)("td",{parentName:"tr",align:null},"0"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-03 10:20:22"),(0,l.yg)("td",{parentName:"tr",align:null},"11"),(0,l.yg)("td",{parentName:"tr",align:null},"6"),(0,l.yg)("td",{parentName:"tr",align:null},"6")))),(0,l.yg)("p",null,"Now import a new batch of data:"),(0,l.yg)("table",null,(0,l.yg)("thead",{parentName:"table"},(0,l.yg)("tr",{parentName:"thead"},(0,l.yg)("th",{parentName:"tr",align:null},"user_id"),(0,l.yg)("th",{parentName:"tr",align:null},"date"),(0,l.yg)("th",{parentName:"tr",align:null},"city"),(0,l.yg)("th",{parentName:"tr",align:null},"age"),(0,l.yg)("th",{parentName:"tr",align:null},"sex"),(0,l.yg)("th",{parentName:"tr",align:null},"last","_","visit","_","date"),(0,l.yg)("th",{parentName:"tr",align:null},"cost"),(0,l.yg)("th",{parentName:"tr",align:null},"max","_","dwell","_","time"),(0,l.yg)("th",{parentName:"tr",align:null},"min","_","dwell","_","time"))),(0,l.yg)("tbody",{parentName:"table"},(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10004"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-03"),(0,l.yg)("td",{parentName:"tr",align:null},"Shenzhen"),(0,l.yg)("td",{parentName:"tr",align:null},"35"),(0,l.yg)("td",{parentName:"tr",align:null},"0"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-03 11:22:00"),(0,l.yg)("td",{parentName:"tr",align:null},"44"),(0,l.yg)("td",{parentName:"tr",align:null},"19"),(0,l.yg)("td",{parentName:"tr",align:null},"19")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10005"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-03"),(0,l.yg)("td",{parentName:"tr",align:null},"Changsha"),(0,l.yg)("td",{parentName:"tr",align:null},"29"),(0,l.yg)("td",{parentName:"tr",align:null},"1"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-03 18:11:02"),(0,l.yg)("td",{parentName:"tr",align:null},"3"),(0,l.yg)("td",{parentName:"tr",align:null},"1"),(0,l.yg)("td",{parentName:"tr",align:null},"1")))),(0,l.yg)("p",null,"With the following SQL:"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-sql"},'insert into example_db.example_tbl_agg1 values\n(10004,"2017-10-03","Shenzhen",35,0,"2017-10-03 11:22:00",44,19,19),\n(10005,"2017-10-03","Changsha",29,1,"2017-10-03 18:11:02",3,1,1);\n')),(0,l.yg)("p",null,"After importing, the data stored in Doris will be updated as follows:"),(0,l.yg)("table",null,(0,l.yg)("thead",{parentName:"table"},(0,l.yg)("tr",{parentName:"thead"},(0,l.yg)("th",{parentName:"tr",align:null},"user_id"),(0,l.yg)("th",{parentName:"tr",align:null},"date"),(0,l.yg)("th",{parentName:"tr",align:null},"city"),(0,l.yg)("th",{parentName:"tr",align:null},"age"),(0,l.yg)("th",{parentName:"tr",align:null},"sex"),(0,l.yg)("th",{parentName:"tr",align:null},"last","_","visit","_","date"),(0,l.yg)("th",{parentName:"tr",align:null},"cost"),(0,l.yg)("th",{parentName:"tr",align:null},"max","_","dwell","_","time"),(0,l.yg)("th",{parentName:"tr",align:null},"min","_","dwell","_","time"))),(0,l.yg)("tbody",{parentName:"table"},(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10000"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01"),(0,l.yg)("td",{parentName:"tr",align:null},"Beijing"),(0,l.yg)("td",{parentName:"tr",align:null},"20"),(0,l.yg)("td",{parentName:"tr",align:null},"0"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01 07:00"),(0,l.yg)("td",{parentName:"tr",align:null},"35"),(0,l.yg)("td",{parentName:"tr",align:null},"10"),(0,l.yg)("td",{parentName:"tr",align:null},"2")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10001"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01"),(0,l.yg)("td",{parentName:"tr",align:null},"Beijing"),(0,l.yg)("td",{parentName:"tr",align:null},"30"),(0,l.yg)("td",{parentName:"tr",align:null},"1"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01 17:05:45"),(0,l.yg)("td",{parentName:"tr",align:null},"2"),(0,l.yg)("td",{parentName:"tr",align:null},"22"),(0,l.yg)("td",{parentName:"tr",align:null},"22")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10002"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-02"),(0,l.yg)("td",{parentName:"tr",align:null},"Shanghai"),(0,l.yg)("td",{parentName:"tr",align:null},"20"),(0,l.yg)("td",{parentName:"tr",align:null},"1"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-02 12:59:12"),(0,l.yg)("td",{parentName:"tr",align:null},"200"),(0,l.yg)("td",{parentName:"tr",align:null},"5"),(0,l.yg)("td",{parentName:"tr",align:null},"5")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10003"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-02"),(0,l.yg)("td",{parentName:"tr",align:null},"Guangzhou"),(0,l.yg)("td",{parentName:"tr",align:null},"32"),(0,l.yg)("td",{parentName:"tr",align:null},"0"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-02 11:20:00"),(0,l.yg)("td",{parentName:"tr",align:null},"30"),(0,l.yg)("td",{parentName:"tr",align:null},"11"),(0,l.yg)("td",{parentName:"tr",align:null},"11")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10004"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01"),(0,l.yg)("td",{parentName:"tr",align:null},"Shenzhen"),(0,l.yg)("td",{parentName:"tr",align:null},"35"),(0,l.yg)("td",{parentName:"tr",align:null},"0"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-01 10:00:15"),(0,l.yg)("td",{parentName:"tr",align:null},"100"),(0,l.yg)("td",{parentName:"tr",align:null},"3"),(0,l.yg)("td",{parentName:"tr",align:null},"3")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10004"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-03"),(0,l.yg)("td",{parentName:"tr",align:null},"Shenzhen"),(0,l.yg)("td",{parentName:"tr",align:null},"35"),(0,l.yg)("td",{parentName:"tr",align:null},"0"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-03 11:22:00"),(0,l.yg)("td",{parentName:"tr",align:null},"55"),(0,l.yg)("td",{parentName:"tr",align:null},"19"),(0,l.yg)("td",{parentName:"tr",align:null},"6")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"10005"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-03"),(0,l.yg)("td",{parentName:"tr",align:null},"Changsha"),(0,l.yg)("td",{parentName:"tr",align:null},"29"),(0,l.yg)("td",{parentName:"tr",align:null},"1"),(0,l.yg)("td",{parentName:"tr",align:null},"2017-10-03 18:11:02"),(0,l.yg)("td",{parentName:"tr",align:null},"3"),(0,l.yg)("td",{parentName:"tr",align:null},"1"),(0,l.yg)("td",{parentName:"tr",align:null},"1")))),(0,l.yg)("p",null,"As you can see, the existing data and the newly imported data of User 10004 have been aggregated. Meanwhile, the new data of User 10005 have been added."),(0,l.yg)("p",null,"In Doris, data aggregation happens in the following 3 stages:"),(0,l.yg)("ol",null,(0,l.yg)("li",{parentName:"ol"},"The ETL stage of each batch of import data. At this stage, the batch of import data will be aggregated internally."),(0,l.yg)("li",{parentName:"ol"},"The data compaction stage of the underlying BE. At this stage, BE will aggregate data from different batches that have been imported."),(0,l.yg)("li",{parentName:"ol"},"The data query stage. The data involved in the query will be aggregated accordingly.")),(0,l.yg)("p",null,"At different stages, data will be aggregated to varying degrees. For example, when a batch of data is just imported, it may not be aggregated with the existing data. But for users, they ",(0,l.yg)("strong",{parentName:"p"},"can only query aggregated data"),". That is, what users see are the aggregated data, and they ",(0,l.yg)("strong",{parentName:"p"},"should not assume that what they have seen are not or partly aggregated"),". "),(0,l.yg)("h3",{id:"agg_state"},"agg_state"),(0,l.yg)("admonition",{type:"tip"},(0,l.yg)("p",{parentName:"admonition"},"AGG_STATE cannot be used as a key column, and when creating a table, you need to declare the signature of the aggregation function. Users do not need to specify a length or default value. The actual storage size of the data depends on the function implementation.")),(0,l.yg)("p",null,"CREATE TABLE"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-sql"},'set enable_agg_state=true;\ncreate table aggstate(\n    k1 int null,\n    k2 agg_state<sum(int)> generic,\n    k3 agg_state<group_concat(string)> generic\n)\naggregate key (k1)\ndistributed BY hash(k1) buckets 3\nproperties("replication_num" = "1");\n')),(0,l.yg)("p",null,(0,l.yg)("inlineCode",{parentName:"p"},"agg_state")," is used to declare the data type as ",(0,l.yg)("inlineCode",{parentName:"p"},"agg_state,")," and ",(0,l.yg)("inlineCode",{parentName:"p"},"sum/group_concat")," are the signatures of aggregation functions."),(0,l.yg)("p",null,"Please note that ",(0,l.yg)("inlineCode",{parentName:"p"},"agg_state")," is a data type, similar to ",(0,l.yg)("inlineCode",{parentName:"p"},"int"),", ",(0,l.yg)("inlineCode",{parentName:"p"},"array"),", or ",(0,l.yg)("inlineCode",{parentName:"p"},"string"),"."),(0,l.yg)("p",null,(0,l.yg)("inlineCode",{parentName:"p"},"agg_state")," can only be used in conjunction with the ",(0,l.yg)("a",{parentName:"p",href:"/docs/sql-manual/sql-functions/combinators/state"},"state"),"/",(0,l.yg)("a",{parentName:"p",href:"/docs/sql-manual/sql-functions/combinators/merge"},"merge"),"/",(0,l.yg)("a",{parentName:"p",href:"/docs/sql-manual/sql-functions/combinators/union"},"union")," function combinators."),(0,l.yg)("p",null,(0,l.yg)("inlineCode",{parentName:"p"},"agg_state")," represents an intermediate result of an aggregation function. For example, with the aggregation function ",(0,l.yg)("inlineCode",{parentName:"p"},"sum"),", ",(0,l.yg)("inlineCode",{parentName:"p"},"agg_state")," can represent the intermediate state of summing values like ",(0,l.yg)("inlineCode",{parentName:"p"},"sum(1, 2, 3, 4, 5)"),", rather than the final result."),(0,l.yg)("p",null,"The ",(0,l.yg)("inlineCode",{parentName:"p"},"agg_state")," type needs to be generated using the ",(0,l.yg)("inlineCode",{parentName:"p"},"state")," function. For the current table, it would be ",(0,l.yg)("inlineCode",{parentName:"p"},"sum_state")," and ",(0,l.yg)("inlineCode",{parentName:"p"},"group_concat_state"),' for the "sum" and ',(0,l.yg)("inlineCode",{parentName:"p"},"group_concat")," aggregation functions, respectively."),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-sql"},"insert into aggstate values(1,sum_state(1),group_concat_state('a'));\ninsert into aggstate values(1,sum_state(2),group_concat_state('b'));\ninsert into aggstate values(1,sum_state(3),group_concat_state('c'));\n")),(0,l.yg)("p",null,"At this point, the table contains only one row. Please note that the table below is for illustrative purposes and cannot be selected/displayed directly:"),(0,l.yg)("table",null,(0,l.yg)("thead",{parentName:"table"},(0,l.yg)("tr",{parentName:"thead"},(0,l.yg)("th",{parentName:"tr",align:null},"k1"),(0,l.yg)("th",{parentName:"tr",align:null},"k2"),(0,l.yg)("th",{parentName:"tr",align:null},"k3"))),(0,l.yg)("tbody",{parentName:"table"},(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"1"),(0,l.yg)("td",{parentName:"tr",align:null},"sum(1,2,3)"),(0,l.yg)("td",{parentName:"tr",align:null},"group_concat_state(a,b,c)")))),(0,l.yg)("p",null,"Insert another record."),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-sql"},"insert into aggstate values(2,sum_state(4),group_concat_state('d'));\n")),(0,l.yg)("p",null,"The table's structure at this moment is..."),(0,l.yg)("table",null,(0,l.yg)("thead",{parentName:"table"},(0,l.yg)("tr",{parentName:"thead"},(0,l.yg)("th",{parentName:"tr",align:null},"k1"),(0,l.yg)("th",{parentName:"tr",align:null},"k2"),(0,l.yg)("th",{parentName:"tr",align:null},"k3"))),(0,l.yg)("tbody",{parentName:"table"},(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"1"),(0,l.yg)("td",{parentName:"tr",align:null},"sum(1,2,3)"),(0,l.yg)("td",{parentName:"tr",align:null},"group_concat_state(a,b,c)")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"2"),(0,l.yg)("td",{parentName:"tr",align:null},"sum(4)"),(0,l.yg)("td",{parentName:"tr",align:null},"group_concat_state(d)")))),(0,l.yg)("p",null,"We can use the ",(0,l.yg)("inlineCode",{parentName:"p"},"merge")," operation to combine multiple states and return the final result calculated by the aggregation function."),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre"},"mysql> select sum_merge(k2) from aggstate;\n+---------------+\n| sum_merge(k2) |\n+---------------+\n|            10 |\n+---------------+\n")),(0,l.yg)("p",null,(0,l.yg)("inlineCode",{parentName:"p"},"sum_merge")," will first combine sum(1,2,3) and sum(4) into sum(1,2,3,4), and return the calculated result.\nBecause ",(0,l.yg)("inlineCode",{parentName:"p"},"group_concat")," has a specific order requirement, the result is not stable."),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre"},"mysql> select group_concat_merge(k3) from aggstate;\n+------------------------+\n| group_concat_merge(k3) |\n+------------------------+\n| c,b,a,d                |\n+------------------------+\n")),(0,l.yg)("p",null,"If you do not want the final aggregation result, you can use 'union' to combine multiple intermediate aggregation results and generate a new intermediate result."),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-sql"},"insert into aggstate select 3,sum_union(k2),group_concat_union(k3) from aggstate ;\n")),(0,l.yg)("p",null,"The table's structure at this moment is..."),(0,l.yg)("table",null,(0,l.yg)("thead",{parentName:"table"},(0,l.yg)("tr",{parentName:"thead"},(0,l.yg)("th",{parentName:"tr",align:null},"k1"),(0,l.yg)("th",{parentName:"tr",align:null},"k2"),(0,l.yg)("th",{parentName:"tr",align:null},"k3"))),(0,l.yg)("tbody",{parentName:"table"},(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"1"),(0,l.yg)("td",{parentName:"tr",align:null},"sum(1,2,3)"),(0,l.yg)("td",{parentName:"tr",align:null},"group_concat_state(a,b,c)")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"2"),(0,l.yg)("td",{parentName:"tr",align:null},"sum(4)"),(0,l.yg)("td",{parentName:"tr",align:null},"group_concat_state(d)")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"3"),(0,l.yg)("td",{parentName:"tr",align:null},"sum(1,2,3,4)"),(0,l.yg)("td",{parentName:"tr",align:null},"group_concat_state(a,b,c,d)")))),(0,l.yg)("p",null,"You can achieve this through a query."),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre"},"mysql> select sum_merge(k2) , group_concat_merge(k3)from aggstate;\n+---------------+------------------------+\n| sum_merge(k2) | group_concat_merge(k3) |\n+---------------+------------------------+\n|            20 | c,b,a,d,c,b,a,d        |\n+---------------+------------------------+\n\nmysql> select sum_merge(k2) , group_concat_merge(k3)from aggstate where k1 != 2;\n+---------------+------------------------+\n| sum_merge(k2) | group_concat_merge(k3) |\n+---------------+------------------------+\n|            16 | c,b,a,d,c,b,a          |\n+---------------+------------------------+\n")),(0,l.yg)("p",null,"Users can perform more detailed aggregation function operations using ",(0,l.yg)("inlineCode",{parentName:"p"},"agg_state"),"."),(0,l.yg)("admonition",{type:"tip"},(0,l.yg)("p",{parentName:"admonition"}," ",(0,l.yg)("inlineCode",{parentName:"p"},"agg_state")," comes with a certain performance overhead.")))}u.isMDXComponent=!0}}]);